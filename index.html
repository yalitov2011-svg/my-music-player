<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YouSync PRO DJ</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- אייקונים -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- פונט דיגיטלי -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0a0a0a;
            --deck-bg: #161616;
            --text-color: #e0e0e0;
            --accent-a: #00e5ff; /* ציאן ל-Deck A */
            --accent-b: #ff4081; /* ורוד ל-Deck B */
            --knob-color: #2a2a2a;
            --screen-bg: #050505;
        }

        * { box-sizing: border-box; user-select: none; }

        body { 
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- מסך כניסה (נשאר נקי) --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #000; z-index: 2000;
        }
        .login-card {
            background: #111; padding: 40px; border-radius: 10px; width: 300px; text-align: center; border: 1px solid #333;
        }
        input.auth-input {
            width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #444; 
            background: #222; color: white; text-align: center;
        }
        .btn-enter {
            background: #444; color: white; border: none; padding: 10px; width: 100%; cursor: pointer; font-weight: bold;
        }
        .btn-enter:hover { background: #666; }

        /* --- DJ Console Layout --- */
        #djInterface {
            display: flex; flex-direction: column; height: 100%; width: 100%;
        }

        /* החלק העליון: הציוד */
        .console-top {
            flex: 2; display: flex; background: #111; border-bottom: 2px solid #333;
            padding: 10px; gap: 5px; height: 60vh;
        }

        /* DECK (הנגנים בצדדים) */
        .deck {
            flex: 3; background: var(--deck-bg); border-radius: 4px; border: 1px solid #333;
            display: flex; flex-direction: column; padding: 10px; position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }
        .deck.deck-a { border-top: 2px solid var(--accent-a); }
        .deck.deck-b { border-top: 2px solid var(--accent-b); }

        /* מסך מידע בתוך הדק */
        .deck-display {
            background: var(--screen-bg); border: 1px solid #444; height: 80px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center; padding: 10px;
            font-family: 'Share Tech Mono', monospace; color: var(--accent-a); position: relative; overflow: hidden;
        }
        .deck-b .deck-display { color: var(--accent-b); }
        
        .track-info-display { font-size: 14px; white-space: nowrap; overflow: hidden; max-width: 70%; }
        .bpm-display { font-size: 24px; border: 1px solid #333; padding: 2px 5px; }

        /* גל גול (Waveform) */
        .waveform {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 30px;
            background: rgba(255,255,255,0.1); display: flex; align-items: flex-end; gap: 1px; opacity: 0.5;
        }
        .bar { width: 3px; background: currentColor; animation: wave 0.5s infinite alternate; }
        @keyframes wave { from { height: 20%; } to { height: 100%; } }

        /* הגלגל (Jog Wheel) */
        .jog-container {
            flex: 1; display: flex; justify-content: center; align-items: center; position: relative;
        }
        .jog-wheel {
            width: 220px; height: 220px; border-radius: 50%;
            background: radial-gradient(circle, #222 0%, #000 100%);
            border: 5px solid #333;
            box-shadow: 0 10px 20px rgba(0,0,0,0.8);
            display: flex; align-items: center; justify-content: center;
            position: relative; transition: transform 0.1s linear;
        }
        .jog-top {
            width: 180px; height: 180px; border-radius: 50%; background: #111;
            border: 2px solid #444; display: flex; align-items: center; justify-content: center;
        }
        .jog-art { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; border-radius: 50%; }
        
        /* אנימציית סיבוב */
        .rotating { animation: spin 2s linear infinite; }
        .deck-b .rotating { animation-direction: reverse; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* כפתורי שליטה (CUE/PLAY) */
        .transport-controls {
            display: flex; gap: 15px; margin-top: 10px;
        }
        .btn-transport {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            box-shadow: 0 4px 0 #000, 0 5px 10px rgba(0,0,0,0.5);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; color: black; transition: 0.1s;
        }
        .btn-transport:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-cue { background: #ff9100; border: 4px solid #b36b00; }
        .btn-play { background: #00e676; border: 4px solid #00a352; }
        .btn-play.playing { background: #00ff80; box-shadow: 0 0 20px #00ff80; }

        /* MIXER (אמצע) */
        .mixer {
            flex: 2; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;
            display: flex; flex-direction: column; padding: 10px; align-items: center; gap: 10px;
        }
        
        .eq-section { display: flex; gap: 15px; }
        .knob-wrapper { text-align: center; }
        .knob-label { font-size: 10px; color: #888; margin-bottom: 5px; }
        
        /* כפתור מסתובב (Knob) */
        .knob {
            width: 40px; height: 40px; border-radius: 50%; background: #333;
            border: 2px solid #555; position: relative; cursor: ns-resize;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .knob::after {
            content: ''; position: absolute; top: 2px; left: 50%; width: 2px; height: 15px;
            background: white; transform: translateX(-50%);
        }

        /* סליידרים (Faders) */
        .faders { display: flex; gap: 20px; height: 150px; align-items: flex-end; width: 100%; justify-content: center; }
        .fader-track {
            width: 10px; height: 100%; background: #000; border-radius: 5px; position: relative; border: 1px solid #333;
        }
        .fader-handle {
            width: 30px; height: 50px; background: linear-gradient(#444, #222);
            border: 1px solid #555; position: absolute; left: -10px; bottom: 0;
            border-radius: 2px; cursor: ns-resize; box-shadow: 0 2px 5px black;
        }
        .fader-handle::after {
            content: ''; width: 20px; height: 2px; background: white;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }

        /* Crossfader */
        .crossfader-area { width: 80%; height: 40px; background: #111; border: 1px solid #333; border-radius: 4px; margin-top: auto; position: relative; }
        .xfader-handle {
            width: 40px; height: 100%; background: #555; position: absolute; left: 50%; transform: translateX(-50%); cursor: ew-resize; border: 1px solid #888;
        }

        /* --- Library (למטה) --- */
        .library {
            flex: 1.5; background: #0a0a0a; border-top: 2px solid #333;
            display: flex; flex-direction: column; overflow: hidden;
        }
        
        .library-header {
            padding: 10px; background: #111; display: flex; gap: 10px; border-bottom: 1px solid #333;
        }
        .search-bar {
            flex: 1; background: #222; border: 1px solid #444; color: white; padding: 5px 10px;
            border-radius: 4px; outline: none;
        }
        .search-btn { background: #333; color: white; border: 1px solid #444; padding: 5px 15px; cursor: pointer; }

        .song-list {
            flex: 1; overflow-y: auto; padding: 10px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;
        }

        .song-card {
            background: #161616; padding: 5px; border-radius: 4px; cursor: grab;
            display: flex; gap: 10px; align-items: center; border: 1px solid #222;
        }
        .song-card:hover { background: #222; border-color: #444; }
        .song-thumb { width: 50px; height: 50px; object-fit: cover; }
        .song-details { font-size: 12px; overflow: hidden; }
        .song-title { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* גרירה */
        .deck.drag-over { border-color: white; background: #222; }

        /* נגן יוטיוב נסתר */
        .hidden-player { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }

        /* התאמה לנייד */
        @media (max-width: 768px) {
            .console-top { flex-direction: column; height: auto; }
            .mixer { display: none; } /* נסתיר מיקסר בנייד */
            .deck { height: 300px; }
            .jog-wheel { width: 150px; height: 150px; }
        }

    </style>
</head>
<body>

    <!-- כניסה -->
    <div id="loginScreen">
        <h1 style="color:white;">PRO <span style="color:#00e5ff">DJ</span> CONSOLE</h1>
        <div class="login-card">
            <input type="text" id="usernameInput" class="auth-input" placeholder="DJ NAME">
            <button class="btn-enter" onclick="createRoom()">START SESSION</button>
            <p style="color:#555; margin:5px;">OR</p>
            <input type="number" id="roomInput" class="auth-input" placeholder="ROOM CODE">
            <button class="btn-enter" onclick="joinRoom()">JOIN SESSION</button>
        </div>
    </div>

    <!-- ממשק ה-DJ -->
    <div id="djInterface" style="display:none;">
        
        <div class="console-top">
            
            <!-- DECK A -->
            <div class="deck deck-a" id="deckA" ondrop="drop(event, 'A')" ondragover="allowDrop(event)">
                <div class="deck-display">
                    <div class="track-info-display" id="titleA">NO TRACK LOADED</div>
                    <div class="bpm-display">128</div>
                    <div class="waveform" style="color:var(--accent-a)">
                        <div class="bar" style="height:40%"></div><div class="bar" style="height:70%"></div><div class="bar" style="height:30%"></div>
                        <!-- ...עוד ברים יווצרו ב-JS... -->
                    </div>
                </div>
                <div class="jog-container">
                    <div class="jog-wheel" id="jogA">
                        <div class="jog-top"><img id="artA" class="jog-art" src=""></div>
                    </div>
                </div>
                <div class="transport-controls">
                    <button class="btn-transport btn-cue" onclick="cue('A')">CUE</button>
                    <button class="btn-transport btn-play" id="playA" onclick="togglePlay('A')">▶</button>
                </div>
            </div>

            <!-- MIXER -->
            <div class="mixer">
                <div class="knob-wrapper"><div class="knob"></div><div class="knob-label">HIGH</div></div>
                <div class="knob-wrapper"><div class="knob"></div><div class="knob-label">MID</div></div>
                <div class="knob-wrapper"><div class="knob"></div><div class="knob-label">LOW</div></div>
                
                <div class="faders">
                    <div class="fader-track"><div class="fader-handle" style="bottom:80%"></div></div> <!-- Vol A -->
                    <div class="fader-track"><div class="fader-handle" style="bottom:0%"></div></div>  <!-- Vol B -->
                </div>

                <div class="crossfader-area">
                    <div class="xfader-handle"></div>
                </div>
            </div>

            <!-- DECK B -->
            <div class="deck deck-b" id="deckB" ondrop="drop(event, 'B')" ondragover="allowDrop(event)">
                <div class="deck-display">
                    <div class="track-info-display" id="titleB">NO TRACK LOADED</div>
                    <div class="bpm-display">124</div>
                    <div class="waveform" style="color:var(--accent-b)"></div>
                </div>
                <div class="jog-container">
                    <div class="jog-wheel" id="jogB">
                        <div class="jog-top"><img id="artB" class="jog-art" src=""></div>
                    </div>
                </div>
                <div class="transport-controls">
                    <button class="btn-transport btn-cue" onclick="cue('B')">CUE</button>
                    <button class="btn-transport btn-play" id="playB" onclick="togglePlay('B')">▶</button>
                </div>
            </div>

        </div>

        <!-- ספריית שירים -->
        <div class="library">
            <div class="library-header">
                <input type="text" id="searchInput" class="search-bar" placeholder="SEARCH YOUTUBE...">
                <button class="search-btn" onclick="searchVideos()">GO</button>
                <div style="margin-right:auto; color:#666;">ROOM: <span id="roomCode"></span></div>
            </div>
            <div id="songList" class="song-list"></div>
        </div>

        <!-- נגן אמיתי מוסתר -->
        <div class="hidden-player" id="player"></div>

    </div>

    <script>
        const RAPID_API_KEY = 'efb1ed4f48msh5dfd6650699ded0p1f5775jsn2c2c0eb8bbb3';
        const RAPID_API_HOST = 'youtube-mp36.p.rapidapi.com'; 
        const YOUTUBE_API_KEY = 'AIzaSyAuLutPPSJlZJKkfBrzRNURSibcqkeeA60';

        const firebaseConfig = {
            apiKey: "AIzaSyDKN3qgnvUP4SZX9aOAaThnDI4vUjjVw9A",
            authDomain: "musicsync-58d86.firebaseapp.com",
            projectId: "musicsync-58d86",
            databaseURL: "https://musicsync-58d86-default-rtdb.firebaseio.com"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e){}
        const db = firebase.database();

        let player;
        let currentRoom = null;
        let deckA_Data = null; // מידע על שיר בדק A
        let deckB_Data = null; // מידע על שיר בדק B
        let activeDeck = 'A';  // מי מנגן כרגע?

        // --- כניסה ---
        function createRoom() { enterRoom(Math.floor(1000 + Math.random() * 9000)); }
        function joinRoom() { 
            const code = document.getElementById('roomInput').value;
            if(code) enterRoom(code);
        }

        function enterRoom(code) {
            currentRoom = code;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('djInterface').style.display = 'flex';
            document.getElementById('roomCode').innerText = code;

            loadYoutubePlayer();
            loadHomePage();
            setupListeners();
            generateWaveforms(); // יצירת גלים
        }

        // --- גרירה ושחרור (Drag & Drop) ---
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function leaveDrop(ev) {
            ev.currentTarget.classList.remove('drag-over');
        }

        function drag(ev, id, title, thumb) {
            ev.dataTransfer.setData("id", id);
            ev.dataTransfer.setData("title", title);
            ev.dataTransfer.setData("thumb", thumb);
        }

        function drop(ev, deck) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            
            const id = ev.dataTransfer.getData("id");
            const title = ev.dataTransfer.getData("title");
            const thumb = ev.dataTransfer.getData("thumb");

            loadDeck(deck, id, title, thumb);
        }

        // טעינת דק
        function loadDeck(deck, id, title, thumb) {
            const data = { id, title, thumb };
            
            // עדכון ויזואלי מקומי
            document.getElementById(`title${deck}`).innerText = title;
            document.getElementById(`art${deck}`).src = thumb;
            
            // שמירה בזיכרון
            if (deck === 'A') deckA_Data = data;
            else deckB_Data = data;

            // עדכון פיירבייס (כדי שכולם יראו מה טעון)
            db.ref(`rooms/${currentRoom}/deck${deck}`).set(data);
        }

        // --- נגינה ---
        function togglePlay(deck) {
            if (deck !== activeDeck) {
                // החלפת דק פעיל
                activeDeck = deck;
                const data = (deck === 'A') ? deckA_Data : deckB_Data;
                if (!data) return alert("Load a track first!");
                
                // שליחה לנגן
                db.ref(`rooms/${currentRoom}/current_song`).set({
                    videoId: data.id, title: data.title, status: 1
                });
            } else {
                // Pause/Play רגיל
                // לוגיקת עצירה...
            }
        }

        function cue(deck) {
            // אפקט עצירה ואיפוס
            const jog = document.getElementById(`jog${deck}`);
            jog.classList.remove('rotating');
            // אם זה הדק הפעיל - עצור את הנגן הראשי
            if (deck === activeDeck && player) {
                player.seekTo(0);
                player.pauseVideo();
            }
        }

        // --- Firebase Listeners ---
        function setupListeners() {
            // האזנה לשינוי שיר (מנגן בפועל)
            db.ref(`rooms/${currentRoom}/current_song`).on('value', snap => {
                const data = snap.val();
                if (!data) return;

                // עדכון גלגלים
                const jogA = document.getElementById('jogA');
                const jogB = document.getElementById('jogB');
                const btnA = document.getElementById('playA');
                const btnB = document.getElementById('playB');

                // איפוס
                jogA.classList.remove('rotating'); jogB.classList.remove('rotating');
                btnA.classList.remove('playing'); btnB.classList.remove('playing');

                // הפעלת הדק הנכון
                if (deckA_Data && deckA_Data.id === data.videoId) {
                    if(data.status === 1) { jogA.classList.add('rotating'); btnA.classList.add('playing'); }
                } else if (deckB_Data && deckB_Data.id === data.videoId) {
                    if(data.status === 1) { jogB.classList.add('rotating'); btnB.classList.add('playing'); }
                }

                if (player && player.loadVideoById && player.getVideoData().video_id !== data.videoId) {
                    player.loadVideoById(data.videoId);
                }
            });

            // האזנה לטעינת דקים (אם מישהו אחר גרר שיר)
            db.ref(`rooms/${currentRoom}/deckA`).on('value', snap => {
                if(snap.val()) loadDeck('A', snap.val().id, snap.val().title, snap.val().thumb);
            });
            db.ref(`rooms/${currentRoom}/deckB`).on('value', snap => {
                if(snap.val()) loadDeck('B', snap.val().id, snap.val().title, snap.val().thumb);
            });
        }

        // --- חיפוש וספרייה ---
        async function loadHomePage() { searchAndRender("Techno Mix 2025"); }
        
        async function searchVideos() {
            const q = document.getElementById('searchInput').value;
            if(q) searchAndRender(q);
        }

        async function searchAndRender(q) {
            const list = document.getElementById('songList');
            list.innerHTML = "LOADING...";
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=20&q=${encodeURIComponent(q)}&key=${YOUTUBE_API_KEY}`;
            const res = await fetch(url);
            const data = await res.json();
            
            list.innerHTML = "";
            data.items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'song-card';
                div.draggable = true;
                // אירוע גרירה
                div.ondragstart = (e) => drag(e, item.id.videoId, item.snippet.title, item.snippet.thumbnails.default.url);
                // לחיצה רגילה (לטלפון) - טוענת ל-A אוטומטית
                div.onclick = () => loadDeck('A', item.id.videoId, item.snippet.title, item.snippet.thumbnails.default.url);
                
                div.innerHTML = `
                    <img src="${item.snippet.thumbnails.default.url}" class="song-thumb">
                    <div class="song-details">
                        <div class="song-title">${item.snippet.title}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // --- נגן יוטיוב (מוסתר) ---
        function loadYoutubePlayer() {
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100', width: '100', videoId: '', 
                playerVars: { 'autoplay': 1, 'controls': 0 },
            });
        }

        // יצירת גלים יפים ב-CSS
        function generateWaveforms() {
            const waves = document.querySelectorAll('.waveform');
            waves.forEach(w => {
                let html = '';
                for(let i=0; i<40; i++) {
                    const h = Math.floor(Math.random() * 80 + 20);
                    html += `<div class="bar" style="height:${h}%"></div>`;
                }
                w.innerHTML = html;
            });
        }

    </script>
</body>
</html>
