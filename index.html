<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸµ ×”× ×’×Ÿ ×”××©×•×ª×£ V10 - ××ª×•×§×Ÿ</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { 
            background-color: #121212; 
            color: white; 
            font-family: 'Segoe UI', sans-serif; 
            text-align: center; 
            margin: 0; padding: 20px;
        }

        /* --- ××¡×š ×›× ×™×¡×” --- */
        #loginScreen {
            margin-top: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .box {
            background: #1e1e1e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 90%; max-width: 400px;
        }

        #playerScreen { display: none; } 

        h1 { color: #1DB954; text-shadow: 0 0 10px rgba(29, 185, 84, 0.5); } /* ×™×¨×•×§ ×¡×¤×•×˜×™×¤×™×™ */
        
        input { 
            padding: 15px; 
            border-radius: 30px; 
            border: 1px solid #333; 
            background: #2a2a2a;
            color: white;
            width: 80%; 
            font-size: 16px;
            text-align: center;
            outline: none;
            margin-bottom: 10px;
        }
        
        input:focus { border-color: #1DB954; }

        button { 
            padding: 12px 30px; 
            background: #1DB954; 
            color: black; 
            border: none; 
            cursor: pointer; 
            border-radius: 30px; 
            font-weight: bold; 
            font-size: 16px;
            transition: 0.2s;
            width: 100%;
            margin-top: 10px;
        }
        button:hover { transform: scale(1.05); background: #1ed760; }
        
        .secondary-btn { background: #444; color: white; }
        .secondary-btn:hover { background: #666; }

        /* ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” */
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 10px 15px;
            font-size: 14px;
            width: auto;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .dl-btn { background: #FFD700; color: black; } 
        .queue-btn { background: #9c27b0; color: white; } /* ×¡×’×•×œ ×œ×ª×•×¨ */
        .play-now-btn { background: #1DB954; color: black; }

        .info-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; flex-wrap: wrap; position: relative; }
        .badge { background: #333; padding: 8px 20px; border-radius: 20px; font-family: monospace; font-size: 18px; border: 1px solid #555; display: flex; align-items: center; gap: 10px; user-select: none; }
        .room-code { color: #00ff00; border-color: #00ff00; }
        .user-count { color: #00ccff; border-color: #00ccff; cursor: pointer; }

        #usersListPopup { display: none; position: absolute; top: 50px; background: #222; border: 1px solid #00ccff; border-radius: 10px; padding: 10px; width: 220px; z-index: 100; box-shadow: 0 5px 20px rgba(0,0,0,0.8); left: 50%; transform: translateX(-50%); }
        .user-item { padding: 8px; border-bottom: 1px solid #444; text-align: right; }
        .user-item:last-child { border-bottom: none; }

        /* --- ×¢×™×¦×•×‘ ×”×¤×œ×™×™×œ×™×¡×˜ ×”××©×•×ª×£ --- */
        .queue-container {
            width: 90%;
            max-width: 600px;
            background: #181818;
            padding: 15px;
            border-radius: 15px;
            margin: 20px auto;
            text-align: right;
            border: 1px solid #9c27b0;
        }
        
        .queue-item {
            background: #252525;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: fadeIn 0.5s;
        }
        
        .queue-item img {
            width: 40px; height: 30px; border-radius: 4px; object-fit: cover; margin-left: 10px;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .player-box { width: 100%; max-width: 800px; aspect-ratio: 16/9; background: #000; margin: 20px auto; border-radius: 15px; overflow: hidden; border: 2px solid #333; }
        iframe { width: 100%; height: 100%; border: none; }

        #loadingOverlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #1DB954; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p id="loadingText" style="margin-top: 15px; font-size: 18px;">××¢×‘×“...</p>
    </div>

    <div id="loginScreen">
        <h1>ğŸ§ ×”× ×’×Ÿ ×”××©×•×ª×£</h1>
        <div class="box">
            <label>×©×œ×‘ 1: ×”×–×“×”×•×ª</label>
            <input type="text" id="usernameInput" placeholder="×”×©× ×©×œ×š (×—×•×‘×”)">
            <hr style="border-color: #333; margin: 20px 0;">
            <label>×©×œ×‘ 2: ×‘×—×¨ ×œ××Ÿ ×œ×”×™×›× ×¡</label>
            <button onclick="createRoom()">âœ¨ ×¦×•×¨ ×—×“×¨ ×—×“×©</button>
            <p style="margin: 10px 0; color: #777;">--- ××• ---</p>
            <input type="number" id="roomInput" placeholder="×§×•×“ ×—×“×¨ (×œ××©×œ 1234)">
            <button class="secondary-btn" onclick="joinRoom()">ğŸš€ ×›× ×¡ ×œ×—×“×¨ ×§×™×™×</button>
        </div>
    </div>

    <div id="playerScreen">
        <h1>ğŸµ ××—×•×‘×¨ ×œ×—×“×¨</h1>
        
        <div class="info-bar">
            <div class="badge room-code">×§×•×“ ×—×“×¨: <span id="displayRoomCode">---</span></div>
            <div class="badge user-count" onclick="toggleUsersList()">
                ğŸ‘¥ ××—×•×‘×¨×™×: <span id="connectedCount" style="margin: 0 5px;">1</span> â–¼
            </div>
            <div id="usersListPopup">
                <div id="usersListContent"></div>
            </div>
        </div>
        
        <h3 id="welcomeMsg" style="color: gray; margin-top:0;"></h3>

        <div>
            <input type="text" id="searchQuery" placeholder="×—×¤×© ×©×™×¨ ×œ×”×•×¡×¤×”..." style="width: 60%;">
            <div class="action-buttons" style="margin-top: 5px;">
                <button class="action-btn play-now-btn" onclick="searchAndPlayNow()">â–¶ × ×’×Ÿ ×¢×›×©×™×•</button>
                <button class="action-btn queue-btn" onclick="searchAndAddToQueue()">â• ×”×•×¡×£ ×œ×ª×•×¨</button>
            </div>
        </div>

        <div class="player-box">
            <div id="player"></div>
        </div>
        <p id="statusText" style="color: gray;">×××ª×™×Ÿ ×œ×©×™×¨...</p>

        <div class="action-buttons">
            <button class="action-btn dl-btn" onclick="downloadCurrentOnly()">ğŸ’ ×”×•×¨×“ ×©×™×¨ ×–×” (PRO)</button>
        </div>

        <div class="queue-container">
            <h4 style="border-bottom: 1px solid #9c27b0; padding-bottom: 5px; color: #9c27b0; margin-top:0;">
                ğŸ“œ ×¨×©×™××ª ×”×©××¢×” ××©×•×ª×¤×ª (×”×‘× ×‘×ª×•×¨)
            </h4>
            <div id="sharedQueueList">
                <p style="color: gray; font-size: 14px;">×”×ª×•×¨ ×¨×™×§ ×›×¨×’×¢...</p>
            </div>
        </div>

    </div>

    <script>
        // ×”××¤×ª×— ×©×œ×š ×œ-RapidAPI
        const RAPID_API_KEY = 'efb1ed4f48msh5dfd6650699ded0p1f5775jsn2c2c0eb8bbb3';
        const RAPID_API_HOST = 'youtube-mp36.p.rapidapi.com'; 

        const firebaseConfig = {
            apiKey: "AIzaSyDKN3qgnvUP4SZX9aOAaThnDI4vUjjVw9A",
            authDomain: "musicsync-58d86.firebaseapp.com",
            projectId: "musicsync-58d86",
            storageBucket: "musicsync-58d86.firebasestorage.app",
            messagingSenderId: "367949692420",
            appId: "1:367949692420:web:414a34b0c14dc46e51ff51",
            databaseURL: "https://musicsync-58d86-default-rtdb.firebaseio.com"
        };

        // ×‘×“×™×§×” ×©×”×¤×™×™×¨×‘×™×™×¡ × ×˜×¢×Ÿ ×œ×¤× ×™ ×©××©×ª××©×™× ×‘×•
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        const db = firebase.database();
        const YOUTUBE_API_KEY = 'AIzaSyAuLutPPSJlZJKkfBrzRNURSibcqkeeA60'; 

        let player;
        let isSyncing = false; 
        let currentRoom = null;
        let myName = "";
        let currentSongId = "";    

        // --- ×›× ×™×¡×” ---
        function getLoginDetails() {
            const nameInput = document.getElementById('usernameInput');
            if (!nameInput) return false;
            
            const name = nameInput.value.trim();
            if (name === "") { alert("×—×™×™×‘ ×œ×¨×©×•× ×©×!"); return false; }
            myName = name;
            return true;
        }

        function createRoom() {
            if (!getLoginDetails()) return; 
            // ×™×¦×™×¨×ª ×—×“×¨ ×—×“×©
            enterRoom(Math.floor(1000 + Math.random() * 9000));
        }

        function joinRoom() {
            if (!getLoginDetails()) return; 
            const code = document.getElementById('roomInput').value;
            if (code.length < 4) { alert("×§×•×“ ×©×’×•×™"); return; }
            enterRoom(code);
        }

        function enterRoom(code) {
            currentRoom = code;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('playerScreen').style.display = 'block';
            document.getElementById('displayRoomCode').innerText = code;
            document.getElementById('welcomeMsg').innerText = `×©×œ×•×, ${myName}`;
            
            loadYoutubePlayer();
            
            // ×—×™×‘×•×¨ ×œ××©×ª××©×™×
            const userRef = db.ref(`rooms/${code}/users`).push();
            userRef.set({ name: myName });
            userRef.onDisconnect().remove(); 
            
            db.ref(`rooms/${code}/users`).on('value', (snapshot) => {
                const usersListDiv = document.getElementById('usersListContent');
                usersListDiv.innerHTML = ""; 
                let count = 0;
                if(snapshot.exists()){
                    snapshot.forEach((child) => {
                        const user = child.val();
                        count++;
                        usersListDiv.innerHTML += `<div class="user-item"><div>ğŸ‘¤ ${user.name}</div></div>`;
                    });
                }
                document.getElementById('connectedCount').innerText = count;
            });

            // ×”××–× ×” ×œ×ª×•×¨ ×”×©×™×¨×™× (Shared Queue)
            db.ref(`rooms/${code}/queue`).on('value', (snapshot) => {
                renderQueue(snapshot.val());
            });
        }

        function toggleUsersList() {
            const popup = document.getElementById('usersListPopup');
            popup.style.display = (popup.style.display === "block") ? "none" : "block";
        }

        function loadYoutubePlayer() {
            if (typeof YT !== 'undefined' && YT.Player) onYouTubeIframeAPIReady();
            else {
                var tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', 
                width: '100%', 
                videoId: '', 
                host: 'https://www.youtube-nocookie.com', 
                playerVars: { 
                    'autoplay': 1, 
                    'controls': 1, 
                    'rel': 0, 
                    'modestbranding': 1, 
                    'iv_load_policy': 3,
                    'playsinline': 1 
                },
                events: { 'onReady': connectToRoomData, 'onStateChange': onPlayerStateChange }
            });
        }

        function connectToRoomData() {
            db.ref(`rooms/${currentRoom}/current_song`).on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                document.getElementById('statusText').innerText = `ğŸµ ×× ×’×Ÿ: ${data.title}`;
                currentSongId = data.videoId;
                if (player.getVideoData().video_id !== data.videoId) {
                    isSyncing = true;
                    player.loadVideoById(data.videoId);
                    player.seekTo(0);
                    setTimeout(() => isSyncing = false, 1500);
                }
                const state = player.getPlayerState();
                if (data.status === 2 && state !== 2) player.pauseVideo();
                else if (data.status === 1 && state !== 1 && state !== 3) player.playVideo();
            });
        }

        function onPlayerStateChange(event) {
            if (isSyncing || !currentRoom) return; 

            // ×¢×“×›×•×Ÿ ××¦×‘ × ×’×Ÿ (Play/Pause)
            if (event.data === 1 || event.data === 2) {
                db.ref(`rooms/${currentRoom}/current_song`).update({ status: event.data });
            }

            // --- ×”×§×¡×: × ×™×’×•×Ÿ ××•×˜×•××˜×™ ××”×ª×•×¨ ×›×©×”×©×™×¨ × ×’××¨ ---
            if (event.data === 0) { // 0 = ENDED
                playNextInQueue();
            }
        }

        // --- ×—×™×¤×•×© ×©×™×¨×™× (××©×•×ª×£ ×œ×©×ª×™ ×”×¤×¢×•×œ×•×ª) ---
        async function fetchVideoData(query) {
            if (!query) return null;
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=1&q=${encodeURIComponent(query + " lyrics")}&videoEmbeddable=true&key=${YOUTUBE_API_KEY}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (!data.items || data.items.length === 0) { alert("×œ× × ××¦×"); return null; }
                return data.items[0];
            } catch (error) { alert("×©×’×™××” ×‘×—×™×¤×•×©"); return null; }
        }

        // × ×’×Ÿ ×¢×›×©×™×• (×“×•×¨×¡ ××ª ×”×©×™×¨ ×”× ×•×›×—×™)
        async function searchAndPlayNow() {
            const query = document.getElementById('searchQuery').value;
            const video = await fetchVideoData(query);
            if (video) {
                db.ref(`rooms/${currentRoom}/current_song`).set({
                    videoId: video.id.videoId, title: video.snippet.title, status: 1
                });
                document.getElementById('searchQuery').value = "";
            }
        }

        // ×”×•×¡×£ ×œ×ª×•×¨ (××•×¡×™×£ ×œ×¨×©×™××” ×”××©×•×ª×¤×ª)
        async function searchAndAddToQueue() {
            const query = document.getElementById('searchQuery').value;
            const video = await fetchVideoData(query);
            if (video) {
                const songData = {
                    videoId: video.id.videoId,
                    title: video.snippet.title,
                    thumbnail: video.snippet.thumbnails.default.url,
                    addedBy: myName
                };
                // ×“×—×™×¤×” ×œ×ª×•×¨ ×‘-Firebase - ×ª×™×§×•×Ÿ ××©×ª× ×” code ×œ-currentRoom
                db.ref(`rooms/${currentRoom}/queue`).push(songData);
                
                // ×× ×™××¦×™×” ×§×˜× ×”
                const btn = document.querySelector('.queue-btn');
                const originalText = btn.innerText;
                btn.innerText = "× ×•×¡×£ ×‘×”×¦×œ×—×”! âœ…";
                setTimeout(() => btn.innerText = originalText, 2000);
                document.getElementById('searchQuery').value = "";
            }
        }

        // --- × ×™×”×•×œ ×”×ª×•×¨ ---
        function renderQueue(queueData) {
            const listDiv = document.getElementById('sharedQueueList');
            listDiv.innerHTML = "";
            
            if (!queueData) {
                listDiv.innerHTML = "<p style='color: gray; font-size: 14px;'>×”×ª×•×¨ ×¨×™×§ ×›×¨×’×¢...</p>";
                return;
            }

            // ×”××¨×ª ×”××•×‘×™×™×§×˜ ×©×œ ×¤×™×™×¨×‘×™×™×¡ ×œ××¢×¨×š
            const songs = Object.entries(queueData);
            
            songs.forEach(([key, song], index) => {
                listDiv.innerHTML += `
                    <div class="queue-item">
                        <div style="display:flex; align-items:center;">
                            <span style="font-weight:bold; color:#9c27b0; margin-left:10px;">${index + 1}.</span>
                            <div style="text-align:right;">
                                <div style="font-size:14px; font-weight:bold;">${song.title.substring(0, 40)}...</div>
                                <div style="font-size:11px; color:#aaa;">× ×•×¡×£ ×¢"×™: ${song.addedBy}</div>
                            </div>
                        </div>
                        <img src="${song.thumbnail}">
                    </div>
                `;
            });
        }

        function playNextInQueue() {
            // ×§×¨×™××ª ×”×ª×•×¨ ×¤×¢× ××—×ª
            db.ref(`rooms/${currentRoom}/queue`).once('value', (snapshot) => {
                const queueData = snapshot.val();
                if (!queueData) return; // ×”×ª×•×¨ ×¨×™×§

                // ×œ×•×§×— ××ª ×”×©×™×¨ ×”×¨××©×•×Ÿ
                const keys = Object.keys(queueData);
                const firstKey = keys[0];
                const nextSong = queueData[firstKey];

                // 1. ×× ×’×Ÿ ××•×ª×• ×œ×›×•×œ×
                db.ref(`rooms/${currentRoom}/current_song`).set({
                    videoId: nextSong.videoId,
                    title: nextSong.title,
                    status: 1
                });

                // 2. ××•×—×§ ××•×ª×• ××”×ª×•×¨ ×›×“×™ ×©×œ× ×™×—×–×•×¨
                db.ref(`rooms/${currentRoom}/queue/${firstKey}`).remove();
            });
        }

        // --- ×”×•×¨×“×” ---
        async function downloadCurrentOnly() {
            if (!currentSongId) return alert("××™×Ÿ ×©×™×¨ ×œ× ×’×Ÿ!");
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').innerText = "××›×™×Ÿ ×”×•×¨×“×”...";
            
            const url = `https://${RAPID_API_HOST}/dl?id=${currentSongId}`;
            const options = { method: 'GET', headers: { 'X-RapidAPI-Key': RAPID_API_KEY, 'X-RapidAPI-Host': RAPID_API_HOST } };

            try {
                const response = await fetch(url, options);
                const result = await response.json();
                
                let downloadLink = result.link || result.url;
                if (downloadLink) window.location.href = downloadLink;
                else alert("×©×™×¨×•×ª ×”×”×•×¨×“×•×ª ×œ× ×”×¦×œ×™×— ×”×¤×¢×.");
            } catch (error) { console.error(error); alert("×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×œ×©×™×¨×•×ª ×”×”×•×¨×“×•×ª"); }
            finally { document.getElementById('loadingOverlay').style.display = 'none'; }
        }

    </script>
</body>
</html>
