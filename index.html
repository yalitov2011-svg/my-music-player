<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Clone Party</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- ×¢×™×¦×•×‘ ×¡×¤×•×˜×™×¤×™×™ ×××™×ª×™ --- */
        body { 
            background-color: #121212; /* ×”×¨×§×¢ ×”×›×”×” ×©×œ ×¡×¤×•×˜×™×¤×™×™ */
            color: #b3b3b3; 
            font-family: 'Circular', 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            text-align: center; 
            margin: 0; padding: 20px;
        }

        h1, h2, h3, h4 { color: white; }
        
        /* ×›×¤×ª×•×¨×™× ×™×¨×•×§×™× ×¢×’×•×œ×™× */
        button { 
            padding: 14px 32px; 
            background: #1DB954; 
            color: black; 
            border: none; 
            cursor: pointer; 
            border-radius: 500px; /* ×¢×™×’×•×œ ××œ× */
            font-weight: 700; 
            font-size: 14px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: 0.2s;
            width: 100%;
            margin-top: 10px;
        }
        button:hover { transform: scale(1.04); background: #1ed760; color: white; }
        
        /* ×ª×™×‘×•×ª ×˜×§×¡×˜ ×›×”×•×ª */
        input { 
            padding: 14px; 
            border-radius: 4px; 
            border: none; 
            background: #333;
            color: white;
            width: 80%; 
            font-size: 16px;
            text-align: center;
            outline: none;
            margin-bottom: 10px;
        }
        input:focus { outline: 2px solid white; background: #2a2a2a; }

        /* ×§×•×¤×¡××•×ª ×›×¨×˜×™×¡ */
        .box {
            background: #181818;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 60px rgba(0,0,0,0.5);
            width: 90%; max-width: 400px;
            margin: 20px auto;
        }

        /* × ×’×Ÿ ×•×™×“××• ××•×¡×ª×¨ ×œ××—×¦×” */
        .player-wrapper {
            position: relative;
            width: 100%; max-width: 600px;
            margin: 20px auto;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            aspect-ratio: 16/9;
        }
        iframe { width: 100%; height: 100%; border: none; }

        /* --- ×¨×©×™××ª ×©×™×¨×™× (×ª×•×¨) ×‘×¢×™×¦×•×‘ ×¡×¤×•×˜×™×¤×™×™ --- */
        .queue-container {
            width: 90%; max-width: 600px;
            margin: 30px auto;
            text-align: right;
        }
        
        .queue-header {
            color: white; font-size: 24px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;
        }

        .queue-item {
            display: flex; align-items: center; justify-content: space-between;
            background: transparent;
            padding: 10px; border-radius: 5px;
            transition: 0.2s;
        }
        .queue-item:hover { background: rgba(255,255,255,0.1); }
        
        .song-info { display: flex; align-items: center; gap: 15px; }
        .song-num { color: #1DB954; font-size: 16px; width: 20px; }
        .song-thumb { width: 40px; height: 40px; object-fit: cover; }
        .song-title { color: white; font-size: 16px; font-weight: 500; }
        .song-user { font-size: 12px; color: #b3b3b3; }

        /* ×‘×¨ ×¢×œ×™×•×Ÿ */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            max-width: 800px; margin: 0 auto 30px auto;
            background: #000; padding: 10px 20px; border-radius: 30px;
        }
        .logo { color: white; font-weight: bold; font-size: 20px; display: flex; align-items: center; gap: 10px; }
        
        /* ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” */
        .action-row { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .btn-small { width: auto; padding: 10px 20px; font-size: 12px; background: transparent; border: 1px solid #555; color: white; }
        .btn-small:hover { border-color: white; background: rgba(255,255,255,0.1); }

    </style>
</head>
<body>

    <div id="loginScreen">
        <div style="font-size: 50px; margin-bottom: 20px;">ğŸ§</div>
        <h1 style="font-size: 32px; margin-bottom: 40px;">Music Party</h1>
        
        <div class="box">
            <h3 style="margin-top:0;">×”×ª×—×‘×¨×•×ª</h3>
            <input type="text" id="usernameInput" placeholder="×©× ××©×ª××©">
            <div style="height: 20px;"></div>
            <button onclick="createRoom()">×¦×•×¨ ×—×“×¨ ×—×“×©</button>
            <div style="margin: 15px 0; font-size: 12px;">××•</div>
            <input type="number" id="roomInput" placeholder="×§×•×“ ×—×“×¨ ×œ×”×¦×˜×¨×¤×•×ª">
            <button style="background: white; color: black;" onclick="joinRoom()">×”×¦×˜×¨×£ ×œ×—×“×¨</button>
        </div>
    </div>

    <div id="playerScreen" style="display:none;">
        
        <div class="top-bar">
            <div class="logo">
                <span style="font-size: 24px;">ğŸŸ¢</span> Party Room
            </div>
            <div style="color: white; font-weight: bold;">Room: <span id="displayRoomCode" style="color:#1DB954;">---</span></div>
        </div>

        <h2 id="welcomeMsg" style="color: white; margin-bottom: 30px;"></h2>

        <div style="max-width: 600px; margin: 0 auto;">
            <input type="text" id="searchQuery" placeholder="××” ×‘× ×œ×š ×œ×©××•×¢?" style="width: 100%; background: #282828; text-align: right; padding-right: 20px;">
            <div class="action-row">
                <button onclick="searchAndPlayNow()" style="width: auto;">× ×’×Ÿ ×¢×›×©×™×•</button>
                <button onclick="searchAndAddToQueue()" style="background: transparent; border: 1px solid #777; color: white; width: auto;">×”×•×¡×£ ×œ×ª×•×¨</button>
            </div>
        </div>

        <div class="player-wrapper">
            <div id="player"></div>
        </div>
        <div id="statusText" style="color: #1DB954; font-weight: bold; margin-top: 10px;">×××ª×™×Ÿ ×œ×©×™×¨...</div>

        <div class="action-row" style="margin-top: 20px;">
            <button class="btn-small" onclick="downloadCurrentOnly()">â¬‡ ×”×•×¨×“ ×©×™×¨ (MP3)</button>
        </div>

        <div class="queue-container">
            <div class="queue-header">×”×‘××™× ×‘×ª×•×¨</div>
            <div id="sharedQueueList">
                <p style="color: #555; text-align: center; margin-top: 20px;">××™×Ÿ ×©×™×¨×™× ×‘×ª×•×¨ ×›×¨×’×¢...</p>
            </div>
        </div>

    </div>

    <script>
        const RAPID_API_KEY = 'efb1ed4f48msh5dfd6650699ded0p1f5775jsn2c2c0eb8bbb3';
        const RAPID_API_HOST = 'youtube-mp36.p.rapidapi.com'; 

        const firebaseConfig = {
            apiKey: "AIzaSyDKN3qgnvUP4SZX9aOAaThnDI4vUjjVw9A",
            authDomain: "musicsync-58d86.firebaseapp.com",
            projectId: "musicsync-58d86",
            databaseURL: "https://musicsync-58d86-default-rtdb.firebaseio.com"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e){}
        const db = firebase.database();
        const YOUTUBE_API_KEY = 'AIzaSyAuLutPPSJlZJKkfBrzRNURSibcqkeeA60'; 

        let player, isSyncing = false, currentRoom = null, myName = "";

        // ×›× ×™×¡×”
        function createRoom() {
            myName = document.getElementById('usernameInput').value || "Dj Guest";
            enterRoom(Math.floor(1000 + Math.random() * 9000));
        }
        function joinRoom() {
            myName = document.getElementById('usernameInput').value || "Dj Guest";
            const code = document.getElementById('roomInput').value;
            if(code) enterRoom(code);
        }

        function enterRoom(code) {
            currentRoom = code;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('playerScreen').style.display = 'block';
            document.getElementById('displayRoomCode').innerText = code;
            document.getElementById('welcomeMsg').innerText = `××—×•×‘×¨ ×›: ${myName}`;
            
            loadYoutubePlayer();
            
            // ×”××–× ×” ×œ×©×™×¨ × ×•×›×—×™
            db.ref(`rooms/${currentRoom}/current_song`).on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                document.getElementById('statusText').innerText = `ğŸµ ×× ×’×Ÿ ×›×¢×ª: ${data.title}`;
                if (player && player.loadVideoById && player.getVideoData().video_id !== data.videoId) {
                    isSyncing = true;
                    player.loadVideoById(data.videoId);
                    setTimeout(() => isSyncing = false, 1500);
                }
            });

            // ×”××–× ×” ×œ×ª×•×¨
            db.ref(`rooms/${code}/queue`).on('value', (snapshot) => {
                renderQueue(snapshot.val());
            });
        }

        // × ×’×Ÿ ×™×•×˜×™×•×‘
        function loadYoutubePlayer() {
            if (typeof YT !== 'undefined' && YT.Player) onYouTubeIframeAPIReady();
            else {
                var tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '', 
                playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0, 'modestbranding': 1, 'iv_load_policy': 3 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(event) {
            if (event.data === 0) playNextInQueue(); // ×©×™×¨ × ×’××¨ -> ×”×‘× ×‘×ª×•×¨
        }

        // ×—×™×¤×•×©
        async function fetchVideo(query) {
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=1&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}`;
            const res = await fetch(url);
            const data = await res.json();
            return data.items && data.items.length > 0 ? data.items[0] : null;
        }

        async function searchAndPlayNow() {
            const q = document.getElementById('searchQuery').value;
            const video = await fetchVideo(q);
            if(video) {
                db.ref(`rooms/${currentRoom}/current_song`).set({
                    videoId: video.id.videoId, title: video.snippet.title, status: 1
                });
                document.getElementById('searchQuery').value = "";
            }
        }

        async function searchAndAddToQueue() {
            const q = document.getElementById('searchQuery').value;
            const video = await fetchVideo(q);
            if(video) {
                db.ref(`rooms/${currentRoom}/queue`).push({
                    videoId: video.id.videoId,
                    title: video.snippet.title,
                    thumbnail: video.snippet.thumbnails.default.url,
                    addedBy: myName
                });
                document.getElementById('searchQuery').value = "";
            }
        }

        // ×ª×•×¨
        function renderQueue(queueData) {
            const listDiv = document.getElementById('sharedQueueList');
            listDiv.innerHTML = "";
            if (!queueData) {
                listDiv.innerHTML = "<p style='color: #555; text-align: center;'>××™×Ÿ ×©×™×¨×™× ×‘×ª×•×¨...</p>";
                return;
            }
            Object.values(queueData).forEach((song, i) => {
                listDiv.innerHTML += `
                    <div class="queue-item">
                        <div class="song-info">
                            <span class="song-num">${i+1}</span>
                            <img src="${song.thumbnail}" class="song-thumb">
                            <div>
                                <div class="song-title">${song.title.substring(0,35)}...</div>
                                <div class="song-user">× ×•×¡×£ ×¢"×™ ${song.addedBy}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function playNextInQueue() {
            db.ref(`rooms/${currentRoom}/queue`).once('value', snapshot => {
                const data = snapshot.val();
                if(!data) return;
                const firstKey = Object.keys(data)[0];
                const nextSong = data[firstKey];
                
                db.ref(`rooms/${currentRoom}/current_song`).set({ videoId: nextSong.videoId, title: nextSong.title });
                db.ref(`rooms/${currentRoom}/queue/${firstKey}`).remove();
            });
        }

        // ×”×•×¨×“×”
        async function downloadCurrentOnly() {
            // ×œ×•×’×™×§×ª ×”×•×¨×“×” ×§×™×™××ª (RapidAPI)
            if(!player || !player.getVideoData) return;
            const id = player.getVideoData().video_id;
            if(!id) return alert("××™×Ÿ ×©×™×¨ ×× ×’×Ÿ");
            
            const url = `https://${RAPID_API_HOST}/dl?id=${id}`;
            const options = { method: 'GET', headers: { 'X-RapidAPI-Key': RAPID_API_KEY, 'X-RapidAPI-Host': RAPID_API_HOST } };
            try {
                const res = await fetch(url, options);
                const data = await res.json();
                if(data.link) window.location.href = data.link;
                else alert("×œ× ×”×¦×œ×™×— ×œ×”×•×¨×™×“");
            } catch(e) { alert("×©×’×™××” ×‘×”×•×¨×“×”"); }
        }
    </script>
</body>
</html>
