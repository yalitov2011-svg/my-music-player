<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YouSync V36 - Playlists</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- ××™×™×§×•× ×™× -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- ×¤×•× ×˜ ×“×™×’×™×˜×œ×™ -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #1DB954;
            --dark: #000000;
            --panel: #121212;
            --border: #282828;
            --text: #ffffff;
            --accent-a: #00e5ff; 
            --accent-b: #ff4081;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            background-color: var(--dark);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- ×›× ×™×¡×” --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1e1e1e, #000);
            z-index: 3000;
        }
        .login-card {
            background: rgba(30,30,30,0.9); padding: 40px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center;
            border: 1px solid var(--border);
        }
        input.auth-input {
            width: 100%; padding: 15px; margin: 10px 0; border-radius: 30px; border: 1px solid #333; 
            background: #222; color: white; outline: none; text-align: center; font-size: 16px;
        }
        .btn-grad {
            background: var(--primary); border: none; color: black; font-weight: bold; padding: 15px; width: 100%; border-radius: 30px;
            cursor: pointer; font-size: 16px; margin-top: 10px; transition: 0.2s;
        }
        .btn-grad:hover { transform: scale(1.05); }

        /* --- ××¦×‘ ×¨×’×™×œ (Standard) --- */
        #standardUI {
            display: grid;
            grid-template-columns: 250px 1fr 320px; 
            grid-template-rows: 1fr 90px;
            height: 100%;
            width: 100%;
            overflow: hidden; 
        }

        .sidebar {
            background: var(--dark); border-left: 1px solid var(--border);
            padding: 20px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto;
        }
        .nav-btn {
            background: transparent; border: none; color: #b3b3b3; text-align: right; font-size: 14px;
            padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-radius: 4px;
            font-weight: 600; transition: 0.2s;
        }
        .nav-btn:hover { color: white; background: #282828; }
        .nav-btn.active { color: white; background: #282828; }
        .nav-btn.dj-mode-btn { background: linear-gradient(45deg, #00e5ff, #2979ff); border: none; color: black; margin-bottom: 20px; }

        /* ××–×•×¨ ×”×¤×œ×™×™×œ×™×¡×˜×™× ×‘×¦×“ */
        .library-section {
            margin-top: 20px; padding-top: 20px; border-top: 1px solid #282828;
        }
        .lib-header {
            display: flex; justify-content: space-between; align-items: center; color: #aaa; font-size: 12px; margin-bottom: 10px; letter-spacing: 1px; font-weight: bold;
        }
        .playlist-item {
            padding: 8px; color: #ddd; cursor: pointer; font-size: 14px; border-radius: 4px; display: flex; align-items: center; gap: 10px;
        }
        .playlist-item:hover { background: #1a1a1a; color: white; }
        .playlist-item.active { background: #282828; color: var(--primary); }

        .main-content {
            background: var(--panel); position: relative; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }
        
        .search-container { width: 100%; max-width: 600px; margin-bottom: 20px; flex-shrink: 0; }
        .search-input {
            width: 100%; padding: 12px 40px 12px 15px; background: #2a2a2a; border: none; border-radius: 30px; color: white; outline: none;
        }
        
        .video-wrapper {
            width: 100%; max-width: 800px; aspect-ratio: 16/9; background: black; border-radius: 12px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; flex-shrink: 0;
        }
        iframe { width: 100%; height: 100%; border: none; }
        
        .results-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;
            width: 100%; max-width: 900px; padding-bottom: 50px;
        }
        .video-card-container { position: relative; }
        .video-card { cursor: pointer; transition: 0.2s; background: #181818; padding: 10px; border-radius: 8px; }
        .video-card:hover { background: #282828; transform: translateY(-3px); }
        .card-img { width: 100%; border-radius: 6px; aspect-ratio: 16/9; object-fit: cover; }
        .card-title { font-size: 13px; margin-top: 8px; font-weight: 600; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” ×¢×œ ×©×™×¨ */
        .card-actions {
            position: absolute; bottom: 15px; left: 15px; display: flex; gap: 5px; opacity: 0; transition: 0.2s;
        }
        .video-card-container:hover .card-actions { opacity: 1; }
        .action-btn {
            background: var(--primary); color: black; border: none; border-radius: 50%; width: 30px; height: 30px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .action-btn:hover { transform: scale(1.1); }
        
        .chat-panel { background: var(--dark); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { background: #2a2a2a; padding: 8px 12px; border-radius: 10px; font-size: 13px; max-width: 85%; align-self: flex-start; }
        .chat-input-area { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 5px; flex-shrink: 0; }
        
        .bottom-bar {
            grid-column: 1 / -1; background: #181818; border-top: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000;
        }
        .now-playing { display: flex; align-items: center; gap: 10px; width: 25%; overflow: hidden; }
        .controls { display: flex; gap: 20px; align-items: center; }
        .ctrl-btn.play { color: white; font-size: 35px; background: none; border: none; cursor: pointer; }

        /* ×—×œ×•×Ÿ ×”×•×¡×¤×” ×œ×¤×œ×™×™×œ×™×¡×˜ */
        #playlistModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 4000; align-items: center; justify-content: center;
        }
        .modal-box {
            background: #222; padding: 20px; border-radius: 10px; width: 300px;
            border: 1px solid #444; max-height: 60vh; overflow-y: auto;
        }
        .playlist-select-item {
            padding: 10px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center; gap: 10px;
        }
        .playlist-select-item:hover { background: #333; }

        /* --- ××¦×‘ DJ --- */
        #djInterface {
            display: none; flex-direction: column; height: 100%; width: 100%; background: #080808; overflow: hidden;
        }
        .dj-top-bar { padding: 10px 20px; background: #000; border-bottom: 2px solid #333; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .record-btn { background: #333; color: #ff4444; border: 1px solid #555; padding: 5px 15px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: bold; border-radius: 4px; }
        .console-container { flex: 2; display: flex; padding: 10px; gap: 10px; overflow-y: auto; min-height: 400px; }
        .deck { flex: 1; min-width: 250px; background: #121212; border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column; padding: 12px; position: relative; box-shadow: inset 0 0 30px rgba(0,0,0,0.9); }
        .deck.deck-a { border-top: 3px solid var(--accent-a); } .deck.deck-b { border-top: 3px solid var(--accent-b); }
        .deck-screen { background: #000; border: 1px solid #444; height: 80px; margin: 10px 0; display: flex; flex-direction: column; padding: 8px; font-family: 'Share Tech Mono', monospace; color: var(--accent-a); justify-content: center; }
        .deck-b .deck-screen { color: var(--accent-b); }
        .time-display { font-size: 28px; color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.5); }
        .jog-container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 10px; }
        .jog-wheel { width: 100%; max-width: 200px; aspect-ratio: 1/1; border-radius: 50%; background: radial-gradient(circle, #1a1a1a 0%, #000 90%, #222 100%); border: 2px solid #444; box-shadow: 0 10px 25px rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; transition: transform 0.1s linear; position: relative; }
        .jog-wheel.rotating { animation: spin 2s linear infinite; border-color: white; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .jog-art { width: 60%; height: 60%; border-radius: 50%; object-fit: cover; opacity: 0.8; border: 1px solid #333; }
        .transport-controls { display: flex; gap: 20px; margin-top: auto; justify-content: center; padding-top: 10px; }
        .dj-btn { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; box-shadow: 0 3px 0 #000, 0 5px 10px rgba(0,0,0,0.5); font-weight: bold; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .btn-play { background: #00e676; border: 2px solid #00a352; }
        .mixer { width: 120px; background: #161616; border: 1px solid #333; border-radius: 4px; display: flex; flex-direction: column; align-items: center; padding: 15px 0; flex-shrink: 0; }
        .faders-container { display: flex; gap: 15px; height: 150px; align-items: center; margin-top: auto; }
        .vol-fader-wrapper { position: relative; width: 30px; height: 100%; display: flex; justify-content: center; }
        input[type=range].vertical-fader { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 8px; height: 100%; cursor: pointer; background: #000; border-radius: 5px; }
        .crossfader-wrapper { width: 80%; height: 40px; margin-top: 10px; margin-bottom: 10px; display: flex; align-items: center; }
        input[type=range].crossfader { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
        input[type=range].crossfader::-webkit-slider-runnable-track { width: 100%; height: 6px; background: #000; border: 1px solid #333; border-radius: 3px; }
        input[type=range].crossfader::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 40px; background: #555; border: 1px solid #888; margin-top: -8px; border-radius: 2px; }
        .dj-library { height: 35vh; background: #0a0a0a; border-top: 2px solid #333; display: flex; flex-direction: column; flex-shrink: 0; }
        .dj-search { padding: 10px; background: #111; display: flex; gap: 10px; border-bottom: 1px solid #333; }
        .hidden-player { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }

        @media (max-width: 768px) {
            #standardUI { display: flex; flex-direction: column; }
            .sidebar, .chat-panel { display: none; }
            .console-container { flex-direction: column; height: auto; }
            .mixer { display: none; }
            .deck { height: 320px; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

    <div id="loginScreen">
        <h1 style="color:white;">YouSync <span style="color:var(--primary)">DJ</span></h1>
        <div class="login-card">
            <input type="text" id="usernameInput" class="auth-input" placeholder="×©× ××©×ª××©">
            <button class="btn-grad" onclick="createRoom()">×¦×•×¨ ×—×“×¨</button>
            <input type="number" id="roomInput" class="auth-input" placeholder="×§×•×“ ×—×“×¨">
            <button class="btn-grad" style="background:#333;" onclick="joinRoom()">×”×¦×˜×¨×£</button>
        </div>
    </div>

    <!-- ×××©×§ ×¨×’×™×œ -->
    <div id="standardUI" style="display:none;">
        <div class="sidebar">
            <div class="brand">You<span>Sync</span></div>
            <button class="nav-btn active" onclick="loadHomePage()"><i class="fas fa-home"></i> ×‘×™×ª</button>
            <button class="nav-btn" onclick="loadFavorites()"><i class="fas fa-heart"></i> ××•×¢×“×¤×™×</button>
            <button class="nav-btn dj-mode-btn" onclick="switchMode('dj')"><i class="fas fa-compact-disc"></i> ××¦×‘ DJ</button>
            
            <div class="library-section">
                <div class="lib-header">
                    <span>×¡×¤×¨×™×™×”</span>
                    <i class="fas fa-plus" style="cursor:pointer;" onclick="createPlaylist()" title="×¦×•×¨ ×¤×œ×™×™×œ×™×¡×˜"></i>
                </div>
                <div id="playlistsContainer">
                    <!-- ×¤×œ×™×™×œ×™×¡×˜×™× ×™×•×¤×™×¢×• ×›××Ÿ -->
                </div>
            </div>

            <div style="color:#aaa; font-size:12px; margin-top:auto;">×—×“×¨: <span id="stdRoomCode"></span></div>
        </div>

        <div class="main-content">
            <div class="search-container"><input type="text" id="searchInput" class="search-input" placeholder="×—×¤×© ×©×™×¨..."></div>
            <div class="video-wrapper"><div id="mainPlayer"></div></div>
            <h3 id="contentTitle">ğŸ”¥ ×œ×”×™×˜×™×</h3>
            <div id="resultsGrid" class="results-grid"></div>
        </div>

        <div class="chat-panel">
            <div style="padding:10px; color:#aaa;">ğŸ’¬ ×¦'××˜</div>
            <div id="chatMessages" class="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="×”×•×“×¢×”..." style="flex:1; background:#333; border:none; color:white; padding:5px;">
                <button onclick="sendMessage()" style="background:var(--primary); border:none; border-radius:50%; width:30px;">â¤</button>
            </div>
        </div>

        <div class="bottom-bar">
            <div class="now-playing">
                <img id="npThumb" src="https://via.placeholder.com/50" style="width:40px; border-radius:4px;">
                <div><div id="npTitle" style="font-size:13px; font-weight:bold;">Waiting...</div></div>
            </div>
            <button class="ctrl-btn play" onclick="togglePlayMain()"><i class="fas fa-play" id="playIcon"></i></button>
            <div></div>
        </div>
    </div>

    <!-- ×××©×§ DJ -->
    <div id="djInterface">
        <div class="dj-top-bar">
            <div style="font-family:'Share Tech Mono'; font-size:20px;">PRO <span style="color:#00e5ff">DJ</span> CONSOLE</div>
            <div style="display:flex; gap:10px;">
                <button class="record-btn" id="recBtn" onclick="toggleRecording()">â— REC</button>
                <button onclick="switchMode('standard')" style="background:#333; color:white; border:1px solid #555; cursor:pointer;">EXIT</button>
            </div>
        </div>

        <div class="console-container">
            <div class="deck deck-a" id="deckA" ondrop="drop(event, 'A')" ondragover="allowDrop(event)">
                <div style="color:#555; font-size:10px; font-weight:bold;">DECK A</div>
                <div class="deck-screen">
                    <div style="font-size:12px; color:#888;">PLAYER 1</div>
                    <div class="time-display" id="timeA">00:00</div>
                    <div id="titleA" style="font-size:12px; white-space:nowrap; overflow:hidden;">NO TRACK</div>
                </div>
                <div class="jog-container"><div class="jog-wheel" id="jogA"><img id="artA" class="jog-art" src=""></div></div>
                <div class="transport-controls"><button class="dj-btn btn-play" id="btnPlayA" onclick="togglePlayDeck('A')">â–¶</button></div>
                <div class="hidden-player"><div id="playerA"></div></div>
            </div>

            <div class="mixer">
                <div style="color:#555; font-size:10px; margin-bottom:10px;">MASTER</div>
                <div class="faders-container">
                    <div class="vol-fader-wrapper"><input type="range" class="vertical-fader" min="0" max="100" value="100" oninput="setDeckVolume('A', this.value)"></div>
                    <div class="vol-fader-wrapper"><input type="range" class="vertical-fader" min="0" max="100" value="100" oninput="setDeckVolume('B', this.value)"></div>
                </div>
                <div style="flex:1;"></div>
                <div style="width:100%; padding:0 10px;">
                    <div style="text-align:center; font-size:10px; color:#555;">CROSSFADER</div>
                    <div class="crossfader-wrapper"><input type="range" class="crossfader" min="0" max="100" value="50" oninput="setCrossfader(this.value)"></div>
                </div>
            </div>

            <div class="deck deck-b" id="deckB" ondrop="drop(event, 'B')" ondragover="allowDrop(event)">
                <div style="color:#555; font-size:10px; font-weight:bold;">DECK B</div>
                <div class="deck-screen">
                    <div style="font-size:12px; color:#888;">PLAYER 2</div>
                    <div class="time-display" id="timeB">00:00</div>
                    <div id="titleB" style="font-size:12px; white-space:nowrap; overflow:hidden;">NO TRACK</div>
                </div>
                <div class="jog-container"><div class="jog-wheel" id="jogB"><img id="artB" class="jog-art" src=""></div></div>
                <div class="transport-controls"><button class="dj-btn btn-play" id="btnPlayB" onclick="togglePlayDeck('B')">â–¶</button></div>
                <div class="hidden-player"><div id="playerB"></div></div>
            </div>
        </div>

        <div class="dj-library">
            <div class="dj-search">
                <input type="text" id="djSearchInput" placeholder="SEARCH..." style="flex:1; background:#222; border:1px solid #444; color:white; padding:5px;">
                <button onclick="searchVideosDJ()" style="background:#333; color:white; cursor:pointer;">GO</button>
            </div>
            <div id="djSongList" class="results-grid" style="padding:10px;"></div>
        </div>
    </div>

    <!-- ××•×“×œ ×‘×—×™×¨×ª ×¤×œ×™×™×œ×™×¡×˜ ×œ×”×•×¡×¤×” -->
    <div id="playlistModal" onclick="if(event.target===this) this.style.display='none'">
        <div class="modal-box">
            <h3 style="color:white; margin-top:0;">×‘×—×¨ ×¤×œ×™×™×œ×™×¡×˜</h3>
            <div id="playlistSelectContainer"></div>
            <button onclick="document.getElementById('playlistModal').style.display='none'" style="width:100%; padding:10px; margin-top:10px; background:#333; border:none; color:white;">×‘×™×˜×•×œ</button>
        </div>
    </div>

    <script>
        const RAPID_API_KEY = 'efb1ed4f48msh5dfd6650699ded0p1f5775jsn2c2c0eb8bbb3';
        const RAPID_API_HOST = 'youtube-mp36.p.rapidapi.com'; 
        const YOUTUBE_API_KEY = 'AIzaSyAuLutPPSJlZJKkfBrzRNURSibcqkeeA60';

        const firebaseConfig = {
            apiKey: "AIzaSyDKN3qgnvUP4SZX9aOAaThnDI4vUjjVw9A",
            authDomain: "musicsync-58d86.firebaseapp.com",
            projectId: "musicsync-58d86",
            databaseURL: "https://musicsync-58d86-default-rtdb.firebaseio.com"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e){}
        const db = firebase.database();

        let mainPlayer, playerA, playerB;
        let isSyncing = false, currentRoom = null, myName = "";
        let deckA_Data = null, deckB_Data = null;
        let volA = 100, volB = 100, xFader = 50;
        let mediaRecorder, audioChunks = [], isRecording = false;
        let songToAdd = null; // ×©×™×¨ ×–×× ×™ ×œ×”×•×¡×¤×”

        function switchMode(mode) {
            if (mode === 'dj') {
                document.getElementById('standardUI').style.display = 'none';
                document.getElementById('djInterface').style.display = 'flex';
                searchAndRender("Hits 2025", 'djSongList', true);
                if(mainPlayer && typeof mainPlayer.pauseVideo === 'function') mainPlayer.pauseVideo();
            } else {
                document.getElementById('djInterface').style.display = 'none';
                document.getElementById('standardUI').style.display = (window.innerWidth > 768) ? 'grid' : 'flex';
                if(playerA && typeof playerA.pauseVideo === 'function') playerA.pauseVideo();
                if(playerB && typeof playerB.pauseVideo === 'function') playerB.pauseVideo();
            }
        }

        // --- × ×™×”×•×œ ×¤×œ×™×™×œ×™×¡×˜×™× (×—×“×©!) ---
        function createPlaylist() {
            const name = prompt("×©× ×”×¤×œ×™×™×œ×™×¡×˜:");
            if(name) {
                db.ref(`rooms/${currentRoom}/playlists`).push({ name: name, songs: {} });
            }
        }

        function loadPlaylists() {
            db.ref(`rooms/${currentRoom}/playlists`).on('value', snap => {
                const container = document.getElementById('playlistsContainer');
                const selectContainer = document.getElementById('playlistSelectContainer');
                container.innerHTML = "";
                selectContainer.innerHTML = "";
                
                if(!snap.exists()) return;

                snap.forEach(child => {
                    const pl = child.val();
                    const key = child.key;
                    
                    // ×ª×¤×¨×™×˜ ×¦×“
                    const div = document.createElement('div');
                    div.className = 'playlist-item';
                    div.innerHTML = `<i class="fas fa-music"></i> ${pl.name}`;
                    div.onclick = () => showPlaylist(key, pl.name);
                    container.appendChild(div);

                    // ×ª×¤×¨×™×˜ ×‘×—×™×¨×” (××•×“×œ)
                    const sel = document.createElement('div');
                    sel.className = 'playlist-select-item';
                    sel.innerHTML = `<i class="fas fa-folder"></i> ${pl.name}`;
                    sel.onclick = () => confirmAddToPlaylist(key);
                    selectContainer.appendChild(sel);
                });
            });
        }

        function openAddToPlaylist(videoData) {
            songToAdd = videoData;
            document.getElementById('playlistModal').style.display = 'flex';
        }

        function confirmAddToPlaylist(plKey) {
            if(songToAdd) {
                db.ref(`rooms/${currentRoom}/playlists/${plKey}/songs`).push(songToAdd);
                document.getElementById('playlistModal').style.display = 'none';
                alert("×”×©×™×¨ × ×•×¡×£ ×œ×¤×œ×™×™×œ×™×¡×˜!");
            }
        }

        function showPlaylist(plKey, plName) {
            document.getElementById('contentTitle').innerText = `ğŸ“‚ ${plName}`;
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '<p>×˜×•×¢×Ÿ...</p>';
            
            db.ref(`rooms/${currentRoom}/playlists/${plKey}/songs`).once('value', snap => {
                grid.innerHTML = "";
                if(!snap.exists()) { grid.innerHTML = "<p>×”×¤×œ×™×™×œ×™×¡×˜ ×¨×™×§</p>"; return; }
                
                snap.forEach(child => {
                    const song = child.val();
                    renderSongCard(song, grid, false);
                });
            });
        }

        function renderSongCard(item, container, isDraggable) {
            const cardCont = document.createElement('div');
            cardCont.className = 'video-card-container';
            
            const div = document.createElement('div');
            div.className = 'video-card';
            
            if(isDraggable) {
                div.draggable = true;
                div.ondragstart = (e) => drag(e, item.id.videoId, item.snippet.title, item.snippet.thumbnails.default.url);
                div.onclick = () => { if(confirm("Load to Deck A?")) loadDeck('A', item.id.videoId, item.snippet.title, item.snippet.thumbnails.default.url); }
            } else {
                div.onclick = () => db.ref(`rooms/${currentRoom}/current_song`).set({ videoId: item.id.videoId, title: item.snippet.title, thumbnail: item.snippet.thumbnails.medium.url, status: 1 });
            }
            div.innerHTML = `<img src="${item.snippet.thumbnails.medium.url}" class="card-img"><div class="card-title">${item.snippet.title}</div>`;
            
            // ×›×¤×ª×•×¨ ×”×•×¨×“×”
            const dlBtn = document.createElement('button');
            dlBtn.className = 'download-btn';
            dlBtn.innerHTML = '<i class="fas fa-download"></i>';
            dlBtn.style.right = '10px';
            dlBtn.onclick = (e) => { e.stopPropagation(); downloadSong(item.id.videoId); };

            // ×›×¤×ª×•×¨ ×”×•×¡×¤×” ×œ×¤×œ×™×™×œ×™×¡×˜
            const addBtn = document.createElement('button');
            addBtn.className = 'action-btn';
            addBtn.innerHTML = '<i class="fas fa-plus"></i>';
            addBtn.style.position = 'absolute'; addBtn.style.top = '10px'; addBtn.style.left = '10px';
            addBtn.onclick = (e) => { e.stopPropagation(); openAddToPlaylist(item); };

            cardCont.appendChild(div);
            if(!isDraggable) { // ×‘××¦×‘ DJ ×œ× ××¦×™×’×™× ×›×¤×ª×•×¨×™× ×¢×œ ×”×§×œ×£ ×›×“×™ ×œ× ×œ×”×¤×¨×™×¢
                div.appendChild(dlBtn);
                div.appendChild(addBtn);
            }
            container.appendChild(cardCont);
        }

        // --- ×©××¨ ×”×§×•×“ (×›× ×™×¡×”, × ×’× ×™× ×•×›×•') ---
        function setDeckVolume(deck, val) {
            if (deck === 'A') volA = parseInt(val); else volB = parseInt(val);
            updateVolumes();
        }
        function setCrossfader(val) { xFader = parseInt(val); updateVolumes(); }
        function updateVolumes() {
            if (!playerA || !playerB) return;
            let xFactorA = (xFader > 50) ? (100 - xFader) * 2 : 100; 
            let finalVolA = (volA * xFactorA) / 100;
            let xFactorB = (xFader < 50) ? xFader * 2 : 100;
            let finalVolB = (volB * xFactorB) / 100;
            if(typeof playerA.setVolume === 'function') playerA.setVolume(finalVolA);
            if(typeof playerB.setVolume === 'function') playerB.setVolume(finalVolB);
        }

        function createRoom() { myName = document.getElementById('usernameInput').value || "Admin"; enterRoom(Math.floor(1000 + Math.random() * 9000)); }
        function joinRoom() { const code = document.getElementById('roomInput').value; if(code) enterRoom(code); }

        function enterRoom(code) {
            currentRoom = code;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('standardUI').style.display = (window.innerWidth > 768) ? 'grid' : 'flex';
            document.getElementById('stdRoomCode').innerText = code;
            loadYoutubeAPI();
            loadHomePage(); 
            loadPlaylists(); // ×˜×¢×™× ×ª ×¤×œ×™×™×œ×™×¡×˜×™×
            const userRef = db.ref(`rooms/${code}/users`).push();
            userRef.set({ name: myName });
            userRef.onDisconnect().remove();
            setupListeners();
        }

        function setupListeners() {
            db.ref(`rooms/${currentRoom}/current_song`).on('value', snap => {
                const data = snap.val();
                if (!data) return;
                document.getElementById('npTitle').innerText = data.title;
                document.getElementById('npThumb').src = data.thumbnail || "https://via.placeholder.com/50";
                if (mainPlayer && mainPlayer.loadVideoById && mainPlayer.getVideoData().video_id !== data.videoId) {
                    isSyncing = true; mainPlayer.loadVideoById(data.videoId); setTimeout(() => isSyncing = false, 1500);
                }
                if (data.status === 1) {
                    document.getElementById('playIcon').className = "fas fa-pause";
                    if (mainPlayer && mainPlayer.playVideo) mainPlayer.playVideo();
                } else {
                    document.getElementById('playIcon').className = "fas fa-play";
                    if (mainPlayer && mainPlayer.pauseVideo) mainPlayer.pauseVideo();
                }
            });
            db.ref(`rooms/${currentRoom}/chat`).limitToLast(20).on('child_added', snap => {
                const msg = snap.val();
                const div = document.getElementById('chatMessages');
                div.innerHTML += `<div class="msg"><strong>${msg.user}</strong>${msg.text}</div>`;
                div.scrollTop = div.scrollHeight;
            });
        }

        function loadYoutubeAPI() {
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }
        function onYouTubeIframeAPIReady() {
            mainPlayer = new YT.Player('mainPlayer', {
                height: '100%', width: '100%', videoId: '', 
                playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0, 'playsinline': 1 },
                events: { 'onStateChange': onMainPlayerStateChange }
            });
            playerA = new YT.Player('playerA', { height: '100', width: '100', videoId: '', playerVars: { 'autoplay': 0, 'controls': 0, 'playsinline': 1 }, events: { 'onStateChange': (e) => onDeckStateChange('A', e) } });
            playerB = new YT.Player('playerB', { height: '100', width: '100', videoId: '', playerVars: { 'autoplay': 0, 'controls': 0, 'playsinline': 1 }, events: { 'onStateChange': (e) => onDeckStateChange('B', e) } });
        }

        function onMainPlayerStateChange(event) {
            if (isSyncing || !currentRoom) return;
            if (event.data === 1 || event.data === 2) {
                db.ref(`rooms/${currentRoom}/current_song`).update({ status: event.data });
            }
        }
        
        function onDeckStateChange(deck, event) {
            const btn = document.getElementById(`btnPlay${deck}`);
            const jog = document.getElementById(`jog${deck}`);
            if (event.data === 1) { 
                btn.classList.add('active'); btn.innerHTML = '<i class="fas fa-pause"></i>';
                jog.classList.add('rotating');
            } else {
                btn.classList.remove('active'); btn.innerHTML = 'â–¶';
                jog.classList.remove('rotating');
            }
        }

        function allowDrop(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
        function drag(ev, id, title, thumb) {
            ev.dataTransfer.setData("id", id); ev.dataTransfer.setData("title", title); ev.dataTransfer.setData("thumb", thumb);
        }
        function drop(ev, deck) {
            ev.preventDefault(); ev.currentTarget.classList.remove('drag-over');
            loadDeck(deck, ev.dataTransfer.getData("id"), ev.dataTransfer.getData("title"), ev.dataTransfer.getData("thumb"));
        }

        function loadDeck(deck, id, title, thumb) {
            const data = { id, title, thumb };
            document.getElementById(`title${deck}`).innerText = title;
            document.getElementById(`art${deck}`).src = thumb;
            if(deck === 'A') { deckA_Data = data; playerA.loadVideoById(id); playerA.pauseVideo(); }
            else { deckB_Data = data; playerB.loadVideoById(id); playerB.pauseVideo(); }
        }

        function togglePlayDeck(deck) {
            const p = (deck === 'A') ? playerA : playerB;
            if(!p) return;
            if(p.getPlayerState() === 1) p.pauseVideo(); else p.playVideo();
        }

        function togglePlayMain() {
            if(!mainPlayer) return;
            const newStatus = (mainPlayer.getPlayerState() === 1) ? 2 : 1;
            db.ref(`rooms/${currentRoom}/current_song`).update({ status: newStatus });
        }

        async function downloadSong(id) {
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            const url = `https://${RAPID_API_HOST}/dl?id=${id}`;
            const options = { method: 'GET', headers: { 'X-RapidAPI-Key': RAPID_API_KEY, 'X-RapidAPI-Host': RAPID_API_HOST } };
            try {
                const res = await fetch(url, options); const data = await res.json();
                if(data.link) window.open(data.link, '_blank'); else throw new Error();
            } catch(e) { window.open(`https://tomp3.cc/youtube-downloader/${id}`, '_blank'); }
            finally { btn.innerHTML = originalHtml; }
        }

        async function toggleRecording() {
            const btn = document.getElementById('recBtn');
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({ video: false, audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = saveRecording;
                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording'); btn.innerText = 'â— STOP';
                } catch(e) { alert("Recording not supported or denied."); }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove('recording'); btn.innerText = 'â— REC';
            }
        }

        function saveRecording() {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `DJ_Mix_${new Date().getTime()}.webm`;
            a.click(); URL.revokeObjectURL(url);
        }

        async function loadHomePage() {
            document.getElementById('contentTitle').innerText = "ğŸ”¥ ×œ×”×™×˜×™×";
            searchAndRender("Hits 2025", 'resultsGrid', false); 
        }
        document.getElementById('searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchAndRender(e.target.value, 'resultsGrid', false); });
        function searchVideosDJ() { searchAndRender(document.getElementById('djSearchInput').value, 'djSongList', true); }

        async function searchAndRender(query, elementId, isDraggable) {
            const grid = document.getElementById(elementId);
            grid.innerHTML = '<p>×˜×•×¢×Ÿ...</p>';
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=20&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}`;
            try {
                const res = await fetch(url); const data = await res.json(); grid.innerHTML = "";
                data.items.forEach(item => {
                    renderSongCard(item, grid, isDraggable);
                });
            } catch(e) {}
        }
        function sendMessage() { const input = document.getElementById('chatInput'); if(input.value) { db.ref(`rooms/${currentRoom}/chat`).push({ user: myName, text: input.value }); input.value = ""; }}
    </script>
</body>
</html>
