<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YouSync V29 - DJ Controller</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- ××™×™×§×•× ×™× -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- ×¤×•× ×˜ ×“×™×’×™×˜×œ×™ ×œ-BPM -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #1DB954;
            --dark: #000000;
            --panel: #121212;
            --border: #282828;
            --text: #ffffff;
            --dj-gray: #1a1a1a;
            --dj-accent: #00e5ff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            background-color: var(--dark);
            color: var(--text);
            font-family: 'Segoe UI', system-ui, sans-serif; 
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- ××¦×‘ DJ (×¢×™×¦×•×‘ ×”×§×•× ×˜×¨×•×œ×¨) --- */
        body.dj-mode {
            --primary: #00e5ff;
        }
        
        /* ×”×¡×ª×¨×ª ××œ×× ×˜×™× ×¨×’×™×œ×™× ×‘××¦×‘ DJ */
        body.dj-mode .standard-player-ui { display: none !important; }
        body.dj-mode .video-wrapper { 
            position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; /* ×”×•×™×“××• ××•×¡×ª×¨ ××‘×œ ×× ×’×Ÿ ×‘×¨×§×¢ */
        }
        body.dj-mode #djInterface { display: flex; }
        body.dj-mode .main-content { padding-top: 0; }

        /* ×××©×§ ×”-DJ */
        #djInterface {
            display: none; /* ××•×¡×ª×¨ ×›×‘×¨×™×¨×ª ××—×“×œ */
            flex-direction: column;
            width: 100%;
            height: 55vh; /* ×ª×•×¤×¡ ××ª ×”×—×¦×™ ×”×¢×œ×™×•×Ÿ */
            background: #111;
            border-bottom: 2px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            z-index: 100;
            padding: 10px;
        }

        .decks-container {
            display: flex;
            justify-content: space-between;
            height: 100%;
            gap: 10px;
        }

        .deck {
            flex: 1;
            background: #222;
            border-radius: 10px;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            position: relative;
            overflow: hidden;
        }

        /* ×”×’×œ×’×œ ×”××¡×ª×•×‘×‘ (Jog Wheel) */
        .jog-wheel {
            width: 180px; height: 180px;
            border-radius: 50%;
            background: radial-gradient(#333, #000);
            border: 4px solid #444;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            margin: 10px 0;
            position: relative;
            transition: transform 0.1s;
        }
        .jog-wheel.spinning { animation: spin 2s linear infinite; border-color: var(--primary); box-shadow: 0 0 20px var(--primary); }
        .deck-art { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; opacity: 0.7; }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ××¡×š ××™×“×¢ ×“×™×’×™×˜×œ×™ */
        .deck-screen {
            width: 100%; background: #000; color: var(--primary);
            font-family: 'Orbitron', monospace; padding: 5px;
            border-radius: 4px; border: 1px solid #333;
            font-size: 12px; text-align: center; margin-bottom: 5px;
            white-space: nowrap; overflow: hidden;
        }

        /* ×›×¤×ª×•×¨×™ ×©×œ×™×˜×” ×‘-Deck */
        .deck-controls {
            display: flex; gap: 10px; width: 100%; justify-content: center; margin-top: auto;
        }
        .dj-btn {
            width: 50px; height: 50px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5); transition: 0.1s; display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .dj-btn:active { transform: scale(0.95); box-shadow: inset 0 0 5px rgba(0,0,0,0.8); }
        
        .btn-cue { background: #ff9800; color: black; border-bottom: 4px solid #b36b00; }
        .btn-play { background: #00e676; color: black; border-bottom: 4px solid #00a352; }
        .btn-play.active { background: #00ff80; box-shadow: 0 0 15px #00ff80; border:none; }

        /* ×”××™×§×¡×¨ ×‘×××¦×¢ */
        .mixer {
            width: 120px; background: #181818; border-radius: 5px;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 10px 0; border: 1px solid #333;
        }
        
        /* ×¡×œ×™×™×“×¨ ×•×•×œ×™×•× ×× ×›×™ */
        .fader-track {
            width: 6px; height: 100px; background: #000; border-radius: 3px; position: relative;
        }
        .fader-thumb {
            width: 30px; height: 15px; background: #ddd; border-radius: 2px;
            position: absolute; left: -12px; top: 20%; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* ×¤×“×™× ×œ××¤×§×˜×™× */
        .pads-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px; width: 100%; margin-top: 10px;
        }
        .pad-btn {
            height: 40px; background: #333; border: none; border-radius: 4px; cursor: pointer;
            transition: 0.1s; border-bottom: 3px solid #222;
        }
        .pad-btn:active { background: var(--primary); border: none; transform: translateY(3px); box-shadow: 0 0 10px var(--primary); }

        /* ××–×•×¨ ×”×©×™×¨×™× ×œ××˜×” */
        .library-section {
            flex: 1; overflow-y: auto; padding: 10px; background: #0a0a0a;
        }

        /* --- ×©××¨ ×”×¢×™×¦×•×‘ ×”×¨×’×™×œ (Login, Sidebar) --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1e1e1e, #000);
            z-index: 3000;
        }
        .login-card {
            background: rgba(30,30,30,0.8); padding: 40px; border-radius: 20px; text-align: center; border: 1px solid #333;
        }
        input.auth-input {
            padding: 15px; border-radius: 30px; border: 1px solid #333; background: #222; color: white; text-align: center;
        }
        .btn-grad {
            background: var(--primary); padding: 15px; border-radius: 30px; border:none; font-weight:bold; cursor:pointer; width:100%; margin-top:10px;
        }

        /* ×¨×¡×¤×•× ×¡×™×‘×™×•×ª */
        @media (max-width: 768px) {
            #appScreen { display: flex; flex-direction: column; height: 100%; }
            .sidebar { display: none; }
            .jog-wheel { width: 100px; height: 100px; } /* ×§×˜×Ÿ ×™×•×ª×¨ ×‘×˜×œ×¤×•×Ÿ */
            .mixer { width: 60px; }
            #djInterface { height: 45vh; }
        }

        /* ×œ×™×™×××•×˜ ×¨×’×™×œ */
        #appScreen { display: none; height: 100%; }
        .sidebar { width: 250px; background: #000; padding: 20px; border-left: 1px solid #333; display: flex; flex-direction: column; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 20px; }
        .video-card { background: #1a1a1a; padding: 10px; border-radius: 8px; cursor: pointer; }
        .video-card:hover { background: #333; }
        .card-img { width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 4px; }

        /* × ×’×Ÿ ×ª×—×ª×•×Ÿ ×¨×’×™×œ */
        .bottom-bar { height: 90px; background: #181818; border-top: 1px solid #333; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
        .bottom-bar.hidden { display: none; } /* ××•×¡×ª×¨ ×‘××¦×‘ DJ */

    </style>
</head>
<body>

    <!-- ×›× ×™×¡×” -->
    <div id="loginScreen">
        <h1 style="color:white; font-size: 38px;">YouSync <span style="color:var(--primary)">DJ</span></h1>
        <div class="login-card">
            <input type="text" id="usernameInput" class="auth-input" placeholder="×©× ×”-DJ">
            <button class="btn-grad" onclick="createRoom()">×¦×•×¨ ×—×“×¨</button>
            <p style="color:#777; margin:10px;">××•</p>
            <input type="number" id="roomInput" class="auth-input" placeholder="×§×•×“ ×—×“×¨">
            <button class="btn-grad" style="background:#333; color:white;" onclick="joinRoom()">×”×¦×˜×¨×£</button>
        </div>
    </div>

    <!-- ×”××¤×œ×™×§×¦×™×” -->
    <div id="appScreen">
        
        <!-- ×¡×¨×’×œ ×¦×“ (×¨×’×™×œ) -->
        <div class="sidebar">
            <h2 style="color:white;">You<span>Sync</span></h2>
            <button class="btn-grad" style="background: linear-gradient(45deg, #00e5ff, #2979ff);" onclick="toggleDJMode()">ğŸ›ï¸ ×¢×‘×•×¨ ×œ××¦×‘ DJ</button>
            <div style="margin-top:20px; color:#aaa;">×—×“×¨: <span id="roomCodeDisplay"></span></div>
            <div id="usersList" style="margin-top:10px;"></div>
        </div>

        <!-- ×ª×•×›×Ÿ ×¨××©×™ -->
        <div class="main-content">
            
            <!-- ×××©×§ ×”-DJ (××•×¡×ª×¨ ×‘×”×ª×—×œ×”) -->
            <div id="djInterface">
                <div class="decks-container">
                    
                    <!-- DECK A (×©×××œ) -->
                    <div class="deck">
                        <div class="deck-screen">DECK A - READY</div>
                        <div class="jog-wheel" id="jogA">
                            <img src="https://via.placeholder.com/150" class="deck-art" id="artA">
                        </div>
                        <div class="deck-controls">
                            <button class="dj-btn btn-cue" onclick="djCue()">CUE</button>
                            <button class="dj-btn btn-play" id="btnPlayA" onclick="togglePlay()"><i class="fas fa-play"></i></button>
                        </div>
                    </div>

                    <!-- MIXER (×××¦×¢) -->
                    <div class="mixer">
                        <div style="color:#aaa; font-size:10px;">MASTER</div>
                        <div class="fader-track"><div class="fader-thumb"></div></div>
                        
                        <!-- ×¡××•× ×“ ×‘×•×¨×“ -->
                        <div class="pads-grid">
                            <button class="pad-btn" onclick="playSfx('horn')" style="background:#ff4081;"></button>
                            <button class="pad-btn" onclick="playSfx('siren')" style="background:#00e5ff;"></button>
                            <button class="pad-btn" onclick="playSfx('scratch')" style="background:#ffd740;"></button>
                            <button class="pad-btn" onclick="sendReaction('ğŸ”¥')" style="background:#7c4dff;">ğŸ”¥</button>
                        </div>
                    </div>

                    <!-- DECK B (×™××™×Ÿ - ×•×™×–×•××œ×™ ×‘×œ×‘×“ ×›×¨×’×¢) -->
                    <div class="deck">
                        <div class="deck-screen" style="color:#ff4081;">DECK B - IDLE</div>
                        <div class="jog-wheel">
                            <img src="https://cdn-icons-png.flaticon.com/512/1753/1753311.png" class="deck-art" style="opacity:0.3;">
                        </div>
                        <div class="deck-controls">
                            <button class="dj-btn btn-cue">CUE</button>
                            <button class="dj-btn btn-play"><i class="fas fa-play"></i></button>
                        </div>
                    </div>

                </div>
            </div>

            <!-- ××–×•×¨ ×”×—×™×¤×•×© ×•×”×©×™×¨×™× (× ×©××¨ ×ª××™×“) -->
            <div class="library-section">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="searchInput" placeholder="×—×¤×© ×©×™×¨ ×œ×”×•×¡×¤×”..." style="flex:1; padding:10px; border-radius:20px; border:none; background:#222; color:white;">
                    <button onclick="searchVideos()" style="width:50px; border-radius:50%; border:none; background:#333; color:white; cursor:pointer;"><i class="fas fa-search"></i></button>
                </div>
                
                <!-- × ×’×Ÿ ××•×¡×ª×¨ (××‘×œ ×¢×•×‘×“) -->
                <div class="video-wrapper standard-player-ui">
                    <div id="player"></div>
                </div>

                <h3 style="margin-top:0;">ğŸ“‚ ×××’×¨ ×©×™×¨×™×</h3>
                <div id="resultsGrid" class="results-grid"></div>
            </div>

        </div>

        <!-- × ×’×Ÿ ×ª×—×ª×•×Ÿ (×¨×’×™×œ) -->
        <div class="bottom-bar standard-player-ui">
            <div style="display:flex; align-items:center; gap:10px;">
                <img id="npThumb" src="https://via.placeholder.com/50" style="width:40px; border-radius:4px;">
                <div>
                    <div id="npTitle" style="font-weight:bold; font-size:14px;">×œ× ×× ×’×Ÿ</div>
                    <div style="font-size:12px; color:#aaa;">YouSync</div>
                </div>
            </div>
            <button onclick="togglePlay()" style="background:white; color:black; border-radius:50%; width:40px; height:40px; border:none; font-size:20px;"><i class="fas fa-play" id="playIcon"></i></button>
        </div>

    </div>

    <script>
        const RAPID_API_KEY = 'efb1ed4f48msh5dfd6650699ded0p1f5775jsn2c2c0eb8bbb3';
        const RAPID_API_HOST = 'youtube-mp36.p.rapidapi.com'; 
        const YOUTUBE_API_KEY = 'AIzaSyAuLutPPSJlZJKkfBrzRNURSibcqkeeA60';

        const firebaseConfig = {
            apiKey: "AIzaSyDKN3qgnvUP4SZX9aOAaThnDI4vUjjVw9A",
            authDomain: "musicsync-58d86.firebaseapp.com",
            projectId: "musicsync-58d86",
            databaseURL: "https://musicsync-58d86-default-rtdb.firebaseio.com"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e){}
        const db = firebase.database();

        let player, isSyncing = false, currentRoom = null, myName = "";
        
        // --- ××¦×‘ DJ ---
        function toggleDJMode() {
            document.body.classList.toggle('dj-mode');
            const isDJ = document.body.classList.contains('dj-mode');
            if(isDJ) {
                // ××¤×§×˜ ×¡××•× ×“ ×‘×”×¤×¢×œ×”
                playSfx('scratch');
            }
        }

        // ××¤×§×˜×™× ×§×•×œ×™×™× (Data URIs ×§×¦×¨×™×)
        const sfx = {
            horn: "data:audio/mp3;base64,//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq", // (××§×•×¦×¨)
            scratch: "data:audio/wav;base64,UklGRjIAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YRAAAACAgICAgICAgICAgICAgICA" // (××§×•×¦×¨)
        };
        // ×”×¢×¨×”: ×‘×§×•×“ ×”×××™×ª×™ ×¦×¨×™×š ×§×‘×¦×™ ×¡××•× ×“ ×××™×ª×™×™×, ×›××Ÿ ×©××ª×™ ×“××” ×›×“×™ ×©×”×§×•×“ ×™×¢×‘×•×“ ×‘×œ×™ ×©×’×™××•×ª

        function playSfx(type) {
            // ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ ×§×™×©×•×¨×™× ×××™×ª×™×™× ×œ×§×‘×¦×™ MP3 ×©×œ ××™×™×¨-×”×•×¨×Ÿ ×•×›×•'
            console.log("Playing SFX:", type);
            // new Audio('horn.mp3').play();
        }

        function djCue() {
            if(player) {
                player.seekTo(0);
                player.pauseVideo();
            }
        }

        // --- ×œ×•×’×™×§×” ×¨×’×™×œ×” ---
        function createRoom() {
            myName = document.getElementById('usernameInput').value || "DJ Admin";
            enterRoom(Math.floor(1000 + Math.random() * 9000));
        }
        function joinRoom() {
            myName = document.getElementById('usernameInput').value || "Guest";
            const code = document.getElementById('roomInput').value;
            if(code) enterRoom(code);
        }

        function enterRoom(code) {
            currentRoom = code;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = (window.innerWidth > 768) ? 'flex' : 'block';
            document.getElementById('roomCodeDisplay').innerText = code;

            loadYoutubePlayer();
            loadHomePage(); 

            // ××©×ª××©×™×
            db.ref(`rooms/${code}/users`).push({ name: myName }).onDisconnect().remove();
            db.ref(`rooms/${code}/users`).on('value', snap => {
                const list = document.getElementById('usersList');
                list.innerHTML = "";
                snap.forEach(child => list.innerHTML += `<div>ğŸ‘¤ ${child.val().name}</div>`);
            });

            // ×”××–× ×” ×œ×©×™×¨
            db.ref(`rooms/${currentRoom}/current_song`).on('value', snap => {
                const data = snap.val();
                if (!data) return;
                
                // ×¢×“×›×•×Ÿ ×’× ×‘× ×’×Ÿ ×”×¨×’×™×œ ×•×’× ×‘-DJ
                const title = data.title;
                const thumb = data.thumbnail || "https://via.placeholder.com/150";
                
                document.getElementById('npTitle').innerText = title;
                document.getElementById('npThumb').src = thumb;
                
                // ×¢×“×›×•×Ÿ ×”-DECK ×‘××¦×‘ DJ
                document.getElementById('artA').src = thumb;
                document.querySelector('.deck-screen').innerText = "NOW PLAYING: " + title.substring(0, 20);

                if (player && player.loadVideoById && player.getVideoData().video_id !== data.videoId) {
                    isSyncing = true;
                    player.loadVideoById(data.videoId);
                    setTimeout(() => isSyncing = false, 1500);
                }

                // ×× ×™××¦×™×™×ª ×¡×™×‘×•×‘
                const jog = document.getElementById('jogA');
                const btnA = document.getElementById('btnPlayA');
                const icon = document.getElementById('playIcon');

                if (data.status === 1) { // ×× ×’×Ÿ
                    jog.classList.add('spinning');
                    btnA.classList.add('active');
                    btnA.innerHTML = '<i class="fas fa-pause"></i>';
                    icon.className = "fas fa-pause";
                    if (player && player.playVideo) player.playVideo();
                } else {
                    jog.classList.remove('spinning');
                    btnA.classList.remove('active');
                    btnA.innerHTML = '<i class="fas fa-play"></i>';
                    icon.className = "fas fa-play";
                    if (player && player.pauseVideo) player.pauseVideo();
                }
            });
        }

        // --- × ×’×Ÿ ---
        function loadYoutubePlayer() {
            if (typeof YT !== 'undefined' && YT.Player) onYouTubeIframeAPIReady();
            else {
                var tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '', 
                host: 'https://www.youtube-nocookie.com',
                playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0, 'modestbranding': 1, 'playsinline': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(event) {
            if (isSyncing || !currentRoom) return;
            if (event.data === 1 || event.data === 2) {
                db.ref(`rooms/${currentRoom}/current_song`).update({ status: event.data });
            }
        }

        function togglePlay() {
            if(!player) return;
            const newStatus = (player.getPlayerState() === 1) ? 2 : 1;
            db.ref(`rooms/${currentRoom}/current_song`).update({ status: newStatus });
        }

        // --- ×—×™×¤×•×© ---
        async function loadHomePage() {
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '<p style="color:#aaa; text-align:center;">×˜×•×¢×Ÿ...</p>';
            
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=20&q=${encodeURIComponent("×œ×”×™×˜×™× 2025")}&key=${YOUTUBE_API_KEY}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                grid.innerHTML = "";
                if(data.items) renderGrid(data.items);
            } catch(e) {}
        }

        async function searchVideos() {
            const q = document.getElementById('searchInput').value;
            if(!q) return;
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=20&q=${encodeURIComponent(q)}&key=${YOUTUBE_API_KEY}`;
            const res = await fetch(url);
            const data = await res.json();
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = "";
            if(data.items) renderGrid(data.items);
        }

        function renderGrid(videos) {
            const grid = document.getElementById('resultsGrid');
            videos.forEach(item => {
                const div = document.createElement('div');
                div.className = 'video-card';
                div.style.cssText = "background:#222; padding:8px; border-radius:5px; cursor:pointer;";
                div.onclick = () => playVideo(item.id.videoId, item.snippet.title, item.snippet.thumbnails.medium.url);
                div.innerHTML = `
                    <img src="${item.snippet.thumbnails.medium.url}" style="width:100%; border-radius:4px;">
                    <div style="font-size:12px; margin-top:5px; white-space:nowrap; overflow:hidden;">${item.snippet.title}</div>
                `;
                grid.appendChild(div);
            });
        }

        function playVideo(id, title, thumb) {
            db.ref(`rooms/${currentRoom}/current_song`).set({
                videoId: id, title: title, thumbnail: thumb, status: 1
            });
        }

    </script>
</body>
</html>
