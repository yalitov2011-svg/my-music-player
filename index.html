<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸµ ×”× ×’×Ÿ ×”×—×‘×¨×ª×™ - ×—×“×¨×™×</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { 
            background-color: #121212; 
            color: white; 
            font-family: 'Segoe UI', sans-serif; 
            text-align: center; 
            margin: 0; padding: 20px;
        }

        /* ××¡×š ×›× ×™×¡×” */
        #loginScreen {
            margin-top: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .box {
            background: #1e1e1e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 90%; max-width: 400px;
        }

        /* ××¡×š × ×’×Ÿ */
        #playerScreen { display: none; } /* ××•×¡×ª×¨ ×‘×”×ª×—×œ×” */

        h1 { color: #ff0000; text-shadow: 0 0 10px rgba(255,0,0,0.5); }
        
        input { 
            padding: 15px; 
            border-radius: 30px; 
            border: 1px solid #333; 
            background: #2a2a2a;
            color: white;
            width: 70%; 
            font-size: 18px;
            text-align: center;
            outline: none;
            margin-bottom: 10px;
        }

        button { 
            padding: 12px 30px; 
            background: #ff0000; 
            color: white; 
            border: none; 
            cursor: pointer; 
            border-radius: 30px; 
            font-weight: bold; 
            font-size: 16px;
            transition: 0.2s;
            width: 100%;
        }
        button:hover { transform: scale(1.05); background: #cc0000; }
        
        .secondary-btn { background: #444; margin-top: 10px; }
        .secondary-btn:hover { background: #666; }

        .room-badge {
            background: #333;
            padding: 5px 15px;
            border-radius: 20px;
            color: #00ff00;
            font-family: monospace;
            font-size: 20px;
            margin-bottom: 20px;
            display: inline-block;
            border: 1px solid #00ff00;
        }

        .player-box { 
            width: 100%; max-width: 800px; 
            aspect-ratio: 16/9; 
            background: #000; 
            margin: 20px auto; 
            border-radius: 15px; 
            overflow: hidden; 
            border: 2px solid #333;
        }
        
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <h1>ğŸ§ ×›× ×™×¡×” ×œ× ×’×Ÿ ×”××©×•×ª×£</h1>
        <div class="box">
            <h3>×¦×•×¨ ×—×“×¨ ×—×“×©</h3>
            <button onclick="createRoom()">âœ¨ ×¦×•×¨ ×—×“×¨ ×•×§×‘×œ ×§×•×“</button>
            
            <hr style="border-color: #333; margin: 20px 0;">
            
            <h3>××• ×”×¦×˜×¨×£ ×œ×—×‘×¨</h3>
            <input type="number" id="roomInput" placeholder="×”×›× ×¡ ×§×•×“ ×—×“×¨ (×œ××©×œ 1234)">
            <button class="secondary-btn" onclick="joinRoom()">ğŸš€ ×›× ×¡ ×œ×—×“×¨</button>
        </div>
    </div>

    <div id="playerScreen">
        <h1>ğŸµ ××—×•×‘×¨ ×œ×—×“×¨</h1>
        <div class="room-badge">×§×•×“ ×—×“×¨: <span id="displayRoomCode">---</span></div>
        
        <div>
            <input type="text" id="searchQuery" placeholder="××™×–×” ×©×™×¨ ×œ×©×™× ×œ×›×•×œ×?">
            <button onclick="searchAndSync()" style="width: auto;">× ×’×Ÿ â–¶</button>
        </div>

        <div class="player-box">
            <div id="player"></div>
        </div>
        <p id="statusText" style="color: gray;">×××ª×™×Ÿ ×œ×©×™×¨...</p>
    </div>

    <script>
        // --- ×”×’×“×¨×•×ª Firebase ×©×œ×š ---
        const firebaseConfig = {
            apiKey: "AIzaSyDKN3qgnvUP4SZX9aOAaThnDI4vUjjVw9A",
            authDomain: "musicsync-58d86.firebaseapp.com",
            projectId: "musicsync-58d86",
            storageBucket: "musicsync-58d86.firebasestorage.app",
            messagingSenderId: "367949692420",
            appId: "1:367949692420:web:414a34b0c14dc46e51ff51",
            databaseURL: "https://musicsync-58d86-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const YOUTUBE_API_KEY = 'AIzaSyAuLutPPSJlZJKkfBrzRNURSibcqkeeA60'; 

        let player;
        let isSyncing = false; 
        let currentRoom = null; // ×›××Ÿ × ×©××•×¨ ××ª ××¡×¤×¨ ×”×—×“×¨

        // --- ×œ×•×’×™×§×” ×©×œ ×—×“×¨×™× ---

        function createRoom() {
            // ××’×¨×™×œ ××¡×¤×¨ ×‘×™×Ÿ 1000 ×œ-9999
            const newCode = Math.floor(1000 + Math.random() * 9000);
            enterRoom(newCode);
        }

        function joinRoom() {
            const code = document.getElementById('roomInput').value;
            if (code.length < 4) {
                alert("× × ×œ×”×›× ×™×¡ ×§×•×“ ×ª×§×™×Ÿ");
                return;
            }
            enterRoom(code);
        }

        function enterRoom(code) {
            currentRoom = code;
            // ×”×¡×ª×¨×ª ××¡×š ×›× ×™×¡×” ×•×”×¦×’×ª ×”× ×’×Ÿ
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('playerScreen').style.display = 'block';
            document.getElementById('displayRoomCode').innerText = code;
            
            // ×˜×¢×™× ×ª ×”× ×’×Ÿ ×•×”×ª×—×‘×¨×•×ª ×œ×—×“×¨ ×”×¡×¤×¦×™×¤×™
            loadYoutubePlayer();
        }

        // --- × ×’×Ÿ ×•×¡× ×›×¨×•×Ÿ ---

        function loadYoutubePlayer() {
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: '', 
                playerVars: { 
                    'autoplay': 1, 
                    'controls': 1,
                    'rel': 0, // ××¤×—×™×ª ×”××œ×¦×•×ª ×‘×¡×•×£
                    'modestbranding': 1 // ××¡×ª×™×¨ ×œ×•×’×•××™×
                },
                events: {
                    'onReady': connectToRoom, 
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function connectToRoom() {
            // ××ª×—×‘×¨ ×¨×§ ×œ× ×ª×™×‘ ×©×œ ×”×—×“×¨ ×”×¡×¤×¦×™×¤×™!
            // rooms/1234/current_song
            const roomRef = db.ref('rooms/' + currentRoom);

            roomRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                document.getElementById('statusText').innerText = `×× ×’×Ÿ: ${data.title}`;

                // ×¡× ×›×¨×•×Ÿ ×©×™×¨
                if (player.getVideoData().video_id !== data.videoId) {
                    isSyncing = true;
                    player.loadVideoById(data.videoId);
                    player.seekTo(0);
                    setTimeout(() => isSyncing = false, 1500);
                }

                // ×¡× ×›×¨×•×Ÿ ××¦×‘ (Play/Pause)
                const state = player.getPlayerState();
                if (data.status === 2 && state !== 2) player.pauseVideo();
                else if (data.status === 1 && state !== 1 && state !== 3) player.playVideo();
            });
        }

        function onPlayerStateChange(event) {
            if (isSyncing || !currentRoom) return; 
            if (event.data === 1 || event.data === 2) {
                db.ref('rooms/' + currentRoom).update({ status: event.data });
            }
        }

        async function searchAndSync() {
            const query = document.getElementById('searchQuery').value;
            if (!query) return;

            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=1&q=${encodeURIComponent(query + " lyrics")}&videoEmbeddable=true&key=${YOUTUBE_API_KEY}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (!data.items || data.items.length === 0) return alert("×œ× × ××¦×");

                const video = data.items[0];

                // ×©×•×œ×— ××ª ×”×©×™×¨ ×œ×—×“×¨ ×”×¡×¤×¦×™×¤×™ ×‘-Firebase
                db.ref('rooms/' + currentRoom).set({
                    videoId: video.id.videoId,
                    title: video.snippet.title,
                    status: 1
                });
                
                document.getElementById('searchQuery').value = "";

            } catch (error) {
                alert("×©×’×™××”");
            }
        }
        
        // ×× ×˜×¨ ×œ×—×™×¤×•×©
        document.getElementById('searchQuery').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchAndSync();
        });
    </script>
</body>
</html>
