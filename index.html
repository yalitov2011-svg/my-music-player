<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouSync Ultimate Party</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- ×¢×™×¦×•×‘ ×›×œ×œ×™ (×“××¨×§ ××•×“) --- */
        body { 
            background-color: #121212; 
            color: white; 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; padding: 0;
            overflow-x: hidden;
        }
        
        /* ×¡×¨×’×œ ×¢×œ×™×•×Ÿ */
        .navbar {
            background: #000; padding: 10px 20px;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #333;
        }
        .logo { font-size: 20px; font-weight: bold; color: white; cursor: pointer; }
        .logo span { color: #1DB954; } /* ×™×¨×•×§ ×¡×¤×•×˜×™×¤×™×™ */

        /* ×—×™×¤×•×© */
        .search-box {
            display: flex; background: #333; border-radius: 20px; padding: 5px 15px; width: 40%;
        }
        .search-box input {
            background: transparent; border: none; color: white; width: 100%; outline: none; text-align: right;
        }

        /* ××¡×š ×›× ×™×¡×” */
        #loginScreen {
            height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: linear-gradient(45deg, #121212, #1e1e1e);
        }
        .login-card {
            background: #282828; padding: 40px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        input.auth-input {
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; background: #444; color: white;
            box-sizing: border-box; /* ×—×©×•×‘ ×›×“×™ ×©×œ× ×™×—×¨×•×’ */
        }
        .btn-main {
            width: 100%; padding: 12px; border-radius: 25px; border: none; background: #1DB954; color: black; font-weight: bold; cursor: pointer; margin-top: 10px;
            transition: 0.2s;
        }
        .btn-main:hover { transform: scale(1.05); }

        /* --- ×œ×™×™×OUT ×”×¨××©×™ (×’×¨×™×“) --- */
        .main-layout {
            display: grid;
            grid-template-columns: 3fr 1fr; /* × ×’×Ÿ ×’×“×•×œ, ×¦'××˜ ×§×˜×Ÿ */
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            height: calc(100vh - 60px);
        }

        /* ××–×•×¨ ×”× ×’×Ÿ (×©×××œ) */
        .left-panel { overflow-y: auto; padding-right: 10px; }
        
        .player-wrapper {
            width: 100%; aspect-ratio: 16/9; background: black; border-radius: 10px; overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        iframe { width: 100%; height: 100%; border: none; }

        .song-info { margin: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .song-title { font-size: 22px; font-weight: bold; }
        
        /* ×›×¤×ª×•×¨×™ ×¨×™××§×¦×™×•×ª */
        .reactions-bar { display: flex; gap: 10px; margin: 10px 0; }
        .reaction-btn { 
            background: #333; border: none; font-size: 20px; padding: 10px; border-radius: 50%; cursor: pointer; transition: 0.2s;
        }
        .reaction-btn:hover { transform: scale(1.2); background: #444; }

        /* ×’×œ×¨×™×” ×•×”×™×¡×˜×•×¨×™×” */
        .section-header { font-size: 18px; font-weight: bold; margin-top: 20px; border-bottom: 1px solid #333; padding-bottom: 5px; color: #1DB954; }
        
        .video-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;
        }
        .video-card { cursor: pointer; transition: 0.2s; }
        .video-card:hover { opacity: 0.8; }
        .video-thumb { width: 100%; border-radius: 8px; aspect-ratio: 16/9; object-fit: cover; }
        .video-text { font-size: 14px; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* ××–×•×¨ ×”×¦'××˜ (×™××™×Ÿ) */
        .right-panel {
            background: #181818; border-radius: 10px; display: flex; flex-direction: column; overflow: hidden;
        }
        .tabs { display: flex; background: #222; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-size: 14px; color: #aaa; }
        .tab.active { background: #333; color: white; border-bottom: 2px solid #1DB954; }
        
        .chat-area { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { font-size: 14px; background: #282828; padding: 8px; border-radius: 8px; width: fit-content; max-width: 85%; }
        .msg strong { color: #1DB954; font-size: 12px; display: block; margin-bottom: 2px; }
        .msg.system { background: transparent; color: #777; font-size: 12px; text-align: center; width: 100%; }
        
        .chat-input-area { padding: 10px; background: #222; display: flex; gap: 5px; }
        .chat-input { flex: 1; padding: 8px; border-radius: 20px; border: none; background: #444; color: white; outline: none; }

        /* ×× ×™××¦×™×™×ª ×¨×™××§×¦×™×•×ª ×¦×¤×•×ª */
        .floating-emoji {
            position: fixed; bottom: 20px; left: 50%; font-size: 40px; pointer-events: none;
            animation: floatUp 2s ease-out forwards; z-index: 9999;
        }
        @keyframes floatUp {
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
            20% { opacity: 1; transform: translate(-50%, -50px) scale(1.2); }
            100% { transform: translate(-50%, -300px) scale(1); opacity: 0; }
        }

        /* ×”×ª×××” ×œ×˜×œ×¤×•×Ÿ */
        @media (max-width: 768px) {
            .main-layout { grid-template-columns: 1fr; padding: 10px; height: auto; }
            .right-panel { height: 400px; margin-top: 20px; }
            .search-box { width: 60%; }
        }

        /* ××•×“×œ ××™×œ×™× ×œ×©×™×¨×™× */
        #lyricsModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center;
        }
        .lyrics-content {
            background: #222; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px;
            max-height: 80vh; overflow-y: auto; white-space: pre-wrap; text-align: center; font-size: 16px; line-height: 1.6;
        }

    </style>
</head>
<body>

    <div id="navbar" class="navbar" style="display: none;">
        <div class="logo" onclick="location.reload()">You<span>Sync</span></div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="×—×¤×© ×©×™×¨...">
            <span style="cursor: pointer;" onclick="searchVideos()">ğŸ”</span>
        </div>
        <div style="font-size: 14px;">
            <span id="userBadge">ğŸ‘¤</span> <span id="myNameDisplay"></span>
        </div>
    </div>

    <div id="loginScreen">
        <h1 style="color:white; font-size: 40px; margin-bottom: 20px;">You<span style="color:#1DB954">Sync</span> Party</h1>
        <div class="login-card">
            <h3>×”×™×™! ××™ ××¦×˜×¨×£?</h3>
            <input type="text" id="usernameInput" class="auth-input" placeholder="×”×©× ×©×œ×š">
            <button class="btn-main" onclick="createRoom()">ğŸ‘‘ ×¦×•×¨ ×—×“×¨ ×—×“×©</button>
            <p style="color: #777; margin: 15px 0;">--- ××• ---</p>
            <input type="number" id="roomInput" class="auth-input" placeholder="×§×•×“ ×—×“×¨">
            <button class="btn-main" style="background: #333; color: white;" onclick="joinRoom()">ğŸš€ ×›× ×¡ ×œ×—×“×¨</button>
        </div>
    </div>

    <div id="appScreen" class="main-layout" style="display: none;">
        
        <div class="left-panel">
            <div class="player-wrapper">
                <div id="player"></div>
            </div>

            <div class="song-info">
                <div>
                    <div class="song-title" id="currentTitle">×œ× ×× ×’×Ÿ ×›×¨×’×¢</div>
                    <div style="color: #aaa; font-size: 14px;">×—×“×¨: <span id="roomCodeDisplay" style="color: #1DB954;">---</span></div>
                </div>
                <div>
                    <button class="btn-main" style="width: auto; padding: 8px 15px; font-size: 12px;" onclick="getLyrics()">ğŸ¤ ××™×œ×™×</button>
                </div>
            </div>

            <div class="reactions-bar">
                <button class="reaction-btn" onclick="sendReaction('ğŸ”¥')">ğŸ”¥</button>
                <button class="reaction-btn" onclick="sendReaction('â¤ï¸')">â¤ï¸</button>
                <button class="reaction-btn" onclick="sendReaction('ğŸ˜‚')">ğŸ˜‚</button>
                <button class="reaction-btn" onclick="sendReaction('ğŸ¤¯')">ğŸ¤¯</button>
                <button class="reaction-btn" onclick="sendReaction('ğŸ’ƒ')">ğŸ’ƒ</button>
            </div>

            <h3 class="section-header">ğŸ“œ ×”×™×¡×˜×•×¨×™×”</h3>
            <div class="video-grid" id="historyGrid"></div>

            <h3 class="section-header">ğŸ”¥ ×œ×”×™×˜×™× ×—××™×</h3>
            <div class="video-grid" id="recommendationsGrid"></div>
        </div>

        <div class="right-panel">
            <div class="tabs">
                <div class="tab active">×¦'××˜</div>
                <div class="tab" style="cursor: default;">ğŸ‘¥ <span id="onlineCount">0</span> ××—×•×‘×¨×™×</div>
            </div>
            
            <div class="chat-area" id="chatArea">
                <div class="msg system">×‘×¨×•×›×™× ×”×‘××™× ×œ×—×“×¨!</div>
            </div>

            <div class="chat-input-area">
                <input type="text" id="chatInput" class="chat-input" placeholder="×›×ª×•×‘ ×”×•×“×¢×”...">
                <button onclick="sendMessage()" style="background: #1DB954; border:none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer;">â¤</button>
            </div>
        </div>

    </div>

    <div id="lyricsModal" onclick="this.style.display='none'">
        <div class="lyrics-content" id="lyricsText">×˜×•×¢×Ÿ ××™×œ×™×...</div>
    </div>

    <script>
        // --- ×”×’×“×¨×•×ª ---
        const firebaseConfig = {
            apiKey: "AIzaSyDKN3qgnvUP4SZX9aOAaThnDI4vUjjVw9A",
            authDomain: "musicsync-58d86.firebaseapp.com",
            projectId: "musicsync-58d86",
            databaseURL: "https://musicsync-58d86-default-rtdb.firebaseio.com"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e){}
        const db = firebase.database();
        const YOUTUBE_API_KEY = 'AIzaSyAuLutPPSJlZJKkfBrzRNURSibcqkeeA60';

        let player, isSyncing = false, currentRoom = null, myName = "", isCreator = false;

        // --- ×›× ×™×¡×” ×•××¢×¨×›×ª ×—×“×¨×™× ---
        function createRoom() {
            myName = document.getElementById('usernameInput').value || "DJ Master";
            isCreator = true;
            enterRoom(Math.floor(1000 + Math.random() * 9000));
        }

        function joinRoom() {
            myName = document.getElementById('usernameInput').value || "Guest";
            const code = document.getElementById('roomInput').value;
            if(code) enterRoom(code);
            else alert("× × ×œ×”×–×™×Ÿ ×§×•×“ ×—×“×¨");
        }

        function enterRoom(code) {
            currentRoom = code;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('navbar').style.display = 'flex';
            document.getElementById('appScreen').style.display = 'grid'; // grid ×œ×œ×™×™×××•×˜ ×”×—×“×©
            document.getElementById('roomCodeDisplay').innerText = code;
            document.getElementById('myNameDisplay').innerText = myName;
            
            if (isCreator) {
                document.getElementById('userBadge').innerText = "ğŸ‘‘"; // ×›×ª×¨ ×œ×™×•×¦×¨
                db.ref(`rooms/${code}/creator`).set(myName);
            }

            loadYoutubePlayer();
            loadRecommendations();
            setupFirebaseListeners();
        }

        // --- ×××–×™× ×™× ×©×œ Firebase (×”×œ×‘ ×©×œ ×”××¢×¨×›×ª) ---
        function setupFirebaseListeners() {
            // 1. ××©×ª××©×™× ××—×•×‘×¨×™×
            const userRef = db.ref(`rooms/${currentRoom}/users`).push();
            userRef.set({ name: myName });
            userRef.onDisconnect().remove();
            db.ref(`rooms/${currentRoom}/users`).on('value', snap => {
                document.getElementById('onlineCount').innerText = snap.numChildren();
            });

            // 2. ×©×™×¨ × ×•×›×—×™ ×•×¡× ×›×¨×•×Ÿ
            db.ref(`rooms/${currentRoom}/current_song`).on('value', snapshot => {
                const data = snapshot.val();
                if (!data) return;
                
                document.getElementById('currentTitle').innerText = data.title;
                
                // ×¡× ×›×¨×•×Ÿ ×•×™×“××• (×¨×§ ×× ×”×©×™×¨ ×©×•× ×”)
                if (player && player.loadVideoById && player.getVideoData().video_id !== data.videoId) {
                    isSyncing = true;
                    player.loadVideoById(data.videoId);
                    addToHistory(data.videoId, data.title, data.thumbnail); // ×”×•×¡×¤×” ×œ×”×™×¡×˜×•×¨×™×”
                    setTimeout(() => isSyncing = false, 1500);
                }

                // ×¡× ×›×¨×•×Ÿ ×–××Ÿ ×•×¡×˜×˜×•×¡ (Play/Pause)
                if (player && player.getPlayerState && !isSyncing) {
                    const diff = Math.abs(player.getCurrentTime() - (data.timestamp || 0));
                    if (data.status === 1 && (player.getPlayerState() !== 1 || diff > 2)) {
                        player.seekTo(data.timestamp || 0);
                        player.playVideo();
                    } else if (data.status === 2 && player.getPlayerState() !== 2) {
                        player.pauseVideo();
                    }
                }
            });

            // 3. ×¦'××˜
            db.ref(`rooms/${currentRoom}/chat`).limitToLast(20).on('child_added', snapshot => {
                const msg = snapshot.val();
                const chatArea = document.getElementById('chatArea');
                chatArea.innerHTML += `
                    <div class="msg">
                        <strong>${msg.user}</strong>
                        ${msg.text}
                    </div>
                `;
                chatArea.scrollTop = chatArea.scrollHeight; // ×’×œ×™×œ×” ×œ××˜×”
            });

            // 4. ×¨×™××§×¦×™×•×ª
            db.ref(`rooms/${currentRoom}/reactions`).on('child_added', snapshot => {
                showFloatingEmoji(snapshot.val().emoji);
                snapshot.ref.remove(); // ××—×™×§×” ××™×“ ×›×“×™ ×œ× ×œ×”×¢××™×¡
            });
        }

        // --- × ×’×Ÿ ×™×•×˜×™×•×‘ ---
        function loadYoutubePlayer() {
            if (typeof YT !== 'undefined' && YT.Player) onYouTubeIframeAPIReady();
            else {
                var tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '', 
                host: 'https://www.youtube-nocookie.com',
                playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0, 'modestbranding': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(event) {
            if (isSyncing || !currentRoom) return;
            if (event.data === 1 || event.data === 2) {
                db.ref(`rooms/${currentRoom}/current_song`).update({
                    status: event.data,
                    timestamp: player.getCurrentTime()
                });
            }
        }

        // --- ×¤×•× ×§×¦×™×•×ª ×—×‘×¨×ª×™×•×ª ---
        
        // ×¦'××˜
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            
            db.ref(`rooms/${currentRoom}/chat`).push({
                user: myName,
                text: text
            });
            input.value = "";
        }
        document.getElementById('chatInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });

        // ×¨×™××§×¦×™×•×ª
        function sendReaction(emoji) {
            db.ref(`rooms/${currentRoom}/reactions`).push({ emoji: emoji });
        }

        function showFloatingEmoji(emoji) {
            const el = document.createElement('div');
            el.className = 'floating-emoji';
            el.innerText = emoji;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        // --- ×—×™×¤×•×© ×•×’×œ×¨×™×” ---
        async function loadRecommendations() {
            renderVideos("×œ×”×™×˜×™× ×™×©×¨××œ×™× 2025", 'recommendationsGrid');
        }

        async function searchVideos() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;
            
            // ×× ×§×” ××ª ×”×ª×¦×•×’×” ×•××¦×™×’ ×ª×•×¦××•×ª
            document.getElementById('recommendationsGrid').innerHTML = '<p>××—×¤×©...</p>';
            const header = document.querySelector('.section-header'); // ×›×•×ª×¨×ª ×œ×”×™×˜×™×
            if(header) header.innerText = `ğŸ” ×ª×•×¦××•×ª: ${query}`;
            
            await renderVideos(query, 'recommendationsGrid');
        }
        
        document.getElementById('searchInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') searchVideos(); });

        async function renderVideos(query, elementId) {
            const container = document.getElementById(elementId);
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                container.innerHTML = "";
                
                data.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'video-card';
                    div.onclick = () => playVideo(item.id.videoId, item.snippet.title, item.snippet.thumbnails.medium.url);
                    div.innerHTML = `
                        <img src="${item.snippet.thumbnails.medium.url}" class="video-thumb">
                        <div class="video-text">${item.snippet.title}</div>
                    `;
                    container.appendChild(div);
                });
            } catch(e) { container.innerHTML = "×©×’×™××” ×‘×˜×¢×™× ×”"; }
        }

        function playVideo(id, title, thumb) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            db.ref(`rooms/${currentRoom}/current_song`).set({
                videoId: id, title: title, thumbnail: thumb, status: 1, timestamp: 0
            });
        }

        // --- ×”×™×¡×˜×•×¨×™×” ---
        function addToHistory(id, title, thumb) {
            const container = document.getElementById('historyGrid');
            // ×‘×“×™×§×” ×× ×”×©×™×¨ ×›×‘×¨ ×§×™×™× (×›×“×™ ×œ× ×œ×©×›×¤×œ)
            if (container.innerHTML.includes(id)) return;
            
            const div = document.createElement('div');
            div.className = 'video-card';
            div.onclick = () => playVideo(id, title, thumb);
            div.innerHTML = `
                <img src="${thumb || 'https://via.placeholder.com/200'}" class="video-thumb">
                <div class="video-text">${title}</div>
            `;
            // ××•×¡×™×£ ×œ×”×ª×—×œ×”
            container.insertBefore(div, container.firstChild);
        }

        // --- ××™×œ×™× ×œ×©×™×¨×™× (×—×™×¤×•×© ×‘×’×•×’×œ ×‘×ª×•×š ×—×œ×•×Ÿ) ---
        function getLyrics() {
            const title = document.getElementById('currentTitle').innerText;
            if (title === "×œ× ×× ×’×Ÿ ×›×¨×’×¢") return;
            
            const modal = document.getElementById('lyricsModal');
            const content = document.getElementById('lyricsText');
            modal.style.display = 'flex';
            content.innerHTML = `
                <h3>${title}</h3>
                <p>×œ×¦×¢×¨× ×•, ×–×›×•×™×•×ª ×™×•×¦×¨×™× ××•× ×¢×•×ª ×”×¦×’×” ×™×©×™×¨×”.</p>
                <a href="https://www.google.com/search?q=${encodeURIComponent(title + ' lyrics')}" target="_blank" style="color:#1DB954; font-size:18px;">×œ×—×¥ ×›××Ÿ ×œ××™×œ×™× ×‘×’×•×’×œ</a>
            `;
        }

    </script>
</body>
</html>
