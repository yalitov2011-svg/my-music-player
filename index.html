<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YouSync V20 - Infinite & Shareable</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- ××™×™×§×•× ×™× -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #1DB954;
            --dark: #000000;
            --panel: #121212;
            --border: #333;
        }

        * { box-sizing: border-box; }

        body { 
            background-color: var(--dark);
            color: white; 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; padding: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- ××¡×š ×›× ×™×¡×” --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1e1e1e, #000);
            z-index: 2000;
        }
        .login-card {
            background: rgba(20,20,20,0.9); padding: 40px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center;
            border: 1px solid var(--border);
        }
        input.auth-input {
            width: 100%; padding: 15px; margin: 10px 0; border-radius: 30px; border: 1px solid #333; 
            background: #222; color: white; outline: none; text-align: center; font-size: 16px;
        }
        .btn-grad {
            background: var(--primary); border: none; color: black; font-weight: bold; padding: 15px; width: 100%; border-radius: 30px;
            cursor: pointer; font-size: 16px; margin-top: 10px;
        }

        /* --- ×œ×™×™×××•×˜ --- */
        #appScreen {
            display: none;
            flex: 1;
            display: grid;
            grid-template-columns: 250px 1fr 320px;
            grid-template-rows: 1fr 90px;
            height: 100%;
            overflow: hidden;
        }

        body.chat-hidden #appScreen {
            grid-template-columns: 250px 1fr 0px;
        }

        /* --- ×¡×¨×’×œ ×¦×“ --- */
        .sidebar {
            background: var(--dark); border-left: 1px solid var(--border);
            padding: 20px; overflow-y: auto; display: flex; flex-direction: column;
        }
        .user-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; background: #1a1a1a; margin-bottom: 5px; border-radius: 8px; font-size: 13px;
        }

        /* --- ×ª×•×›×Ÿ ×¨××©×™ --- */
        .main-content {
            background: var(--panel);
            position: relative;
            overflow-y: auto;
            padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        .search-container {
            width: 100%; max-width: 600px; margin-bottom: 20px; position: relative;
        }
        .search-input {
            width: 100%; padding: 12px 40px 12px 15px; background: #2a2a2a; border: none; border-radius: 30px; color: white; outline: none;
        }
        .search-icon { position: absolute; right: 15px; top: 12px; color: #aaa; }

        .video-wrapper {
            width: 100%; max-width: 800px; aspect-ratio: 16/9;
            background: black; border-radius: 12px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        iframe { width: 100%; height: 100%; border: none; }

        .results-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px;
            width: 100%; max-width: 900px; margin-top: 20px; padding-bottom: 20px;
        }
        .video-card { cursor: pointer; transition: 0.2s; background: #1a1a1a; padding: 8px; border-radius: 8px; }
        .video-card:hover { background: #252525; }
        .card-img { width: 100%; border-radius: 6px; aspect-ratio: 16/9; object-fit: cover; }
        .card-title { font-size: 12px; margin-top: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* ×›×¤×ª×•×¨ ×˜×¢×Ÿ ×¢×•×“ */
        .load-more-container {
            width: 100%; max-width: 900px; text-align: center; padding-bottom: 50px;
        }
        .btn-load-more {
            background: #333; color: white; border: 1px solid #555; padding: 10px 30px; border-radius: 20px; cursor: pointer;
        }
        .btn-load-more:hover { background: #444; border-color: white; }

        /* --- ×¦'××˜ --- */
        .chat-panel {
            background: var(--dark); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden;
            transition: width 0.3s ease;
        }
        body.chat-hidden .chat-panel { width: 0; padding: 0; border: none; }

        .chat-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { background: #2a2a2a; padding: 8px 12px; border-radius: 10px; font-size: 13px; align-self: flex-start; max-width: 90%; word-break: break-word; }
        .chat-input-area { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 5px; }
        
        /* --- × ×’×Ÿ ×ª×—×ª×•×Ÿ --- */
        .bottom-bar {
            grid-column: 1 / -1;
            background: #181818; border-top: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000;
        }

        .now-playing { display: flex; align-items: center; gap: 10px; width: 25%; overflow: hidden; }
        .np-info div { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .player-center { width: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; margin-top: 5px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #444; border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 12px; width: 12px; border-radius: 50%; background: white; cursor: pointer; -webkit-appearance: none; margin-top: -4px;
        }
        
        .controls { display: flex; gap: 20px; align-items: center; }
        .ctrl-btn { background: none; border: none; color: #b3b3b3; font-size: 20px; cursor: pointer; }
        .ctrl-btn.play { color: white; font-size: 35px; }

        .player-right { width: 25%; display: flex; justify-content: flex-end; gap: 15px; }

        /* --- ×”×ª×××” ×œ×˜×œ×¤×•×Ÿ --- */
        @media (max-width: 768px) {
            #appScreen {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 120px; 
                display: flex; flex-direction: column;
            }

            .sidebar { display: none; } 
            
            .main-content { padding: 10px; height: 60%; }
            .video-wrapper { position: sticky; top: 0; z-index: 10; margin-bottom: 10px; }

            .chat-panel { 
                height: 40%; border-top: 1px solid var(--border); border-right: none;
            }
            body.chat-hidden .chat-panel { height: 0; }

            .bottom-bar {
                height: 80px; padding: 0 10px;
                position: fixed; bottom: 0; left: 0; width: 100%;
                background: rgba(24, 24, 24, 0.95);
                backdrop-filter: blur(10px);
            }
            
            .now-playing { display: none; } 
            .player-center { width: 100%; }
            .player-right { position: absolute; right: 10px; top: 15px; width: auto; }
            .toggle-chat-btn { color: var(--primary); }
        }

        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px;
            font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }

    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <!-- ×›× ×™×¡×” -->
    <div id="loginScreen">
        <h1 style="color:white; font-size: 35px; margin-bottom: 20px;">You<span style="color:var(--primary)">Sync</span></h1>
        <div class="login-card">
            <input type="text" id="usernameInput" class="auth-input" placeholder="×©× ××©×ª××©">
            <button class="btn-grad" onclick="createRoom()">×¦×•×¨ ×—×“×¨</button>
            <p style="margin: 10px 0; color: #777;">××•</p>
            <input type="number" id="roomInput" class="auth-input" placeholder="×§×•×“ ×—×“×¨">
            <button class="btn-grad" style="background: #333; color: white;" onclick="joinRoom()">×”×¦×˜×¨×£</button>
        </div>
    </div>

    <!-- ××¤×œ×™×§×¦×™×” -->
    <div id="appScreen" style="display:none;">
        
        <div class="sidebar">
            <h3 style="color:var(--primary); margin-top:0;">×—×“×¨: <span id="roomCodeDisplay"></span></h3>
            <div id="usersList"></div>
        </div>

        <div class="main-content">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="×—×¤×© ×©×™×¨...">
                <i class="fas fa-search search-icon"></i>
            </div>

            <div class="video-wrapper">
                <div id="player"></div>
            </div>

            <div class="results-header">
                <h3 style="margin:0;">ğŸ”¥ ×œ×”×™×˜×™× ×—××™×</h3>
                <button onclick="loadHomePage()" style="background:none; border:none; color:var(--primary); cursor:pointer;">ğŸ”„ ×¨×¢× ×Ÿ</button>
            </div>
            <div id="resultsGrid" class="results-grid"></div>
            
            <!-- ×›×¤×ª×•×¨ ××™× ×¡×•×£ ×©×™×¨×™× -->
            <div class="load-more-container">
                <button class="btn-load-more" onclick="loadMoreVideos()">â¬‡ ×˜×¢×Ÿ ×¢×•×“ ×©×™×¨×™×</button>
            </div>
        </div>

        <div class="chat-panel">
            <div class="chat-header">
                <span>ğŸ’¬ ×¦'××˜</span>
                <span style="font-size:12px; color:#aaa;">××—×•×‘×¨×™×: <span id="userCount">0</span></span>
            </div>
            <div id="chatMessages" class="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" style="flex:1; background:#333; border:none; color:white; padding:8px; border-radius:20px; outline:none;" placeholder="×”×•×“×¢×”...">
                <button onclick="sendMessage()" style="background:var(--primary); border:none; border-radius:50%; width:32px; height:32px;">â¤</button>
            </div>
        </div>

        <div class="bottom-bar">
            <div class="now-playing">
                <img id="npThumb" src="https://via.placeholder.com/50" style="width:40px; height:40px; border-radius:4px;">
                <div class="np-info">
                    <div id="npTitle" style="font-size:13px; font-weight:bold;">×œ× ×× ×’×Ÿ</div>
                    <div style="font-size:11px; color:#aaa;">YouSync</div>
                </div>
            </div>

            <div class="player-center">
                <div class="controls">
                    <button class="ctrl-btn" onclick="sendReaction('ğŸ”¥')">ğŸ”¥</button>
                    <button class="ctrl-btn play" onclick="togglePlay()"><i class="fas fa-play" id="playIcon"></i></button>
                    <button class="ctrl-btn" onclick="sendReaction('â¤ï¸')">â¤ï¸</button>
                </div>
                <div style="width:100%; display:flex; align-items:center; gap:10px; font-size:11px; color:#aaa;">
                    <span id="currTime">0:00</span>
                    <input type="range" id="seekBar" value="0" min="0" max="100" step="1" oninput="onSeekInput()" onchange="onSeekChange()">
                    <span id="durTime">0:00</span>
                </div>
            </div>

            <div class="player-right">
                <button class="ctrl-btn toggle-chat-btn" onclick="toggleChat()" title="×”×¡×ª×¨/×”×¦×’ ×¦'××˜">
                    <i class="fas fa-comment-alt"></i>
                </button>
                <button class="ctrl-btn" id="dlBtn" onclick="downloadCurrent()" title="×”×•×¨×“×”">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>

    </div>

    <script>
        const RAPID_API_KEY = 'efb1ed4f48msh5dfd6650699ded0p1f5775jsn2c2c0eb8bbb3';
        const RAPID_API_HOST = 'youtube-mp36.p.rapidapi.com'; 
        const YOUTUBE_API_KEY = 'AIzaSyAuLutPPSJlZJKkfBrzRNURSibcqkeeA60';

        const firebaseConfig = {
            apiKey: "AIzaSyDKN3qgnvUP4SZX9aOAaThnDI4vUjjVw9A",
            authDomain: "musicsync-58d86.firebaseapp.com",
            projectId: "musicsync-58d86",
            databaseURL: "https://musicsync-58d86-default-rtdb.firebaseio.com"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e){}
        const db = firebase.database();

        let player, isSyncing = false, currentRoom = null, myName = "", myKey = "";
        let isDragging = false; 
        let currentVideoId = "";
        
        // ××©×ª× ×™× ×œ××™× ×¡×•×£ ×©×™×¨×™×
        let nextPageToken = "";
        let currentSearchQuery = "×œ×”×™×˜×™× ×™×©×¨××œ×™× 2025";

        // --- ×‘×“×™×§×ª URL ×‘×›× ×™×¡×” (Deep Linking) ---
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const roomParam = params.get('room');
            if (roomParam) {
                document.getElementById('roomInput').value = roomParam;
            }
        };

        // --- Keyboard Controls ---
        document.addEventListener('keydown', function(event) {
            if (document.activeElement.tagName === 'INPUT') return;
            const code = event.code;
            if (code === 'Space') {
                event.preventDefault(); togglePlay();
                showToast(player && player.getPlayerState() === 1 ? 'â¸ ×”×•×©×”×”' : 'â–¶ ×× ×’×Ÿ');
            }
            else if (code === 'ArrowRight') { event.preventDefault(); seekRelative(10); showToast('â© +10 ×©× ×™×•×ª'); }
            else if (code === 'ArrowLeft') { event.preventDefault(); seekRelative(-10); showToast('âª -10 ×©× ×™×•×ª'); }
            else if (code === 'ArrowUp') { event.preventDefault(); changeVolume(10); }
            else if (code === 'ArrowDown') { event.preventDefault(); changeVolume(-10); }
            else if (code === 'KeyM') { if(player) { if(player.isMuted()) { player.unMute(); showToast('ğŸ”Š ×¡××•× ×“'); } else { player.mute(); showToast('ğŸ”‡ ××•×©×ª×§'); } } }
        });

        function seekRelative(seconds) {
            if(!player) return;
            const newTime = player.getCurrentTime() + seconds;
            player.seekTo(newTime);
            db.ref(`rooms/${currentRoom}/current_song`).update({ timestamp: newTime, status: 1 });
        }

        function changeVolume(amount) {
            if(!player) return;
            const newVol = player.getVolume() + amount;
            player.setVolume(newVol);
            showToast(`ğŸ”Š ×•×•×œ×™×•×: ${newVol}%`);
        }

        function showToast(text) {
            const t = document.getElementById('toast');
            t.innerText = text; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }

        // --- ×›× ×™×¡×” ×œ×—×“×¨ ---
        function createRoom() {
            myName = document.getElementById('usernameInput').value || "Admin";
            enterRoom(Math.floor(1000 + Math.random() * 9000));
        }
        function joinRoom() {
            myName = document.getElementById('usernameInput').value || "Guest";
            const code = document.getElementById('roomInput').value;
            if(code) enterRoom(code);
        }

        function enterRoom(code) {
            currentRoom = code;
            
            // ×¢×“×›×•×Ÿ ×”-URL ×›×“×™ ×©×™×”×™×” ××¤×©×¨ ×œ×©×ª×£
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + code;
            window.history.pushState({path:newUrl},'',newUrl);

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = (window.innerWidth > 768) ? 'grid' : 'flex';
            document.getElementById('roomCodeDisplay').innerText = code;

            loadYoutubePlayer();
            loadHomePage(); 

            const userRef = db.ref(`rooms/${code}/users`).push();
            myKey = userRef.key;
            userRef.set({ name: myName });
            userRef.onDisconnect().remove();

            setupListeners();
        }

        function setupListeners() {
            db.ref(`rooms/${currentRoom}/users`).on('value', snap => {
                const list = document.getElementById('usersList');
                if(list) list.innerHTML = "";
                if(list) {
                    snap.forEach(child => {
                        list.innerHTML += `<div class="user-row"><i class="fas fa-user"></i> ${child.val().name}</div>`;
                    });
                }
            });

            db.ref(`rooms/${currentRoom}/current_song`).on('value', snap => {
                const data = snap.val();
                if (!data) return;
                
                document.getElementById('npTitle').innerText = data.title;
                document.getElementById('npThumb').src = data.thumbnail || "https://via.placeholder.com/50";
                currentVideoId = data.videoId;

                if (player && player.loadVideoById && player.getVideoData().video_id !== data.videoId) {
                    isSyncing = true;
                    player.loadVideoById(data.videoId);
                    setTimeout(() => isSyncing = false, 1500);
                }

                const icon = document.getElementById('playIcon');
                if (data.status === 1) {
                    icon.className = "fas fa-pause";
                    if (player && player.playVideo && player.getPlayerState() !== 1) player.playVideo();
                } else {
                    icon.className = "fas fa-play";
                    if (player && player.pauseVideo && player.getPlayerState() !== 2) player.pauseVideo();
                }

                if (player && player.getCurrentTime && !isDragging) {
                     const diff = Math.abs(player.getCurrentTime() - (data.timestamp || 0));
                     if (diff > 2 && data.status === 1) {
                         player.seekTo(data.timestamp);
                     }
                }
            });

            db.ref(`rooms/${currentRoom}/chat`).limitToLast(20).on('child_added', snap => {
                const msg = snap.val();
                const div = document.getElementById('chatMessages');
                div.innerHTML += `<div class="msg"><strong>${msg.user}</strong>${msg.text}</div>`;
                div.scrollTop = div.scrollHeight;
            });
            
            db.ref(`rooms/${currentRoom}/reactions`).on('child_added', snap => {
                 showEmoji(snap.val().emoji);
                 snap.ref.remove();
            });
        }

        function toggleChat() {
            document.body.classList.toggle('chat-hidden');
        }

        function loadYoutubePlayer() {
            if (typeof YT !== 'undefined' && YT.Player) onYouTubeIframeAPIReady();
            else {
                var tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '', 
                host: 'https://www.youtube-nocookie.com',
                playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0, 'modestbranding': 1, 'playsinline': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
            setInterval(updateSeekBar, 1000); 
        }

        function onPlayerStateChange(event) {
            if (isSyncing || !currentRoom) return;
            if (event.data === 1 || event.data === 2) {
                db.ref(`rooms/${currentRoom}/current_song`).update({ status: event.data });
            }
        }

        function togglePlay() {
            if(!player) return;
            const state = player.getPlayerState();
            const newStatus = (state === 1) ? 2 : 1;
            db.ref(`rooms/${currentRoom}/current_song`).update({ 
                status: newStatus,
                timestamp: player.getCurrentTime()
            });
        }

        // --- ×˜×¢×™× ×ª ×©×™×¨×™× ×•"××™× ×¡×•×£" ---
        async function loadHomePage() {
            currentSearchQuery = "×œ×”×™×˜×™× ×™×©×¨××œ×™× 2025";
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '<p style="text-align:center; width:100%; color:#aaa;">×˜×•×¢×Ÿ...</p>';
            
            // ×—×™×¤×•×© ×¨××©×•× ×™
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=20&q=${encodeURIComponent(currentSearchQuery)}&key=${YOUTUBE_API_KEY}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                nextPageToken = data.nextPageToken || ""; // ×©××™×¨×ª ×”×˜×•×§×Ÿ ×œ×¢××•×“ ×”×‘×
                
                grid.innerHTML = "";
                if(data.items) renderGrid(data.items);
            } catch(e) { console.error(e); }
        }

        // ×¤×•× ×§×¦×™×™×ª ×˜×¢×Ÿ ×¢×•×“ (Infinite Scroll)
        async function loadMoreVideos() {
            if(!nextPageToken) return alert("××™×Ÿ ×¢×•×“ ×ª×•×¦××•×ª ×›×¨×’×¢");
            
            const btn = document.querySelector('.btn-load-more');
            btn.innerText = "×˜×•×¢×Ÿ...";
            
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=20&q=${encodeURIComponent(currentSearchQuery)}&pageToken=${nextPageToken}&key=${YOUTUBE_API_KEY}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                nextPageToken = data.nextPageToken || ""; // ×¢×“×›×•×Ÿ ×”×˜×•×§×Ÿ
                
                if(data.items) renderGrid(data.items); // ×”×•×¡×¤×” ×œ×’×¨×™×“ ×”×§×™×™× (×œ× ××•×—×§)
            } catch(e) { console.error(e); }
            finally { btn.innerText = "â¬‡ ×˜×¢×Ÿ ×¢×•×“ ×©×™×¨×™×"; }
        }

        function renderGrid(videos) {
            const grid = document.getElementById('resultsGrid');
            videos.forEach(item => {
                const div = document.createElement('div');
                div.className = 'video-card';
                div.onclick = () => playVideo(item.id.videoId, item.snippet.title, item.snippet.thumbnails.medium.url);
                div.innerHTML = `
                    <img src="${item.snippet.thumbnails.medium.url}" class="card-img">
                    <div class="card-title">${item.snippet.title}</div>
                    <div class="card-artist">${item.snippet.channelTitle}</div>
                `;
                grid.appendChild(div);
            });
        }

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadSearchResults(e.target.value);
        });

        async function loadSearchResults(query) {
            currentSearchQuery = query;
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '<p>××—×¤×©...</p>';
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=20&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                nextPageToken = data.nextPageToken || "";
                grid.innerHTML = "";
                if(data.items) renderGrid(data.items);
            } catch(e) { console.error(e); }
        }

        function updateSeekBar() {
            if (!player || !player.getCurrentTime || isDragging) return;
            
            const curr = player.getCurrentTime();
            const dur = player.getDuration();
            
            if (dur > 0) {
                document.getElementById('seekBar').value = (curr / dur) * 100;
                document.getElementById('currTime').innerText = formatTime(curr);
                document.getElementById('durTime').innerText = formatTime(dur);
                const val = (curr / dur) * 100;
                document.getElementById('seekBar').style.background = `linear-gradient(to right, #1DB954 0%, #1DB954 ${val}%, #444 ${val}%, #444 100%)`;
            }
        }

        function onSeekInput() {
            isDragging = true;
            const val = document.getElementById('seekBar').value;
            const dur = player.getDuration();
            document.getElementById('currTime').innerText = formatTime((val / 100) * dur);
        }

        function onSeekChange() {
            isDragging = false;
            const val = document.getElementById('seekBar').value;
            const dur = player.getDuration();
            const newTime = (val / 100) * dur;
            
            player.seekTo(newTime);
            db.ref(`rooms/${currentRoom}/current_song`).update({
                timestamp: newTime,
                status: 1 
            });
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0'+sec : sec}`;
        }

        function playVideo(id, title, thumb) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            db.ref(`rooms/${currentRoom}/current_song`).set({
                videoId: id, title: title, thumbnail: thumb, status: 1, timestamp: 0
            });
        }

        function sendMessage() {
            const txt = document.getElementById('chatInput').value;
            if(txt) {
                db.ref(`rooms/${currentRoom}/chat`).push({ user: myName, text: txt });
                document.getElementById('chatInput').value = "";
            }
        }

        function sendReaction(emoji) {
            db.ref(`rooms/${currentRoom}/reactions`).push({ emoji: emoji });
        }

        function showEmoji(emoji) {
            const el = document.createElement('div');
            el.innerText = emoji;
            el.style.position = 'fixed';
            el.style.left = Math.random() * 80 + 10 + '%';
            el.style.bottom = '100px';
            el.style.fontSize = '40px';
            el.style.animation = 'floatUp 2s ease-out forwards';
            el.style.zIndex = '9999';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }
        
        const style = document.createElement('style');
        style.innerHTML = `@keyframes floatUp { 0% { opacity: 0; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-250px); } }`;
        document.head.appendChild(style);

        // --- ×¤×•× ×§×¦×™×™×ª ×”×•×¨×“×” ×¢× ×’×™×‘×•×™ ---
        async function downloadCurrent() {
            if(!currentVideoId) return alert("××™×Ÿ ×©×™×¨ ×× ×’×Ÿ");

            const btn = document.getElementById('dlBtn');
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const url = `https://${RAPID_API_HOST}/dl?id=${currentVideoId}`;
            const options = { method: 'GET', headers: { 'X-RapidAPI-Key': RAPID_API_KEY, 'X-RapidAPI-Host': RAPID_API_HOST } };
            
            try {
                const res = await fetch(url, options);
                const data = await res.json();
                if(data.link) {
                    window.location.href = data.link;
                } else if(data.url) {
                    window.location.href = data.url;
                } else {
                    throw new Error("API Limit");
                }
            } catch(e) {
                if(confirm("×”××¤×ª×— ×”×—×™× ××™ ×”×’×™×¢ ×œ××›×¡×”. ×œ×¢×‘×•×¨ ×œ×”×•×¨×“×” ×™×©×™×¨×”?")) {
                    window.open(`https://tomp3.cc/youtube-downloader/${currentVideoId}`, '_blank');
                }
            } finally {
                btn.innerHTML = originalIcon;
            }
        }

    </script>
</body>
</html>
