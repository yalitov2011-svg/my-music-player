<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouSync - ×”× ×’×Ÿ ×”××©×•×ª×£</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- ×¢×™×¦×•×‘ ×“××•×™ ×™×•×˜×™×•×‘ --- */
        body { 
            background-color: #0f0f0f; 
            color: white; 
            font-family: 'Roboto', Arial, sans-serif; 
            margin: 0; padding: 0;
            overflow-x: hidden;
        }

        /* ×¡×¨×’×œ ×¢×œ×™×•×Ÿ */
        .navbar {
            background: #0f0f0f;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #2a2a2a;
        }

        .logo { font-size: 20px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .logo span { color: #FF0000; } /* ××“×•× ×™×•×˜×™×•×‘ */

        /* ×ª×™×‘×ª ×—×™×¤×•×© */
        .search-container {
            display: flex;
            flex-grow: 1;
            max-width: 600px;
            margin: 0 20px;
        }
        
        input { 
            background: #121212;
            border: 1px solid #303030;
            color: white;
            padding: 10px 15px;
            border-radius: 40px 0 0 40px;
            width: 100%;
            font-size: 16px;
            outline: none;
        }
        input:focus { border-color: #1c62b9; }

        .search-btn {
            background: #222;
            border: 1px solid #303030;
            border-left: none;
            padding: 0 20px;
            border-radius: 0 40px 40px 0;
            color: gray;
            cursor: pointer;
        }
        .search-btn:hover { background: #303030; }

        /* ××¡×š ×›× ×™×¡×” */
        #loginScreen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 80vh; gap: 20px;
        }
        .login-box {
            background: #1e1e1e; padding: 40px; border-radius: 10px; width: 300px; text-align: center;
        }
        .btn-primary {
            background: #3ea6ff; color: black; border: none; padding: 10px 20px; 
            border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 10px; width: 100%;
        }

        /* ××–×•×¨ ×”× ×’×Ÿ */
        #playerScreen { display: none; padding: 20px; }
        
        .player-container {
            width: 100%; max-width: 900px; margin: 0 auto 20px auto;
            aspect-ratio: 16/9; background: black;
        }
        iframe { width: 100%; height: 100%; border: none; }

        /* --- ×”×’×œ×¨×™×” (×”×××’×¨) --- */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .video-card {
            background: transparent;
            cursor: pointer;
            transition: 0.2s;
        }
        .video-card:hover { transform: scale(1.02); }

        .thumbnail {
            width: 100%;
            border-radius: 12px;
            aspect-ratio: 16/9;
            object-fit: cover;
            background: #222;
        }

        .video-info { padding: 10px 5px; text-align: right; }
        .video-title { font-size: 14px; font-weight: bold; margin-bottom: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .channel-name { font-size: 12px; color: #aaa; }

        /* ×›×•×ª×¨×ª ×§×˜×’×•×¨×™×” */
        .section-title {
            text-align: right; margin-right: 5%; font-size: 20px; font-weight: bold; margin-top: 10px;
        }

        /* ×‘×× ×¨ ×¡×˜×˜×•×¡ */
        .status-bar {
            background: #222; padding: 10px; border-radius: 8px; 
            margin: 0 auto 20px auto; max-width: 900px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” ××ª×—×ª ×œ× ×’×Ÿ */
        .action-row {
            display: flex; justify-content: center; gap: 10px; margin-bottom: 30px;
        }
        .btn-action {
            background: #222; border: none; color: white; padding: 8px 16px; 
            border-radius: 18px; cursor: pointer; font-size: 14px;
        }
        .btn-action:hover { background: #333; }

    </style>
</head>
<body>

    <div id="navbar" class="navbar" style="display: none;">
        <div class="logo">â–¶ <span>YouSync</span></div>
        <div class="search-container">
            <input type="text" id="searchQuery" placeholder="×—×™×¤×•×© ×©×™×¨×™×...">
            <button class="search-btn" onclick="searchVideos()">ğŸ”</button>
        </div>
        <div class="logo" style="font-size: 14px;">ğŸ‘¤ <span id="myNameDisplay"></span></div>
    </div>

    <div id="loginScreen">
        <h1 style="font-size: 40px;">YouSync</h1>
        <div class="login-box">
            <h3>×‘×¨×•×›×™× ×”×‘××™×</h3>
            <input type="text" id="usernameInput" placeholder="×”×©× ×©×œ×š" style="border-radius: 5px; margin-bottom: 10px;">
            <button class="btn-primary" onclick="createRoom()">×¦×•×¨ ×—×“×¨ ×—×“×©</button>
            <p>--- ××• ---</p>
            <input type="number" id="roomInput" placeholder="×§×•×“ ×—×“×¨" style="border-radius: 5px; margin-bottom: 10px;">
            <button class="btn-primary" style="background: #222; color: white;" onclick="joinRoom()">×”×¦×˜×¨×£ ×œ×—×“×¨</button>
        </div>
    </div>

    <div id="playerScreen">
        
        <div class="status-bar">
            <div>×—×“×¨: <span id="roomCodeDisplay" style="color: #3ea6ff;">---</span></div>
            <div id="statusText">×××ª×™×Ÿ ×œ×©×™×¨...</div>
            <div>ğŸ‘¥ <span id="connectedCount">0</span></div>
        </div>

        <div class="player-container">
            <div id="player"></div>
        </div>

        <div class="action-row">
            <button class="btn-action" onclick="addToFavorites()">â¤ï¸ ×©××•×¨ ×œ××•×¢×“×¤×™×</button>
            <button class="btn-action" onclick="downloadCurrent()">â¬‡ ×”×•×¨×“ (MP3)</button>
        </div>

        <hr style="border-color: #222; margin-bottom: 20px;">

        <h3 class="section-title" id="galleryTitle">ğŸ”¥ ×œ×”×™×˜×™× ×—××™× ×‘×™×©×¨××œ</h3>
        <div class="video-grid" id="videoGrid">
            <p style="text-align: center; width: 100%;">×˜×•×¢×Ÿ...</p>
        </div>

    </div>

    <script>
        const RAPID_API_KEY = 'efb1ed4f48msh5dfd6650699ded0p1f5775jsn2c2c0eb8bbb3';
        const RAPID_API_HOST = 'youtube-mp36.p.rapidapi.com'; 

        const firebaseConfig = {
            apiKey: "AIzaSyDKN3qgnvUP4SZX9aOAaThnDI4vUjjVw9A",
            authDomain: "musicsync-58d86.firebaseapp.com",
            projectId: "musicsync-58d86",
            databaseURL: "https://musicsync-58d86-default-rtdb.firebaseio.com"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e){}
        const db = firebase.database();
        const YOUTUBE_API_KEY = 'AIzaSyAuLutPPSJlZJKkfBrzRNURSibcqkeeA60'; 

        let player, isSyncing = false, currentRoom = null, myName = "";
        let currentVideoId = "";

        // --- ×›× ×™×¡×” ---
        function createRoom() {
            myName = document.getElementById('usernameInput').value || "××•×¨×—";
            enterRoom(Math.floor(1000 + Math.random() * 9000));
        }
        function joinRoom() {
            myName = document.getElementById('usernameInput').value || "××•×¨×—";
            const code = document.getElementById('roomInput').value;
            if(code) enterRoom(code);
        }

        function enterRoom(code) {
            currentRoom = code;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('navbar').style.display = 'flex';
            document.getElementById('playerScreen').style.display = 'block';
            document.getElementById('roomCodeDisplay').innerText = code;
            document.getElementById('myNameDisplay').innerText = myName;
            
            loadYoutubePlayer();
            loadHomePage(); // ×˜×¢×™× ×ª ×”×××’×¨ ×”×¨××©×•× ×™

            // ×—×™×‘×•×¨ ××©×ª××©×™×
            const userRef = db.ref(`rooms/${code}/users`).push();
            userRef.set({ name: myName });
            userRef.onDisconnect().remove();
            db.ref(`rooms/${code}/users`).on('value', snap => {
                document.getElementById('connectedCount').innerText = snap.numChildren();
            });

            // ×”××–× ×” ×œ×©×™×¨ ×× ×’×Ÿ
            db.ref(`rooms/${currentRoom}/current_song`).on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                document.getElementById('statusText').innerText = `ğŸµ ${data.title}`;
                currentVideoId = data.videoId;
                if (player && player.loadVideoById && player.getVideoData().video_id !== data.videoId) {
                    isSyncing = true;
                    player.loadVideoById(data.videoId);
                    setTimeout(() => isSyncing = false, 1500);
                }
            });
        }

        // --- ×˜×¢×™× ×ª ×“×£ ×”×‘×™×ª (×××’×¨) ---
        async function loadHomePage() {
            document.getElementById('galleryTitle').innerText = "ğŸ”¥ ×œ×”×™×˜×™× ×—××™× ×‘×™×©×¨××œ";
            // ×—×™×¤×•×© ×›×œ×œ×™ ×©×œ ×©×™×¨×™× ×¤×•×¤×•×œ×¨×™×™× ×‘×¢×‘×¨×™×ª
            await fetchAndRenderVideos("×œ×”×™×˜×™× ×™×©×¨××œ×™× ×—×“×©×™× 2024 2025");
        }

        // --- ×—×™×¤×•×© ×–××¨/×©×™×¨ ---
        async function searchVideos() {
            const query = document.getElementById('searchQuery').value;
            if (!query) return;
            document.getElementById('galleryTitle').innerText = `ğŸ” ×ª×•×¦××•×ª ×¢×‘×•×¨: "${query}"`;
            await fetchAndRenderVideos(query);
        }
        
        // ×œ×—×™×¦×” ×¢×œ ×× ×˜×¨ ×‘×—×™×¤×•×©
        document.getElementById('searchQuery').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchVideos();
        });

        // --- ×× ×•×¢ ×”×—×™×¤×•×© ×•×”×ª×¦×•×’×” (×”×œ×‘ ×©×œ ×”××¢×¨×›×ª) ---
        async function fetchAndRenderVideos(query) {
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = '<p style="text-align:center; width:100%;">××—×¤×© ×©×™×¨×™×...</p>';

            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=24&q=${encodeURIComponent(query)}&videoEmbeddable=true&key=${YOUTUBE_API_KEY}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                
                grid.innerHTML = ""; // × ×™×§×•×™
                
                if (!data.items || data.items.length === 0) {
                    grid.innerHTML = "<p>×œ× × ××¦××• ×©×™×¨×™×.</p>";
                    return;
                }

                // ×™×¦×™×¨×ª ×”×›×¨×˜×™×¡×™×•×ª
                data.items.forEach(item => {
                    const videoId = item.id.videoId;
                    const title = item.snippet.title;
                    const thumbnail = item.snippet.thumbnails.medium.url;
                    const channel = item.snippet.channelTitle;

                    const card = document.createElement('div');
                    card.className = 'video-card';
                    card.onclick = () => playSelectedVideo(videoId, title); // ×œ×—×™×¦×” ×× ×’× ×ª

                    card.innerHTML = `
                        <img src="${thumbnail}" class="thumbnail">
                        <div class="video-info">
                            <div class="video-title">${title}</div>
                            <div class="channel-name">${channel}</div>
                        </div>
                    `;
                    grid.appendChild(card);
                });

            } catch (e) {
                console.error(e);
                grid.innerHTML = "<p>×©×’×™××” ×‘×˜×¢×™× ×ª ×©×™×¨×™×.</p>";
            }
        }

        // --- ×©×œ×™×—×ª ×”×¤×§×•×“×” ×œ× ×’×Ÿ (Firebase) ---
        function playSelectedVideo(videoId, title) {
            // ×’×œ×™×œ×” ×œ××¢×œ×” ×œ× ×’×Ÿ
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            db.ref(`rooms/${currentRoom}/current_song`).set({
                videoId: videoId,
                title: title,
                status: 1
            });
        }

        // --- × ×’×Ÿ ×™×•×˜×™×•×‘ ---
        function loadYoutubePlayer() {
            if (typeof YT !== 'undefined' && YT.Player) onYouTubeIframeAPIReady();
            else {
                var tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '', 
                host: 'https://www.youtube-nocookie.com',
                playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0, 'modestbranding': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(event) {
            // ×¡× ×›×¨×•×Ÿ Pause/Play
            if (!isSyncing && currentRoom && (event.data === 1 || event.data === 2)) {
               // ××•×¤×¦×™×•× ×œ×™: ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ ×¡× ×›×¨×•×Ÿ ××¦×‘
            }
        }

        // --- ×”×•×¨×“×” ×•××•×¢×“×¤×™× ---
        async function downloadCurrent() {
            if(!currentVideoId) return alert("××™×Ÿ ×©×™×¨ ×× ×’×Ÿ");
            const url = `https://${RAPID_API_HOST}/dl?id=${currentVideoId}`;
            const options = { method: 'GET', headers: { 'X-RapidAPI-Key': RAPID_API_KEY, 'X-RapidAPI-Host': RAPID_API_HOST } };
            try {
                const res = await fetch(url, options);
                const data = await res.json();
                if(data.link) window.location.href = data.link;
                else alert("×”×•×¨×“×” × ×›×©×œ×”");
            } catch(e) { alert("×©×’×™××” ×‘×”×•×¨×“×”"); }
        }

        function addToFavorites() {
            alert("×”×©×™×¨ × ×©××¨ ×‘××•×¢×“×¤×™×! (×¤×™×¦'×¨ ×‘×¤×™×ª×•×—)");
        }

    </script>
</body>
</html>
