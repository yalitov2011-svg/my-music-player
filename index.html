<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YouSync V27 - Fixed & Mobile</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- ××™×™×§×•× ×™× -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #1DB954;
            --dark: #000000;
            --panel: #121212;
            --border: #282828;
            --text: #ffffff;
            --msg-bg: rgba(255,255,255,0.1);
        }

        /* ××¦×‘ ×‘×”×™×¨ */
        body.light-mode {
            --dark: #f0f2f5;
            --panel: #ffffff;
            --border: #ccc;
            --text: #000000;
            --msg-bg: #e4e6eb;
        }
        body.light-mode .main-content, body.light-mode .sidebar, body.light-mode .chat-panel, body.light-mode .bottom-bar {
            background: var(--panel); color: var(--text);
        }
        body.light-mode .video-card { background: #f9f9f9; border: 1px solid #ddd; }
        body.light-mode .search-input { background: #e4e6eb; color: black; }
        body.light-mode .chat-header, body.light-mode .chat-input-area { background: #f0f2f5; }
        body.light-mode #chatInput { background: white; color: black; border: 1px solid #ccc; }

        /* × ×™×’×•×“×™×•×ª ×’×‘×•×”×” (Fixed) */
        body.high-contrast {
            --primary: #FFFF00 !important; /* ×¦×”×•×‘ */
            --dark: #000 !important;
            --panel: #000 !important;
            --border: #FFF !important;
            --text: #FFF !important;
            --msg-bg: #333 !important;
        }
        body.high-contrast * { border-color: white !important; }
        body.high-contrast .video-card, body.high-contrast .bottom-bar, body.high-contrast .sidebar { background: #000 !important; border: 1px solid white !important; }
        body.high-contrast .msg { background: #000 !important; border: 1px solid yellow !important; color: yellow !important; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            background-color: var(--dark);
            color: var(--text);
            font-family: 'Segoe UI', system-ui, sans-serif; 
            margin: 0; padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- ××¡×š ×›× ×™×¡×” --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1e1e1e, #000);
            z-index: 3000;
        }
        .login-card {
            background: rgba(30,30,30,0.8); backdrop-filter: blur(10px);
            padding: 30px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        input.auth-input {
            width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid #333; 
            background: rgba(0,0,0,0.5); color: white; outline: none; text-align: center; font-size: 16px;
        }
        .btn-grad {
            background: linear-gradient(135deg, var(--primary), #1aa34a); 
            border: none; color: black; font-weight: 700; padding: 15px; width: 100%; border-radius: 12px;
            cursor: pointer; font-size: 16px; margin-top: 10px;
        }

        /* --- ××‘× ×” ×”××¤×œ×™×§×¦×™×” --- */
        #appScreen {
            display: none;
            flex: 1;
            height: 100%;
            width: 100%;
            position: relative;
            grid-template-columns: 260px 1fr 320px; 
            grid-template-rows: 1fr 90px;
        }

        /* --- ×¦×“ ×™××™×Ÿ (×ª×¤×¨×™×˜) --- */
        .sidebar {
            background: var(--dark); border-left: 1px solid var(--border);
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
        }
        .brand { font-size: 22px; font-weight: 800; color: var(--text); margin-bottom: 10px; }
        .brand span { color: var(--primary); }
        
        .nav-btn {
            background: transparent; border: none; color: #b3b3b3; text-align: right; font-size: 15px;
            padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-radius: 8px;
            font-weight: 600; transition: 0.2s;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }

        .user-list-container { flex: 1; overflow-y: auto; }
        .user-row { padding: 8px; font-size: 14px; color: #ddd; display: flex; align-items: center; gap: 8px;}

        /* --- ××¨×›×– (×ª×•×›×Ÿ) --- */
        .main-content {
            background: linear-gradient(180deg, #1a1a1a 0%, var(--panel) 40%);
            position: relative; 
            overflow-y: auto; 
            padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            grid-column: 2;
        }

        .ambiance-glow {
            position: absolute; top: 0; left: 0; width: 100%; height: 300px;
            background: radial-gradient(circle at top, var(--primary), transparent 70%);
            opacity: 0.15; pointer-events: none; transition: opacity 0.5s;
        }

        /* ×›×¤×ª×•×¨ ×”×’×“×¨×•×ª ×‘×˜×œ×¤×•×Ÿ (×—×“×©!) */
        .mobile-settings-icon {
            display: none; position: absolute; left: 20px; top: 20px; font-size: 24px; color: var(--text); cursor: pointer; z-index: 20;
        }

        .search-container { width: 100%; max-width: 600px; margin-bottom: 20px; position: relative; z-index: 10; margin-top: 10px; }
        .search-input {
            width: 100%; padding: 12px 40px 12px 15px; background: rgba(255,255,255,0.1); border: none; 
            border-radius: 50px; color: var(--text); outline: none; font-size: 16px;
        }
        .search-icon { position: absolute; right: 15px; top: 12px; color: #888; }

        .video-wrapper {
            width: 100%; max-width: 800px; aspect-ratio: 16/9;
            background: black; border-radius: 12px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 5; margin-bottom: 20px;
        }
        iframe { width: 100%; height: 100%; border: none; }

        .results-header { width: 100%; max-width: 900px; display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
        .results-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;
            width: 100%; max-width: 900px; padding-bottom: 120px;
        }
        .video-card { background: #181818; padding: 10px; border-radius: 10px; cursor: pointer; }
        .card-img { width: 100%; border-radius: 6px; aspect-ratio: 16/9; object-fit: cover; }
        .card-title { font-size: 13px; font-weight: 600; margin-top: 8px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; color:var(--text); }

        .load-more-btn {
            background: #333; color: white; border: none; padding: 10px 25px; border-radius: 20px; margin-top: 20px;
        }

        /* --- ×¦'××˜ --- */
        .chat-panel {
            background: var(--dark); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden;
            grid-column: 3;
        }
        body.chat-hidden #appScreen { grid-template-columns: 260px 1fr 0px; }

        .chat-header { padding: 15px; background: rgba(0,0,0,0.2); font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; background: rgba(0,0,0,0.1); }
        .msg { background: var(--msg-bg); padding: 8px 12px; border-radius: 10px; font-size: 13px; max-width: 85%; align-self: flex-start; }
        .msg strong { color: var(--primary); display: block; font-size: 11px; }
        .chat-timestamp { font-size: 10px; color: #888; float: left; margin-right: 5px; margin-top: 2px; display: none; }
        body.show-chat-time .chat-timestamp { display: inline; }

        .chat-input-area { padding: 10px; display: flex; gap: 8px; background: rgba(0,0,0,0.2); border-top: 1px solid var(--border); }
        #chatInput { flex: 1; background: rgba(255,255,255,0.1); border: none; padding: 10px; border-radius: 20px; color: var(--text); outline: none; }
        .mobile-close-chat { display: none; background: none; border: none; color: white; font-size: 20px; }

        /* --- × ×’×Ÿ ×ª×—×ª×•×Ÿ --- */
        .bottom-bar {
            grid-column: 1 / -1; grid-row: 2;
            background: #181818; border-top: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000;
        }

        .now-playing { display: flex; align-items: center; gap: 12px; width: 25%; }
        .np-thumb { width: 50px; height: 50px; border-radius: 4px; }
        .np-info div { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }

        .player-center { width: 40%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .controls { display: flex; gap: 20px; align-items: center; margin-bottom: 5px; }
        .ctrl-btn { background: none; border: none; color: #bbb; font-size: 20px; cursor: pointer; }
        .ctrl-btn.play { color: white; font-size: 32px; background: #333; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; }
        
        .progress-container { width: 100%; display: flex; align-items: center; gap: 8px; font-size: 11px; color: #aaa; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; height: 5px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: white; margin-top: -4px; }

        .player-right { width: 25%; display: flex; justify-content: flex-end; gap: 15px; }

        /* --- ×—×œ×•×Ÿ ×”×’×“×¨×•×ª --- */
        #settingsModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 4000; align-items: center; justify-content: center;
        }
        .settings-content {
            background: #222; padding: 0; border-radius: 16px; width: 95%; max-width: 500px; height: 85vh;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); display: flex; flex-direction: column; overflow: hidden;
        }
        .settings-header { padding: 20px; border-bottom: 1px solid #333; font-size: 20px; font-weight: bold; background: #1a1a1a; display: flex; justify-content: space-between; }
        .settings-body { flex: 1; overflow-y: auto; padding: 20px; }
        
        .setting-group { margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .setting-group h4 { color: var(--primary); margin: 0 0 15px 0; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 15px; }
        .setting-item label { color: #ddd; }
        
        .color-option { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: inline-block; margin: 3px; border: 2px solid transparent; transition: 0.2s; }
        .color-option.active { border-color: white; box-shadow: 0 0 10px var(--primary); }

        .switch { position: relative; display: inline-block; width: 46px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        select.settings-select { padding: 8px; background: #333; border: none; color: white; border-radius: 5px; outline: none; }
        button.btn-action { padding: 8px 15px; background: #333; border: 1px solid #555; color: white; border-radius: 5px; cursor: pointer; font-size: 13px; }

        /* --- ×”×ª×××” ×œ×˜×œ×¤×•×Ÿ --- */
        @media (max-width: 768px) {
            #appScreen { display: flex; flex-direction: column; }
            .sidebar { display: none; } 
            .mobile-settings-icon { display: block; } /* ××¦×™×’ ×›×¤×ª×•×¨ ×”×’×“×¨×•×ª ×‘×˜×œ×¤×•×Ÿ */
            .main-content { flex: 1; width: 100%; padding: 10px; overflow-y: auto; }
            .video-wrapper { position: sticky; top: 0; z-index: 10; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
            
            .chat-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2500; transform: translateY(100%); transition: transform 0.3s; border: none; }
            .chat-panel.open { transform: translateY(0); }
            .mobile-close-chat { display: block; }
            
            /* × ×’×Ÿ ×ª×—×ª×•×Ÿ ×‘×˜×œ×¤×•×Ÿ - ××¡×•×“×¨ */
            .bottom-bar { height: 120px; flex-direction: column; justify-content: space-evenly; padding: 10px; background: rgba(20,20,20,0.95); backdrop-filter: blur(10px); }
            .now-playing { display: none; }
            .player-center { width: 100%; gap: 10px; }
            .controls { margin-bottom: 0; gap: 30px; }
            .player-right { position: absolute; top: 15px; right: 15px; width: auto; }
            .toggle-chat-btn { color: var(--primary); background: rgba(255,255,255,0.1); border-radius: 50%; width: 40px; height: 40px; }
        }

        .toast {
            position: fixed; bottom: 130px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 8px 20px; border-radius: 20px;
            font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 5000;
        }

    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <!-- ×—×œ×•×Ÿ ×”×’×“×¨×•×ª ×¢× ×§ -->
    <div id="settingsModal" onclick="if(event.target === this) toggleSettings()">
        <div class="settings-content">
            <div class="settings-header">
                <span>âš™ï¸ ×”×’×“×¨×•×ª</span>
                <span style="cursor:pointer;" onclick="toggleSettings()">âœ•</span>
            </div>
            <div class="settings-body">
                
                <!-- ×§×‘×•×¦×” 1: ×¤×¨×•×¤×™×œ -->
                <div class="setting-group">
                    <h4>ğŸ‘¤ ××©×ª××©</h4>
                    <div class="setting-item">
                        <label>×©×™× ×•×™ ×©×:</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="newUsernameInput" placeholder="×©× ×—×“×©" style="width:100px; padding:5px; border-radius:5px; background:#333; color:white; border:none;">
                            <button class="btn-action" onclick="updateUsername()">×©××•×¨</button>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label>××¦×‘ ××•×¨×— (×”×¡×ª×¨ ×©×)</label>
                        <label class="switch"><input type="checkbox" id="setIncognito"><span class="slider"></span></label>
                    </div>
                </div>

                <!-- ×§×‘×•×¦×” 2: ××¨××” -->
                <div class="setting-group">
                    <h4>ğŸ¨ ×¢×™×¦×•×‘ ×•××¨××”</h4>
                    <div class="setting-item" style="display:block;">
                        <label style="display:block; margin-bottom:5px;">×¦×‘×¢ × ×•×©×:</label>
                        <div id="colorOptions">
                            <div class="color-option" style="background:#1DB954" onclick="setTheme('#1DB954')"></div>
                            <div class="color-option" style="background:#1E88E5" onclick="setTheme('#1E88E5')"></div>
                            <div class="color-option" style="background:#E91E63" onclick="setTheme('#E91E63')"></div>
                            <div class="color-option" style="background:#9C27B0" onclick="setTheme('#9C27B0')"></div>
                            <div class="color-option" style="background:#FF9800" onclick="setTheme('#FF9800')"></div>
                            <div class="color-option" style="background:#00E5FF" onclick="setTheme('#00E5FF')"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label>××¦×‘ ×‘×”×™×¨ (Light Mode)</label>
                        <label class="switch"><input type="checkbox" id="setLightMode" onchange="toggleLightMode(this.checked)"><span class="slider"></span></label>
                    </div>
                    <div class="setting-item">
                        <label>× ×™×’×•×“×™×•×ª ×’×‘×•×”×”</label>
                        <label class="switch"><input type="checkbox" id="setHighContrast" onchange="toggleHighContrast(this.checked)"><span class="slider"></span></label>
                    </div>
                    <div class="setting-item">
                        <label>×× ×™××¦×™×•×ª ×¨×§×¢ (Glow)</label>
                        <label class="switch"><input type="checkbox" id="setAnim" checked onchange="toggleAnimations(this.checked)"><span class="slider"></span></label>
                    </div>
                    <div class="setting-item">
                        <label>×’×•×“×œ ×’×•×¤×Ÿ</label>
                        <select class="settings-select" onchange="setFontSize(this.value)">
                            <option value="14px">×¨×’×™×œ</option>
                            <option value="16px">×’×“×•×œ</option>
                            <option value="18px">×¢× ×§</option>
                        </select>
                    </div>
                </div>

                <!-- ×§×‘×•×¦×” 3: ×©××¢ ×•× ×’×Ÿ -->
                <div class="setting-group">
                    <h4>ğŸ”Š ×©××¢ ×•× ×’×Ÿ</h4>
                    <div class="setting-item">
                        <label>××¤×§×˜×™× ×§×•×œ×™×™× (×××©×§)</label>
                        <label class="switch"><input type="checkbox" id="setSoundEffects" checked><span class="slider"></span></label>
                    </div>
                    <div class="setting-item">
                        <label>×•×•×œ×™×•× ×‘×¨×™×¨×ª ××—×“×œ</label>
                        <select class="settings-select" id="setDefaultVol">
                            <option value="50">50%</option>
                            <option value="100">100%</option>
                        </select>
                    </div>
                </div>

                <!-- ×§×‘×•×¦×” 4: ×¦'××˜ -->
                <div class="setting-group">
                    <h4>ğŸ’¬ ×¦'××˜</h4>
                    <div class="setting-item">
                        <label>×”×¦×’ ×©×¢×ª ×”×•×“×¢×”</label>
                        <label class="switch"><input type="checkbox" id="setChatTime" onchange="toggleChatTime(this.checked)"><span class="slider"></span></label>
                    </div>
                    <div class="setting-item">
                        <label>×”×¡×ª×¨ ×¨×™××§×¦×™×•×ª (××™××•×’'×™×)</label>
                        <label class="switch"><input type="checkbox" id="setHideEmoji"><span class="slider"></span></label>
                    </div>
                </div>

                <!-- ×§×‘×•×¦×” 5: ××¢×¨×›×ª -->
                <div class="setting-group">
                    <h4>ğŸ”§ ××¢×¨×›×ª</h4>
                    <div class="setting-item">
                        <label>× ×™×§×•×™ ×”×™×¡×˜×•×¨×™×™×ª ×©×™×¨×™×</label>
                        <button class="btn-action" onclick="clearHistory()">× ×§×”</button>
                    </div>
                    <div class="setting-item">
                        <label>××™×¤×•×¡ ×›×œ ×”×”×’×“×¨×•×ª</label>
                        <button class="btn-action" style="color:#ff4444; border-color:#ff4444;" onclick="resetSettings()">××¤×¡</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ×›× ×™×¡×” -->
    <div id="loginScreen">
        <h1 style="color:white; font-size: 38px; margin-bottom: 25px;">You<span style="color:var(--primary)">Sync</span> V27</h1>
        <div class="login-card">
            <input type="text" id="usernameInput" class="auth-input" placeholder="×©× ××©×ª××©">
            <button class="btn-grad" onclick="createRoom()">×¦×•×¨ ×—×“×¨</button>
            <p style="margin: 15px 0; color: #666; font-size: 14px;">××•</p>
            <input type="number" id="roomInput" class="auth-input" placeholder="×§×•×“ ×—×“×¨">
            <button class="btn-grad" style="background: #333; color: white;" onclick="joinRoom()">×”×¦×˜×¨×£</button>
        </div>
    </div>

    <!-- ××¤×œ×™×§×¦×™×” -->
    <div id="appScreen">
        
        <!-- ×›×¤×ª×•×¨ ×”×’×“×¨×•×ª ×œ× ×™×™×“ -->
        <i class="fas fa-cog mobile-settings-icon" onclick="toggleSettings()"></i>

        <!-- ×¡×¨×’×œ ×¦×“ (×¨×§ ×‘××—×©×‘) -->
        <div class="sidebar">
            <div class="brand">You<span>Sync</span></div>
            <button class="nav-btn" onclick="toggleSettings()"><i class="fas fa-cog"></i> ×”×’×“×¨×•×ª</button>
            <div style="font-size:12px; color:#aaa; margin-top:20px; margin-bottom:5px;">××—×•×‘×¨×™× (<span id="userCount">0</span>)</div>
            <div id="usersList" class="user-list-container"></div>
            <div style="margin-top:auto; font-size:12px; color:#555;">×—×“×¨: <span id="roomCodeDisplay"></span></div>
        </div>

        <!-- ×ª×•×›×Ÿ ×¨××©×™ -->
        <div class="main-content">
            <div class="ambiance-glow" id="ambianceGlow"></div>

            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="×—×¤×© ×©×™×¨, ×××Ÿ ××• ××œ×‘×•×...">
                <i class="fas fa-search search-icon"></i>
            </div>

            <div class="video-wrapper">
                <div id="player"></div>
            </div>

            <div class="results-header">
                <h3 style="margin:0;">ğŸ”¥ ×œ×”×™×˜×™× ×—××™×</h3>
                <button onclick="loadHomePage()" style="background:none; border:none; color:var(--primary); cursor:pointer;"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div id="resultsGrid" class="results-grid"></div>
            
            <div style="text-align:center; padding-bottom: 20px;">
                <button class="load-more-btn" onclick="loadMoreVideos()">â¬‡ ×¢×•×“ ×©×™×¨×™×</button>
            </div>
        </div>

        <!-- ×¦'××˜ -->
        <div class="chat-panel" id="chatPanel">
            <div class="chat-header">
                <span>ğŸ’¬ ×¦'××˜</span>
                <button class="mobile-close-chat" onclick="toggleChat()"><i class="fas fa-times"></i></button>
            </div>
            <div id="chatMessages" class="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="×”×•×“×¢×”...">
                <button onclick="sendMessage()" style="background:var(--primary); border:none; border-radius:50%; width:35px; height:35px;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- × ×’×Ÿ ×ª×—×ª×•×Ÿ -->
        <div class="bottom-bar">
            <div class="now-playing">
                <img id="npThumb" src="https://via.placeholder.com/50" class="np-thumb">
                <div class="np-info">
                    <div id="npTitle" style="font-size:13px; font-weight:bold;">×œ× ×× ×’×Ÿ</div>
                    <div id="npArtist" style="font-size:11px; color:#aaa;">YouSync</div>
                </div>
            </div>

            <div class="player-center">
                <div class="controls">
                    <button class="ctrl-btn" onclick="sendReaction('ğŸ”¥')">ğŸ”¥</button>
                    <button class="ctrl-btn play" onclick="togglePlay()"><i class="fas fa-play" id="playIcon"></i></button>
                    <button class="ctrl-btn" onclick="sendReaction('â¤ï¸')">â¤ï¸</button>
                </div>
                <div class="progress-container">
                    <span id="currTime">0:00</span>
                    <input type="range" id="seekBar" value="0" min="0" max="100" step="1" oninput="onSeekInput()" onchange="onSeekChange()">
                    <span id="durTime">0:00</span>
                </div>
            </div>

            <div class="player-right">
                <button class="ctrl-btn toggle-chat-btn" onclick="toggleChat()">
                    <i class="fas fa-comment-alt"></i>
                </button>
                <button class="ctrl-btn" onclick="downloadCurrent()">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>

    </div>

    <script>
        const RAPID_API_KEY = 'efb1ed4f48msh5dfd6650699ded0p1f5775jsn2c2c0eb8bbb3';
        const RAPID_API_HOST = 'youtube-mp36.p.rapidapi.com'; 
        const YOUTUBE_API_KEY = 'AIzaSyAuLutPPSJlZJKkfBrzRNURSibcqkeeA60';

        const firebaseConfig = {
            apiKey: "AIzaSyDKN3qgnvUP4SZX9aOAaThnDI4vUjjVw9A",
            authDomain: "musicsync-58d86.firebaseapp.com",
            projectId: "musicsync-58d86",
            databaseURL: "https://musicsync-58d86-default-rtdb.firebaseio.com"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e){}
        const db = firebase.database();

        let player, isSyncing = false, currentRoom = null, myName = "", myKey = "";
        let isDragging = false, currentVideoId = "", nextPageToken = "";
        let currentSearchQuery = "×œ×”×™×˜×™× ×™×©×¨××œ×™× 2025";

        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('room')) document.getElementById('roomInput').value = params.get('room');
            loadSettings(); // ×˜×¢×™× ×ª ×”×’×“×¨×•×ª
        };

        // --- ×¤×•× ×§×¦×™×•×ª ×”×’×“×¨×•×ª (Logic) ---
        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        function loadSettings() {
            const theme = localStorage.getItem('themeColor');
            if(theme) setTheme(theme);
            
            const light = localStorage.getItem('lightMode') === 'true';
            if(light) toggleLightMode(true);
            document.getElementById('setLightMode').checked = light;

            const highContrast = localStorage.getItem('highContrast') === 'true';
            if(highContrast) toggleHighContrast(true);
            document.getElementById('setHighContrast').checked = highContrast;

            const anim = localStorage.getItem('animations') === 'false' ? false : true; 
            toggleAnimations(anim);
            document.getElementById('setAnim').checked = anim;

            const chatTime = localStorage.getItem('chatTime') === 'true';
            if(chatTime) toggleChatTime(true);
            document.getElementById('setChatTime').checked = chatTime;
        }

        function playClickSound() {
            if(document.getElementById('setSoundEffects').checked) {
                // ×¦×œ×™×œ ×§×œ×™×§ ×¢×“×™×Ÿ (Data URI)
                new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU").play().catch(e=>{});
            }
        }

        // ×”×•×¡×¤×ª ×¦×œ×™×œ ×œ×›×œ ×”×›×¤×ª×•×¨×™×
        document.querySelectorAll('button').forEach(b => b.addEventListener('click', playClickSound));

        function setTheme(color) {
            document.documentElement.style.setProperty('--primary', color);
            const glow = document.getElementById('ambianceGlow');
            if(glow) glow.style.background = `radial-gradient(circle at top, ${color}, transparent 70%)`;
            localStorage.setItem('themeColor', color);
        }

        function toggleLightMode(enable) {
            if(enable) document.body.classList.add('light-mode');
            else document.body.classList.remove('light-mode');
            localStorage.setItem('lightMode', enable);
        }

        function toggleHighContrast(enable) {
            if(enable) document.body.classList.add('high-contrast');
            else document.body.classList.remove('high-contrast');
            localStorage.setItem('highContrast', enable);
        }

        function toggleAnimations(enable) {
            const glow = document.getElementById('ambianceGlow');
            if(glow) glow.style.display = enable ? 'block' : 'none';
            localStorage.setItem('animations', enable);
        }

        function toggleChatTime(enable) {
            if(enable) document.body.classList.add('show-chat-time');
            else document.body.classList.remove('show-chat-time');
            localStorage.setItem('chatTime', enable);
        }

        function setFontSize(size) {
            document.body.style.fontSize = size;
        }

        function clearHistory() {
            showToast("×”×™×¡×˜×•×¨×™×” × ××—×§×”");
        }

        function resetSettings() {
            localStorage.clear();
            location.reload();
        }

        function updateUsername() {
            const newName = document.getElementById('newUsernameInput').value.trim();
            if(newName && myKey) {
                db.ref(`rooms/${currentRoom}/users/${myKey}`).update({ name: newName });
                myName = newName;
                showToast("×©× ×¢×•×“×›×Ÿ!");
                toggleSettings();
            }
        }

        // --- ×©××¨ ×”××¤×œ×™×§×¦×™×” ---
        function toggleChat() {
            const panel = document.getElementById('chatPanel');
            panel.classList.toggle('open');
        }

        function createRoom() {
            myName = document.getElementById('usernameInput').value || "Admin";
            enterRoom(Math.floor(1000 + Math.random() * 9000));
        }
        function joinRoom() {
            myName = document.getElementById('usernameInput').value || "Guest";
            const code = document.getElementById('roomInput').value;
            if(code) enterRoom(code);
        }

        function enterRoom(code) {
            currentRoom = code;
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + code;
            window.history.pushState({path:newUrl},'',newUrl);

            document.getElementById('loginScreen').style.display = 'none';
            const app = document.getElementById('appScreen');
            app.style.display = (window.innerWidth > 768) ? 'grid' : 'flex';
            document.getElementById('roomCodeDisplay').innerText = code;

            loadYoutubePlayer();
            loadHomePage(); 

            const userRef = db.ref(`rooms/${code}/users`).push();
            myKey = userRef.key;
            userRef.set({ name: myName });
            userRef.onDisconnect().remove();

            setupListeners();
        }

        function setupListeners() {
            db.ref(`rooms/${currentRoom}/users`).on('value', snap => {
                const list = document.getElementById('usersList');
                if(list) list.innerHTML = "";
                if(list) {
                    snap.forEach(child => {
                        list.innerHTML += `
                            <div class="user-row">
                                <div style="width:28px;height:28px;background:#333;border-radius:50%;display:flex;align-items:center;justify-content:center;"><i class="fas fa-user"></i></div>
                                <span>${child.val().name}</span>
                            </div>`;
                    });
                }
            });

            db.ref(`rooms/${currentRoom}/current_song`).on('value', snap => {
                const data = snap.val();
                if (!data) return;
                
                document.getElementById('npTitle').innerText = data.title;
                document.getElementById('npThumb').src = data.thumbnail || "https://via.placeholder.com/56";
                document.getElementById('npArtist').innerText = data.channel || "YouSync";
                currentVideoId = data.videoId;

                if (player && player.loadVideoById && player.getVideoData().video_id !== data.videoId) {
                    isSyncing = true;
                    player.loadVideoById(data.videoId);
                    setTimeout(() => isSyncing = false, 1500);
                }

                const icon = document.getElementById('playIcon');
                if (data.status === 1) {
                    icon.className = "fas fa-pause";
                    if (player && player.playVideo && player.getPlayerState() !== 1) player.playVideo();
                } else {
                    icon.className = "fas fa-play";
                    if (player && player.pauseVideo && player.getPlayerState() !== 2) player.pauseVideo();
                }

                if (player && player.getCurrentTime && !isDragging) {
                     const diff = Math.abs(player.getCurrentTime() - (data.timestamp || 0));
                     if (diff > 2 && data.status === 1) {
                         player.seekTo(data.timestamp);
                     }
                }
            });

            db.ref(`rooms/${currentRoom}/chat`).limitToLast(30).on('child_added', snap => {
                const msg = snap.val();
                const div = document.getElementById('chatMessages');
                // ×”×•×¡×¤×ª ×–××Ÿ
                const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                div.innerHTML += `
                    <div class="msg">
                        <strong>${msg.user}</strong>
                        ${msg.text}
                        <span class="chat-timestamp">${time}</span>
                    </div>`;
                div.scrollTop = div.scrollHeight;
            });
            
            db.ref(`rooms/${currentRoom}/reactions`).on('child_added', snap => {
                 if(!document.getElementById('setHideEmoji').checked) {
                     showEmoji(snap.val().emoji);
                 }
                 snap.ref.remove();
            });
        }

        function loadYoutubePlayer() {
            if (typeof YT !== 'undefined' && YT.Player) onYouTubeIframeAPIReady();
            else {
                var tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '', 
                host: 'https://www.youtube-nocookie.com',
                playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0, 'modestbranding': 1, 'playsinline': 1 },
                events: { 
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange 
                }
            });
            setInterval(updateSeekBar, 1000); 
        }

        function onPlayerReady(event) {
            // ×”×—×œ×ª ×•×•×œ×™×•× ×‘×¨×™×¨×ª ××—×“×œ
            const defVol = document.getElementById('setDefaultVol').value;
            player.setVolume(defVol);
        }

        function onPlayerStateChange(event) {
            if (isSyncing || !currentRoom) return;
            if (event.data === 1 || event.data === 2) {
                db.ref(`rooms/${currentRoom}/current_song`).update({ status: event.data });
            }
        }

        function togglePlay() {
            if(!player) return;
            const newStatus = (player.getPlayerState() === 1) ? 2 : 1;
            db.ref(`rooms/${currentRoom}/current_song`).update({ 
                status: newStatus, timestamp: player.getCurrentTime()
            });
        }

        function updateSeekBar() {
            if (!player || !player.getCurrentTime || isDragging) return;
            const curr = player.getCurrentTime();
            const dur = player.getDuration();
            if (dur > 0) {
                document.getElementById('seekBar').value = (curr / dur) * 100;
                document.getElementById('currTime').innerText = formatTime(curr);
                document.getElementById('durTime').innerText = formatTime(dur);
                const val = (curr / dur) * 100;
                document.getElementById('seekBar').style.background = `linear-gradient(to right, var(--primary) 0%, var(--primary) ${val}%, #444 ${val}%, #444 100%)`;
            }
        }

        function onSeekInput() {
            isDragging = true;
            const val = document.getElementById('seekBar').value;
            document.getElementById('currTime').innerText = formatTime((val / 100) * player.getDuration());
        }

        function onSeekChange() {
            isDragging = false;
            const val = document.getElementById('seekBar').value;
            const newTime = (val / 100) * player.getDuration();
            player.seekTo(newTime);
            db.ref(`rooms/${currentRoom}/current_song`).update({ timestamp: newTime, status: 1 });
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0'+sec : sec}`;
        }

        async function loadHomePage() {
            currentSearchQuery = "×œ×”×™×˜×™× ×™×©×¨××œ×™× 2025";
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '<div style="width:100%; text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
            
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=24&q=${encodeURIComponent(currentSearchQuery)}&key=${YOUTUBE_API_KEY}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                nextPageToken = data.nextPageToken || ""; 
                grid.innerHTML = "";
                if(data.items) renderGrid(data.items);
            } catch(e) { console.error(e); }
        }

        async function loadMoreVideos() {
            if(!nextPageToken) return showToast("××™×Ÿ ×¢×•×“ ×ª×•×¦××•×ª");
            const btn = document.querySelector('.load-more-btn');
            btn.innerText = '×˜×•×¢×Ÿ...';
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=24&q=${encodeURIComponent(currentSearchQuery)}&pageToken=${nextPageToken}&key=${YOUTUBE_API_KEY}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                nextPageToken = data.nextPageToken || ""; 
                if(data.items) renderGrid(data.items); 
            } catch(e) { console.error(e); }
            finally { btn.innerText = "â¬‡ ×¢×•×“ ×©×™×¨×™×"; }
        }

        function renderGrid(videos) {
            const grid = document.getElementById('resultsGrid');
            videos.forEach(item => {
                const div = document.createElement('div');
                div.className = 'video-card';
                div.onclick = () => playVideo(item.id.videoId, item.snippet.title, item.snippet.thumbnails.medium.url, item.snippet.channelTitle);
                div.innerHTML = `
                    <img src="${item.snippet.thumbnails.medium.url}" class="card-img">
                    <div class="card-title">${item.snippet.title}</div>
                `;
                grid.appendChild(div);
            });
        }

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadSearchResults(e.target.value);
        });

        async function loadSearchResults(query) {
            currentSearchQuery = query;
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '<div style="width:100%; text-align:center;"><i class="fas fa-spinner fa-spin"></i></div>';
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=24&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                nextPageToken = data.nextPageToken || "";
                grid.innerHTML = "";
                if(data.items) renderGrid(data.items);
            } catch(e) { console.error(e); }
        }

        function playVideo(id, title, thumb, channel) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            db.ref(`rooms/${currentRoom}/current_song`).set({
                videoId: id, title: title, thumbnail: thumb, channel: channel, status: 1, timestamp: 0
            });
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const txt = input.value;
            if(txt) {
                db.ref(`rooms/${currentRoom}/chat`).push({ user: myName, text: txt });
                input.value = "";
            }
        }

        function sendReaction(emoji) {
            db.ref(`rooms/${currentRoom}/reactions`).push({ emoji: emoji });
        }

        function showEmoji(emoji) {
            const el = document.createElement('div');
            el.innerText = emoji;
            el.style.position = 'fixed';
            el.style.left = Math.random() * 80 + 10 + '%';
            el.style.bottom = '120px';
            el.style.fontSize = '40px';
            el.style.animation = 'floatUp 2s ease-out forwards';
            el.style.zIndex = '9999';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }
        
        const style = document.createElement('style');
        style.innerHTML = `@keyframes floatUp { 0% { opacity: 0; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-250px); } }`;
        document.head.appendChild(style);

        function showToast(text) {
            const t = document.getElementById('toast');
            t.innerText = text; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }

        async function downloadCurrent() {
            if(!currentVideoId) return showToast("××™×Ÿ ×©×™×¨ ×× ×’×Ÿ");
            const btn = document.querySelector('.fa-download').parentElement;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const url = `https://${RAPID_API_HOST}/dl?id=${currentVideoId}`;
            const options = { method: 'GET', headers: { 'X-RapidAPI-Key': RAPID_API_KEY, 'X-RapidAPI-Host': RAPID_API_HOST } };
            
            try {
                const res = await fetch(url, options);
                const data = await res.json();
                if(data.link) window.location.href = data.link;
                else if(data.url) window.location.href = data.url;
                else throw new Error("API Limit");
            } catch(e) {
                if(confirm("×©×¨×ª ×”×”×•×¨×“×•×ª ×¢××•×¡. ×œ×¢×‘×•×¨ ×œ×”×•×¨×“×” ×™×“× ×™×ª?")) {
                    window.open(`https://tomp3.cc/youtube-downloader/${currentVideoId}`, '_blank');
                }
            } finally {
                btn.innerHTML = originalHTML;
            }
        }
    </script>
</body>
</html>
