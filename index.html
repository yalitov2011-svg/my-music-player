<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO -->
    <title>YouSync Pro - ×—×•×•×™×ª ××•×–×™×§×” ××ª×§×“××ª</title>
    <meta name="theme-color" content="#000000">
    <meta name="description" content="× ×’×Ÿ ××•×–×™×§×” ×—×‘×¨×ª×™ ××ª×§×“×. ×”××–×Ÿ, ×©×ª×£ ×•×“×‘×¨ ×¢× ×—×‘×¨×™× ×‘×–××Ÿ ×××ª.">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- ××™×™×§×•× ×™× -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #1DB954; /* ×¦×‘×¢ ×“×™× ××™ */
            --dark: #090909;
            --panel: #121212;
            --border: #282828;
            --glass: rgba(255, 255, 255, 0.08);
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body { 
            background-color: var(--dark);
            color: white; 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            margin: 0; padding: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.5s;
        }

        /* ×’×œ×™×œ×” ×™×¤×” */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- ××¡×š ×›× ×™×¡×” --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1e1e1e, #000);
            z-index: 2000;
        }
        .login-card {
            background: rgba(30,30,30,0.6); backdrop-filter: blur(20px);
            padding: 40px; border-radius: 24px; width: 90%; max-width: 380px; text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        }
        input.auth-input {
            width: 100%; padding: 16px; margin: 12px 0; border-radius: 12px; border: 1px solid #333; 
            background: rgba(0,0,0,0.3); color: white; outline: none; text-align: center; font-size: 16px;
            transition: 0.3s;
        }
        input.auth-input:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); }
        
        .btn-grad {
            background: linear-gradient(135deg, var(--primary), #1aa34a); 
            border: none; color: black; font-weight: 700; padding: 16px; width: 100%; border-radius: 12px;
            cursor: pointer; font-size: 16px; margin-top: 15px; box-shadow: 0 4px 15px rgba(29, 185, 84, 0.3);
            transition: 0.2s;
        }
        .btn-grad:active { transform: scale(0.98); }

        /* --- ××¤×œ×™×§×¦×™×” --- */
        #appScreen {
            display: none;
            flex: 1;
            display: grid;
            grid-template-columns: 260px 1fr 340px;
            grid-template-rows: 1fr 90px;
            height: 100%;
            overflow: hidden;
        }

        body.chat-hidden #appScreen { grid-template-columns: 260px 1fr 0px; }

        /* --- ×¦×“ ×™××™×Ÿ (×ª×¤×¨×™×˜) --- */
        .sidebar {
            background: #000; border-left: 1px solid var(--border);
            padding: 20px; display: flex; flex-direction: column; gap: 20px;
        }
        .brand { font-size: 22px; font-weight: 800; display: flex; align-items: center; gap: 10px; color: white; }
        .brand span { color: var(--primary); }
        
        .nav-btn {
            background: transparent; border: none; color: #b3b3b3; text-align: right; font-size: 15px;
            padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-radius: 8px;
            font-weight: 600; transition: 0.2s;
        }
        .nav-btn:hover, .nav-btn.active { background: #282828; color: white; }
        .nav-btn.active { color: var(--primary); }

        .user-list-container { flex: 1; overflow-y: auto; }
        .user-row {
            display: flex; align-items: center; gap: 10px; padding: 8px; 
            font-size: 14px; color: #ddd; border-radius: 6px;
        }
        .user-row:hover { background: #1a1a1a; }
        .avatar-circle {
            width: 28px; height: 28px; background: #333; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--primary);
        }

        /* --- ××¨×›×– (×ª×•×›×Ÿ) --- */
        .main-content {
            background: linear-gradient(180deg, #1a1a1a 0%, var(--panel) 40%);
            position: relative; overflow-y: auto; padding: 30px;
            display: flex; flex-direction: column; align-items: center;
        }

        /* ××¤×§×˜ ×–×•×”×¨ ×œ×¨×§×¢ ×”× ×’×Ÿ */
        .ambiance-glow {
            position: absolute; top: 0; left: 0; width: 100%; height: 300px;
            background: radial-gradient(circle at top, var(--primary), transparent 70%);
            opacity: 0.15; pointer-events: none; transition: opacity 1s, background 1s;
        }

        .search-container {
            width: 100%; max-width: 600px; margin-bottom: 30px; position: relative; z-index: 10;
        }
        .search-input {
            width: 100%; padding: 14px 45px 14px 20px; background: #2a2a2a; border: 1px solid transparent; 
            border-radius: 50px; color: white; outline: none; font-size: 15px; transition: 0.2s;
        }
        .search-input:focus { background: #333; border-color: #555; box-shadow: 0 0 0 2px rgba(255,255,255,0.1); }
        .search-icon { position: absolute; right: 20px; top: 15px; color: #888; }

        .video-wrapper {
            width: 100%; max-width: 800px; aspect-ratio: 16/9;
            background: black; border-radius: 16px; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); z-index: 5;
            position: relative;
        }
        iframe { width: 100%; height: 100%; border: none; }

        .results-header { width: 100%; max-width: 900px; display: flex; justify-content: space-between; margin: 30px 0 15px 0; align-items: center; }
        
        .results-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px;
            width: 100%; max-width: 900px; padding-bottom: 100px;
        }
        .video-card {
            background: #181818; padding: 12px; border-radius: 10px; cursor: pointer; transition: 0.3s;
            border: 1px solid transparent;
        }
        .video-card:hover { background: #282828; transform: translateY(-5px); border-color: #333; }
        .card-img { width: 100%; border-radius: 6px; aspect-ratio: 16/9; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .card-title { font-size: 13px; font-weight: 600; margin-top: 10px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-artist { font-size: 12px; color: #888; margin-top: 4px; }

        /* --- ×¦'××˜ --- */
        .chat-panel {
            background: var(--dark); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body.chat-hidden .chat-panel { width: 0; padding: 0; border: none; }

        .chat-header { padding: 20px; border-bottom: 1px solid var(--border); font-weight: bold; display: flex; justify-content: space-between; background: #050505; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #0a0a0a; }
        .msg { background: #222; padding: 10px 14px; border-radius: 12px; border-bottom-right-radius: 2px; font-size: 13px; align-self: flex-start; max-width: 85%; line-height: 1.4; animation: fadeIn 0.2s; }
        .msg strong { color: var(--primary); font-size: 11px; display: block; margin-bottom: 3px; }
        .chat-input-area { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 8px; background: #050505; }
        
        /* --- × ×’×Ÿ ×ª×—×ª×•×Ÿ --- */
        .bottom-bar {
            grid-column: 1 / -1;
            background: #181818; border-top: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 25px; z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
        }

        .now-playing { display: flex; align-items: center; gap: 15px; width: 25%; }
        .np-thumb { width: 56px; height: 56px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); }
        .np-info div { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }

        .player-center { width: 45%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; }
        
        /* ×¡×œ×™×™×“×¨×™× (×–××Ÿ + ×•×•×œ×™×•×) */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; height: 15px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #4a4a4a; border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 12px; width: 12px; border-radius: 50%; background: white; -webkit-appearance: none; margin-top: -4px; opacity: 0; transition: 0.2s;
        }
        input[type=range]:hover::-webkit-slider-thumb { opacity: 1; transform: scale(1.2); }
        
        .controls { display: flex; gap: 25px; align-items: center; }
        .ctrl-btn { background: none; border: none; color: #b3b3b3; font-size: 18px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .ctrl-btn:hover { color: white; transform: scale(1.1); }
        .ctrl-btn.play { 
            background: white; color: black; border-radius: 50%; width: 35px; height: 35px; font-size: 16px; box-shadow: 0 2px 10px rgba(255,255,255,0.2);
        }
        .ctrl-btn.play:hover { transform: scale(1.05); background: #eee; }

        .player-right { width: 25%; display: flex; justify-content: flex-end; align-items: center; gap: 15px; }
        
        /* ×¡×œ×™×™×“×¨ ×•×•×œ×™×•× */
        .volume-container { display: flex; align-items: center; gap: 8px; width: 100px; }
        .volume-slider { flex: 1; }

        /* --- ×”×ª×××” ×œ×˜×œ×¤×•×Ÿ --- */
        @media (max-width: 768px) {
            #appScreen { grid-template-columns: 1fr; grid-template-rows: 1fr 130px; }
            .sidebar { display: none; }
            .main-content { padding: 15px; height: 60%; }
            .video-wrapper { position: sticky; top: 0; z-index: 20; margin-bottom: 15px; }
            .chat-panel { height: 40%; border-top: 1px solid var(--border); border-right: none; }
            body.chat-hidden .chat-panel { height: 0; }
            .bottom-bar { 
                height: 90px; padding: 10px 15px; flex-direction: column; gap: 10px;
                position: fixed; bottom: 0; left: 0; width: 100%;
                background: rgba(20,20,20,0.98); backdrop-filter: blur(10px);
            }
            .now-playing { width: 100%; justify-content: flex-start; }
            .np-thumb { width: 40px; height: 40px; }
            .player-center { width: 100%; flex-direction: row; justify-content: space-between; }
            .progress-container { position: absolute; bottom: 62px; left: 0; width: 100%; padding: 0 15px; }
            .player-right { position: absolute; top: 15px; right: 15px; width: auto; }
            .volume-container { display: none; } /* × ×¡×ª×™×¨ ×•×•×œ×™×•× ×‘×˜×œ×¤×•×Ÿ */
        }

        /* --- ×—×œ×•×Ÿ ×”×’×“×¨×•×ª --- */
        #settingsModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 3000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #222; padding: 30px; border-radius: 16px; width: 300px; text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .color-option { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: inline-block; margin: 5px; border: 2px solid transparent; }
        .color-option.selected { border-color: white; transform: scale(1.1); }

        .toast {
            position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
            background: rgba(30,30,30,0.9); color: white; padding: 10px 24px; border-radius: 50px;
            font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 5000; font-weight: 600;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <!-- ×—×œ×•×Ÿ ×”×’×“×¨×•×ª -->
    <div id="settingsModal" onclick="if(event.target === this) toggleSettings()">
        <div class="modal-content">
            <h3>ğŸ¨ ×‘×—×¨ ×¦×‘×¢ × ×•×©×</h3>
            <div id="colorOptions">
                <div class="color-option" style="background:#1DB954" onclick="setTheme('#1DB954')"></div>
                <div class="color-option" style="background:#1E88E5" onclick="setTheme('#1E88E5')"></div>
                <div class="color-option" style="background:#E91E63" onclick="setTheme('#E91E63')"></div>
                <div class="color-option" style="background:#9C27B0" onclick="setTheme('#9C27B0')"></div>
                <div class="color-option" style="background:#FF9800" onclick="setTheme('#FF9800')"></div>
                <div class="color-option" style="background:#00E5FF" onclick="setTheme('#00E5FF')"></div>
            </div>
            <button class="btn-grad" style="margin-top:20px; padding:10px;" onclick="toggleSettings()">×¡×’×•×¨</button>
        </div>
    </div>

    <!-- ×›× ×™×¡×” -->
    <div id="loginScreen">
        <h1 style="color:white; font-size: 38px; margin-bottom: 25px; letter-spacing: -1px;">You<span style="color:var(--primary)">Sync</span> Pro</h1>
        <div class="login-card">
            <input type="text" id="usernameInput" class="auth-input" placeholder="×©× ××©×ª××©">
            <button class="btn-grad" onclick="createRoom()">×¦×•×¨ ×—×“×¨</button>
            <p style="margin: 15px 0; color: #666; font-size: 14px;">××•</p>
            <input type="number" id="roomInput" class="auth-input" placeholder="×§×•×“ ×—×“×¨">
            <button class="btn-grad" style="background: #333; color: white;" onclick="joinRoom()">×”×¦×˜×¨×£</button>
        </div>
    </div>

    <!-- ××¤×œ×™×§×¦×™×” -->
    <div id="appScreen" style="display:none;">
        
        <!-- ×¡×¨×’×œ ×¦×“ -->
        <div class="sidebar">
            <div class="brand">You<span>Sync</span></div>
            
            <button class="nav-btn active" onclick="loadHomePage()"><i class="fas fa-home"></i> ×‘×™×ª</button>
            <button class="nav-btn" onclick="toggleSettings()"><i class="fas fa-cog"></i> ×”×’×“×¨×•×ª ×¢×™×¦×•×‘</button>
            
            <div style="flex:1;"></div> <!-- ××¨×•×•×— -->
            
            <div style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: bold; margin-bottom: 10px;">××—×•×‘×¨×™× (<span id="userCount">0</span>)</div>
            <div id="usersList" class="user-list-container"></div>
            
            <div style="font-size: 12px; color: #444; margin-top: 10px;">×—×“×¨: <span id="roomCodeDisplay" style="color:var(--primary)"></span></div>
        </div>

        <div class="main-content">
            <div class="ambiance-glow" id="ambianceGlow"></div>

            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="×—×¤×© ×©×™×¨, ×××Ÿ ××• ××œ×‘×•×...">
                <i class="fas fa-search search-icon"></i>
            </div>

            <div class="video-wrapper">
                <div id="player"></div>
            </div>

            <div class="results-header">
                <h3 style="margin:0;">ğŸ”¥ ×œ×”×™×˜×™× ×—××™×</h3>
                <button onclick="loadHomePage()" style="background:none; border:none; color:var(--primary); cursor:pointer;"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div id="resultsGrid" class="results-grid"></div>
            
            <div class="load-more-container" style="margin-top: 20px; text-align: center;">
                <button class="btn-load-more" onclick="loadMoreVideos()" style="background:#222; color:white; border:1px solid #444; padding:10px 25px; border-radius:20px; cursor:pointer;">â¬‡ ×¢×•×“ ×©×™×¨×™×</button>
            </div>
        </div>

        <div class="chat-panel">
            <div class="chat-header">
                <span>ğŸ’¬ ×¦'××˜ ×§×‘×•×¦×ª×™</span>
            </div>
            <div id="chatMessages" class="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" style="flex:1; background:#222; border:none; color:white; padding:10px; border-radius:20px; outline:none; font-size:14px;" placeholder="×›×ª×•×‘ ×”×•×“×¢×”...">
                <button onclick="sendMessage()" style="background:var(--primary); border:none; border-radius:50%; width:36px; height:36px; color:black; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div class="bottom-bar">
            <div class="now-playing">
                <img id="npThumb" src="https://via.placeholder.com/56" class="np-thumb">
                <div class="np-info">
                    <div id="npTitle" style="font-size:14px; font-weight:bold;">×œ× ×× ×’×Ÿ</div>
                    <div id="npArtist" style="font-size:12px; color:#aaa;">YouSync</div>
                </div>
                <i class="far fa-heart" style="color:#aaa; cursor:pointer; margin-right:10px;" onclick="showToast('â¤ï¸ × ×©××¨')"></i>
            </div>

            <div class="player-center">
                <div class="controls">
                    <button class="ctrl-btn" onclick="sendReaction('ğŸ”¥')"><i class="fas fa-fire"></i></button>
                    <button class="ctrl-btn" onclick="seekRelative(-10)"><i class="fas fa-step-backward"></i></button>
                    <button class="ctrl-btn play" onclick="togglePlay()"><i class="fas fa-play" id="playIcon"></i></button>
                    <button class="ctrl-btn" onclick="seekRelative(10)"><i class="fas fa-step-forward"></i></button>
                    <button class="ctrl-btn" onclick="sendReaction('ğŸ˜‚')"><i class="far fa-laugh"></i></button>
                </div>
                <div class="progress-container" style="width:100%; display:flex; align-items:center; gap:10px; font-size:11px; color:#aaa;">
                    <span id="currTime">0:00</span>
                    <input type="range" id="seekBar" value="0" min="0" max="100" step="1" oninput="onSeekInput()" onchange="onSeekChange()">
                    <span id="durTime">0:00</span>
                </div>
            </div>

            <div class="player-right">
                <div class="volume-container">
                    <i class="fas fa-volume-up" style="font-size:14px; color:#aaa;"></i>
                    <input type="range" class="volume-slider" min="0" max="100" value="100" oninput="setVolume(this.value)">
                </div>
                <div style="width:1px; height:20px; background:#333; margin:0 10px;"></div>
                <button class="ctrl-btn toggle-chat-btn" onclick="toggleChat()" title="×¦'××˜">
                    <i class="fas fa-comment-alt"></i>
                </button>
                <button class="ctrl-btn" onclick="downloadCurrent()" title="×”×•×¨×“×”">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>

    </div>

    <script>
        const RAPID_API_KEY = 'efb1ed4f48msh5dfd6650699ded0p1f5775jsn2c2c0eb8bbb3';
        const RAPID_API_HOST = 'youtube-mp36.p.rapidapi.com'; 
        const YOUTUBE_API_KEY = 'AIzaSyAuLutPPSJlZJKkfBrzRNURSibcqkeeA60';

        const firebaseConfig = {
            apiKey: "AIzaSyDKN3qgnvUP4SZX9aOAaThnDI4vUjjVw9A",
            authDomain: "musicsync-58d86.firebaseapp.com",
            projectId: "musicsync-58d86",
            databaseURL: "https://musicsync-58d86-default-rtdb.firebaseio.com"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e){}
        const db = firebase.database();

        let player, isSyncing = false, currentRoom = null, myName = "", myKey = "";
        let isDragging = false; 
        let currentVideoId = "";
        let nextPageToken = "";
        let currentSearchQuery = "×œ×”×™×˜×™× ×™×©×¨××œ×™× 2025";

        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('room')) document.getElementById('roomInput').value = params.get('room');
            
            // ×˜×¢×™× ×ª ×¦×‘×¢ ×©××•×¨
            const savedTheme = localStorage.getItem('themeColor');
            if(savedTheme) setTheme(savedTheme);
        };

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×™×¦×•×‘ ---
        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        function setTheme(color) {
            document.documentElement.style.setProperty('--primary', color);
            document.querySelector('.ambiance-glow').style.background = `radial-gradient(circle at top, ${color}, transparent 70%)`;
            localStorage.setItem('themeColor', color);
        }

        // --- ××§×œ×“×ª ---
        document.addEventListener('keydown', function(event) {
            if (document.activeElement.tagName === 'INPUT') return;
            const code = event.code;
            if (code === 'Space') { event.preventDefault(); togglePlay(); showToast(player && player.getPlayerState() === 1 ? 'â¸ ×”×•×©×”×”' : 'â–¶ ×× ×’×Ÿ'); }
            else if (code === 'ArrowRight') { event.preventDefault(); seekRelative(10); showToast('â© +10s'); }
            else if (code === 'ArrowLeft') { event.preventDefault(); seekRelative(-10); showToast('âª -10s'); }
            else if (code === 'ArrowUp') { event.preventDefault(); changeVolume(10); }
            else if (code === 'ArrowDown') { event.preventDefault(); changeVolume(-10); }
        });

        // --- ×œ×•×’×™×§×ª ××¤×œ×™×§×¦×™×” ---
        function createRoom() {
            myName = document.getElementById('usernameInput').value || "Admin";
            enterRoom(Math.floor(1000 + Math.random() * 9000));
        }
        function joinRoom() {
            myName = document.getElementById('usernameInput').value || "Guest";
            const code = document.getElementById('roomInput').value;
            if(code) enterRoom(code);
        }

        function enterRoom(code) {
            currentRoom = code;
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + code;
            window.history.pushState({path:newUrl},'',newUrl);

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = (window.innerWidth > 768) ? 'grid' : 'flex';
            document.getElementById('roomCodeDisplay').innerText = code;

            loadYoutubePlayer();
            loadHomePage(); 

            const userRef = db.ref(`rooms/${code}/users`).push();
            myKey = userRef.key;
            userRef.set({ name: myName });
            userRef.onDisconnect().remove();

            setupListeners();
        }

        function setupListeners() {
            db.ref(`rooms/${currentRoom}/users`).on('value', snap => {
                const list = document.getElementById('usersList');
                if(list) list.innerHTML = "";
                if(list) {
                    snap.forEach(child => {
                        list.innerHTML += `
                            <div class="user-row">
                                <div class="avatar-circle"><i class="fas fa-music"></i></div>
                                <span>${child.val().name}</span>
                            </div>`;
                    });
                }
            });

            db.ref(`rooms/${currentRoom}/current_song`).on('value', snap => {
                const data = snap.val();
                if (!data) return;
                
                document.getElementById('npTitle').innerText = data.title;
                document.getElementById('npThumb').src = data.thumbnail || "https://via.placeholder.com/56";
                document.getElementById('npArtist').innerText = data.channel || "YouSync";
                currentVideoId = data.videoId;

                // ×¢×“×›×•×Ÿ Media Session
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: data.title, artist: data.channel || "YouSync",
                        artwork: [{ src: data.thumbnail, sizes: '512x512', type: 'image/png' }]
                    });
                }

                if (player && player.loadVideoById && player.getVideoData().video_id !== data.videoId) {
                    isSyncing = true;
                    player.loadVideoById(data.videoId);
                    setTimeout(() => isSyncing = false, 1500);
                }

                const icon = document.getElementById('playIcon');
                if (data.status === 1) {
                    icon.className = "fas fa-pause";
                    if (player && player.playVideo && player.getPlayerState() !== 1) player.playVideo();
                } else {
                    icon.className = "fas fa-play";
                    if (player && player.pauseVideo && player.getPlayerState() !== 2) player.pauseVideo();
                }

                if (player && player.getCurrentTime && !isDragging) {
                     const diff = Math.abs(player.getCurrentTime() - (data.timestamp || 0));
                     if (diff > 2 && data.status === 1) {
                         player.seekTo(data.timestamp);
                     }
                }
            });

            db.ref(`rooms/${currentRoom}/chat`).limitToLast(30).on('child_added', snap => {
                const msg = snap.val();
                const div = document.getElementById('chatMessages');
                div.innerHTML += `<div class="msg"><strong>${msg.user}</strong>${msg.text}</div>`;
                div.scrollTop = div.scrollHeight;
            });
            
            db.ref(`rooms/${currentRoom}/reactions`).on('child_added', snap => {
                 showEmoji(snap.val().emoji);
                 snap.ref.remove();
            });
        }

        function loadYoutubePlayer() {
            if (typeof YT !== 'undefined' && YT.Player) onYouTubeIframeAPIReady();
            else {
                var tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }
        }

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: '', 
                host: 'https://www.youtube-nocookie.com',
                playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0, 'modestbranding': 1, 'playsinline': 1 },
                events: { 'onStateChange': onPlayerStateChange }
            });
            setInterval(updateSeekBar, 1000); 
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', togglePlay);
                navigator.mediaSession.setActionHandler('pause', togglePlay);
                navigator.mediaSession.setActionHandler('previoustrack', () => seekRelative(-10));
                navigator.mediaSession.setActionHandler('nexttrack', () => seekRelative(10));
            }
        }

        function onPlayerStateChange(event) {
            if (isSyncing || !currentRoom) return;
            if (event.data === 1 || event.data === 2) {
                db.ref(`rooms/${currentRoom}/current_song`).update({ status: event.data });
            }
        }

        function togglePlay() {
            if(!player) return;
            const newStatus = (player.getPlayerState() === 1) ? 2 : 1;
            db.ref(`rooms/${currentRoom}/current_song`).update({ 
                status: newStatus, timestamp: player.getCurrentTime()
            });
        }

        function setVolume(val) {
            if(player) player.setVolume(val);
        }
        
        function changeVolume(amount) {
            if(!player) return;
            const newVol = player.getVolume() + amount;
            player.setVolume(newVol);
            document.querySelector('.volume-slider').value = newVol;
            showToast(`ğŸ”Š ${newVol}%`);
        }

        function seekRelative(seconds) {
            if(!player) return;
            const newTime = player.getCurrentTime() + seconds;
            player.seekTo(newTime);
            db.ref(`rooms/${currentRoom}/current_song`).update({ timestamp: newTime, status: 1 });
        }

        function updateSeekBar() {
            if (!player || !player.getCurrentTime || isDragging) return;
            const curr = player.getCurrentTime();
            const dur = player.getDuration();
            if (dur > 0) {
                document.getElementById('seekBar').value = (curr / dur) * 100;
                document.getElementById('currTime').innerText = formatTime(curr);
                document.getElementById('durTime').innerText = formatTime(dur);
                const val = (curr / dur) * 100;
                document.getElementById('seekBar').style.background = `linear-gradient(to right, var(--primary) 0%, var(--primary) ${val}%, #444 ${val}%, #444 100%)`;
            }
        }

        function onSeekInput() {
            isDragging = true;
            const val = document.getElementById('seekBar').value;
            document.getElementById('currTime').innerText = formatTime((val / 100) * player.getDuration());
        }

        function onSeekChange() {
            isDragging = false;
            const val = document.getElementById('seekBar').value;
            const newTime = (val / 100) * player.getDuration();
            player.seekTo(newTime);
            db.ref(`rooms/${currentRoom}/current_song`).update({ timestamp: newTime, status: 1 });
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0'+sec : sec}`;
        }

        // --- ×—×™×¤×•×© ×•×’×¨×™×“ ---
        async function loadHomePage() {
            currentSearchQuery = "×œ×”×™×˜×™× ×™×©×¨××œ×™× 2025";
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '<div style="width:100%; text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
            
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=24&q=${encodeURIComponent(currentSearchQuery)}&key=${YOUTUBE_API_KEY}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                nextPageToken = data.nextPageToken || ""; 
                grid.innerHTML = "";
                if(data.items) renderGrid(data.items);
            } catch(e) { console.error(e); }
        }

        async function loadMoreVideos() {
            if(!nextPageToken) return showToast("××™×Ÿ ×¢×•×“ ×ª×•×¦××•×ª");
            const btn = document.querySelector('.btn-load-more');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=24&q=${encodeURIComponent(currentSearchQuery)}&pageToken=${nextPageToken}&key=${YOUTUBE_API_KEY}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                nextPageToken = data.nextPageToken || ""; 
                if(data.items) renderGrid(data.items); 
            } catch(e) { console.error(e); }
            finally { btn.innerText = "â¬‡ ×¢×•×“ ×©×™×¨×™×"; }
        }

        function renderGrid(videos) {
            const grid = document.getElementById('resultsGrid');
            videos.forEach(item => {
                const div = document.createElement('div');
                div.className = 'video-card';
                div.onclick = () => playVideo(item.id.videoId, item.snippet.title, item.snippet.thumbnails.medium.url, item.snippet.channelTitle);
                div.innerHTML = `
                    <img src="${item.snippet.thumbnails.medium.url}" class="card-img">
                    <div class="card-title">${item.snippet.title}</div>
                    <div class="card-artist">${item.snippet.channelTitle}</div>
                `;
                grid.appendChild(div);
            });
        }

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadSearchResults(e.target.value);
        });

        async function loadSearchResults(query) {
            currentSearchQuery = query;
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '<div style="width:100%; text-align:center;"><i class="fas fa-spinner fa-spin"></i></div>';
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=24&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                nextPageToken = data.nextPageToken || "";
                grid.innerHTML = "";
                if(data.items) renderGrid(data.items);
            } catch(e) { console.error(e); }
        }

        function playVideo(id, title, thumb, channel) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            db.ref(`rooms/${currentRoom}/current_song`).set({
                videoId: id, title: title, thumbnail: thumb, channel: channel, status: 1, timestamp: 0
            });
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const txt = input.value;
            if(txt) {
                db.ref(`rooms/${currentRoom}/chat`).push({ user: myName, text: txt });
                input.value = "";
            }
        }

        function sendReaction(emoji) {
            db.ref(`rooms/${currentRoom}/reactions`).push({ emoji: emoji });
        }

        function showEmoji(emoji) {
            const el = document.createElement('div');
            el.innerText = emoji;
            el.style.position = 'fixed';
            el.style.left = Math.random() * 80 + 10 + '%';
            el.style.bottom = '100px';
            el.style.fontSize = '40px';
            el.style.animation = 'floatUp 2s ease-out forwards';
            el.style.zIndex = '9999';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }
        
        const style = document.createElement('style');
        style.innerHTML = `@keyframes floatUp { 0% { opacity: 0; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-250px); } }`;
        document.head.appendChild(style);

        function showToast(text) {
            const t = document.getElementById('toast');
            t.innerText = text; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }

        function toggleChat() {
            document.body.classList.toggle('chat-hidden');
        }

        async function downloadCurrent() {
            if(!currentVideoId) return showToast("××™×Ÿ ×©×™×¨ ×× ×’×Ÿ");
            const btn = document.querySelector('.fa-download').parentElement;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const url = `https://${RAPID_API_HOST}/dl?id=${currentVideoId}`;
            const options = { method: 'GET', headers: { 'X-RapidAPI-Key': RAPID_API_KEY, 'X-RapidAPI-Host': RAPID_API_HOST } };
            
            try {
                const res = await fetch(url, options);
                const data = await res.json();
                if(data.link) window.location.href = data.link;
                else if(data.url) window.location.href = data.url;
                else throw new Error("API Limit");
            } catch(e) {
                if(confirm("×©×¨×ª ×”×”×•×¨×“×•×ª ×¢××•×¡. ×œ×¢×‘×•×¨ ×œ×”×•×¨×“×” ×™×“× ×™×ª?")) {
                    window.open(`https://tomp3.cc/youtube-downloader/${currentVideoId}`, '_blank');
                }
            } finally {
                btn.innerHTML = originalHTML;
            }
        }
    </script>
</body>
</html>
